<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Bad Trip Guide ‚Äî PLURderapolis</title>
<meta name="description" content="A safe space for grounding during difficult psychedelic experiences">
<meta name="theme-color" content="#1c0028">
<link rel="manifest" href="manifest.json">
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&family=Roboto:wght@300;400;500&display=swap" rel="stylesheet">
<style>
  /* Base theme */
  :root{
    --bg:#1c0028;
    --card:#2a0040;
    --accent:#ff6ec7;
    --mint:#00f7e0;
    --text:#eee;
    --soft-purple:#3a0055;
    --light-purple:#4a0066;
  }
  
  * {
    box-sizing: border-box;
  }
  
  html,body{
    height:100%;
    scroll-behavior: smooth;
  }
  
  body{
    margin:0; 
    padding:0; 
    font-family:'Roboto',sans-serif;
    background:var(--bg); 
    color:var(--text); 
    -webkit-font-smoothing:antialiased;
    line-height:1.6;
    overflow-x: hidden;
    background: radial-gradient(ellipse at top, #2a0040 0%, #1c0028 100%);
  }
  
  h1,h2,h3{
    font-family:'Montserrat',sans-serif; 
    margin:0;
  }
  
  h1{
    font-size:1.8rem; 
    color:var(--mint); 
    text-shadow:0 0 8px #00f7e0aa;
    font-weight:700;
    margin-bottom:1rem;
  }
  
  h2{
    font-size:1.3rem;
    color:var(--text);
    font-weight:600;
    padding:1rem;
    border-radius:12px;
    background:var(--soft-purple);
    margin:0.5rem 0;
    cursor:pointer;
    transition:all 0.3s ease;
    position:relative;
    display:flex;
    align-items:center;
    box-shadow:0 4px 6px rgba(0,0,0,0.1);
  }
  
  h2:after {
    content: '+';
    position:absolute;
    right:1rem;
    font-size:1.5rem;
    transition:transform 0.3s ease;
  }
  
  h2.open:after {
    transform:rotate(45deg);
  }
  
  h2:hover{
    background:var(--light-purple);
    transform:translateY(-2px);
  }
  
  main{
    max-width:780px; 
    margin:0 auto;
    padding:1rem;
  }
  
  /* Landing page */
  #landing {
    text-align: center;
    padding: 2rem 1rem;
    display:flex;
    flex-direction:column;
    justify-content:center;
    min-height:100vh;
    background: radial-gradient(ellipse at center, rgba(42,0,64,0.4) 0%, rgba(28,0,40,0) 70%);
  }
  
  .landing-icon {
    font-size:4rem;
    margin-bottom:1rem;
    filter: drop-shadow(0 0 10px rgba(0,247,224,0.5));
  }
  
  .landing-message {
    font-size: 1.3rem;
    margin-bottom: 2rem;
    font-weight: 500;
    color: var(--mint);
    line-height:1.5;
  }
  
  .landing-buttons {
    display: flex;
    flex-direction: column;
    gap: 1rem;
    max-width: 300px;
    margin: 0 auto;
  }
  
  .landing-btn {
    background: var(--mint);
    color: #111;
    font-family: 'Montserrat', sans-serif;
    font-weight: 600;
    border: none;
    border-radius: 50px;
    padding: 1rem 1.5rem;
    cursor: pointer;
    box-shadow: 0 4px 8px rgba(0,247,224,0.3);
    font-size: 1.1rem;
    transition: all 0.3s ease;
  }
  
  .landing-btn:hover {
    background: #00d6c7;
    transform: translateY(-3px);
    box-shadow: 0 6px 12px rgba(0,247,224,0.4);
  }
  
  .landing-btn.secondary {
    background: var(--accent);
    box-shadow: 0 4px 8px rgba(255,110,199,0.3);
  }
  
  .landing-btn.secondary:hover {
    background: #ff49b2;
    transform: translateY(-3px);
    box-shadow: 0 6px 12px rgba(255,110,199,0.4);
  }
  
  /* Main Guide Content */
  #guideContent {
    display:none;
    animation: fadeIn 0.5s ease;
  }
  
  @keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
  }
  
  /* Collapsible */
  .collapsible-content{
    display:none; 
    padding:1.5rem; 
    margin:.5rem 0 1.2rem; 
    background:var(--card); 
    border-radius:12px; 
    box-shadow:0 4px 12px rgba(0,0,0,0.2);
    animation: slideDown 0.3s ease;
  }
  
  @keyframes slideDown {
    from { opacity: 0; transform: translateY(-10px); }
    to { opacity: 1; transform: translateY(0); }
  }
  
  .collapsible-content.open{
    display:block;
  }
  
  /* Controls */
  .top-controls{
    display:flex;
    gap:1rem;
    justify-content:center;
    margin:1.5rem 0;
    flex-wrap:wrap;
  }
  
  .mode-btn{
    background:var(--mint); 
    color:#111; 
    font-family:'Montserrat',sans-serif; 
    font-weight:600;
    border:none;
    border-radius:25px;
    padding:.7rem 1.2rem;
    cursor:pointer;
    box-shadow:0 4px 8px rgba(0,247,224,0.3);
    transition:all 0.3s ease;
  }
  
  .mode-btn:hover{
    background:#00d6c7;
    transform:translateY(-2px);
    box-shadow:0 6px 12px rgba(0,247,224,0.4);
  }
  
  /* progress */
  #progressContainer{
    width:100%;
    background:rgba(255,255,255,0.1);
    border-radius:50px;
    height:10px;
    margin:1.5rem 0;
    overflow:hidden;
  }
  
  #progressBar{
    width:0;
    height:100%;
    background:linear-gradient(90deg, var(--mint), var(--accent));
    border-radius:50px;
    transition:width .6s ease;
  }
  
  /* breathing */
  .breathing-container{
    display:flex;
    flex-direction:column;
    align-items:center;
    gap:1.5rem;
    margin:0 auto;
  }
  
  .breathing-shape{
    width:150px;
    height:150px;
    border-radius:50%;
    background:radial-gradient(circle, var(--accent) 0%, var(--soft-purple) 70%);
    box-shadow:0 0 30px rgba(255,110,199,0.6);
    animation:breathe 8s infinite ease-in-out;
    display:flex;
    align-items:center;
    justify-content:center;
    color:#fff;
    font-weight:700;
    font-size:1.2rem;
  }
  
  @keyframes breathe{
    0%{transform:scale(1); opacity:0.7}
    40%{transform:scale(1.4); opacity:1}
    60%{transform:scale(1.4); opacity:1}
    100%{transform:scale(1); opacity:0.7}
  }
  
  .breathing-controls {
    display: flex;
    gap: 1rem;
    justify-content: center;
    margin-top: 1rem;
  }
  
  /* grounding */
  .ground-list{
    list-style:disc;
    padding-left:1.1rem;
  }
  
  .ground-grid{
    display:grid;
    grid-template-columns:1fr;
    gap:.8rem;
  }
  
  .ground-btn{
    background:var(--mint); 
    color:#111; 
    padding:.8rem 1rem; 
    border-radius:20px; 
    border:none; 
    cursor:pointer; 
    font-weight:600;
    box-shadow:0 4px 8px rgba(0,247,224,0.3);
    transition:all 0.3s ease;
    text-align:left;
    display:flex;
    align-items:center;
    gap:0.5rem;
  }
  
  .ground-btn:before {
    content: '';
    display:inline-block;
    width:20px;
    height:20px;
    border-radius:50%;
    background:rgba(255,255,255,0.3);
    flex-shrink:0;
  }
  
  .ground-btn.done{
    background:#444;
    color:#ccc;
    text-decoration:line-through;
    box-shadow:none;
    cursor:default;
  }
  
  .ground-btn.done:before {
    content: '‚úì';
    background:var(--mint);
    color:#111;
    display:flex;
    align-items:center;
    justify-content:center;
    font-size:0.8rem;
    font-weight:bold;
  }
  
  .grounding-alternative {
    margin-top: 1.5rem;
    padding-top: 1.5rem;
    border-top: 1px solid rgba(255,255,255,0.1);
  }
  
  /* sounds */
  .audio-controls{
    display:grid;
    grid-template-columns:1fr 1fr;
    gap:.8rem;
    margin-top:.5rem;
  }
  
  .audio-btn{
    padding:.7rem .8rem;
    border-radius:20px;
    border:none;
    background:var(--mint);
    color:#112;
    cursor:pointer;
    font-weight:600;
    box-shadow:0 4px 8px rgba(0,247,224,0.3);
    transition:all 0.3s ease;
  }
  
  .audio-btn.playing{
    background:var(--accent); 
    color:#111;
    transform:scale(0.98);
  }
  
  .audio-btn:hover{
    transform:translateY(-2px);
  }
  
  .audio-btn.mute {
    background: #666;
    box-shadow: 0 4px 8px rgba(102,102,102,0.3);
    grid-column: 1 / -1;
    margin-top:0.5rem;
  }
  
  /* mantras */
  .mantra-box{
    display:flex;
    flex-direction:column;
    align-items:center;
    gap:1rem;
  }
  
  .mantra-text{
    font-weight:600;
    color:var(--mint);
    font-size:1.2rem;
    text-align:center;
    padding:1.5rem;
    border-radius:12px;
    background:rgba(255,255,255,0.05);
    cursor:pointer;
    width:100%;
    transition:all 0.3s ease;
    box-shadow:0 4px 8px rgba(0,0,0,0.1);
  }
  
  .mantra-text:hover{
    background:rgba(255,255,255,0.08);
    transform:translateY(-3px);
  }
  
  .mantra-next{
    padding:.7rem 1.5rem;
    border-radius:50px;
    border:none;
    background:var(--accent);
    color:#111;
    font-weight:700;
    box-shadow:0 4px 8px rgba(255,110,199,0.3);
    cursor:pointer;
    transition:all 0.3s ease;
  }
  
  .mantra-next:hover{
    background:#ff49b2;
    transform:translateY(-3px);
    box-shadow:0 6px 12px rgba(255,110,199,0.4);
  }
  
  /* timer */
  .timer-display{
    font-size:3rem;
    font-weight:800;
    color:var(--accent);
    text-align:center;
    margin:1.5rem 0;
    text-shadow:0 0 15px rgba(255,110,199,0.7);
    font-family:'Montserrat', sans-serif;
  }
  
  .timer-controls{
    display:flex;
    gap:.8rem;
    justify-content:center;
    flex-wrap:wrap;
  }
  
  .timer-btn{
    padding:.7rem 1.2rem;
    border-radius:50px;
    border:none;
    background:var(--mint);
    color:#111;
    font-weight:600;
    box-shadow:0 4px 8px rgba(0,247,224,0.3);
    transition:all 0.3s ease;
  }
  
  .timer-btn:hover{
    background:#00d6c7;
    transform:translateY(-2px);
    box-shadow:0 6px 12px rgba(0,247,224,0.4);
  }
  
  .timer-message {
    text-align: center;
    margin-top: 1.5rem;
    font-style: italic;
    color: var(--mint);
    font-size:1.1rem;
  }
  
  /* resources */
  .resource-btn{
    display:block;
    width:100%;
    padding:.8rem 1rem;
    border-radius:20px;
    border:none;
    background:var(--accent);
    color:#111;
    font-weight:700;
    margin:.5rem 0;
    text-align:center;
    text-decoration:none;
    box-shadow:0 4px 8px rgba(255,110,199,0.3);
    transition:all 0.3s ease;
  }
  
  .resource-btn:hover{
    background:#ff49b2;
    transform:translateY(-3px);
    box-shadow:0 6px 12px rgba(255,110,199,0.4);
  }
  
  /* encouraging */
  .encouragement{
    display:none;
    text-align:center;
    font-weight:700;
    color:var(--mint);
    margin:1rem 0;
    padding:1rem;
    background:rgba(0,247,224,0.1);
    border-radius:12px;
    animation:pulse 2s infinite;
  }
  
  @keyframes pulse {
    0% { box-shadow: 0 0 0 0 rgba(0,247,224,0.4); }
    70% { box-shadow: 0 0 0 10px rgba(0,247,224,0); }
    100% { box-shadow: 0 0 0 0 rgba(0,247,224,0); }
  }
  
  /* aftercare */
  .aftercare-prompt {
    margin: 1.5rem 0;
    padding: 1.5rem;
    background: rgba(255,255,255,0.05);
    border-radius: 12px;
  }
  
  textarea {
    width:100%;
    min-height:100px;
    background:rgba(255,255,255,0.1);
    border:1px solid rgba(255,255,255,0.2);
    border-radius:12px;
    color:var(--text);
    padding:1rem;
    font-family:'Roboto', sans-serif;
    font-size:1rem;
    resize:vertical;
    margin-top:0.5rem;
  }
  
  textarea:focus {
    outline:none;
    border-color:var(--mint);
    box-shadow:0 0 0 2px rgba(0,247,224,0.2);
  }
  
  footer{
    color:#aaa;
    text-align:center;
    margin:3rem 0 1rem;
    font-size:.9rem;
    padding:1rem;
  }
  
  /* Floating action button for mobile */
  .fab {
    position: fixed;
    bottom: 1.5rem;
    right: 1.5rem;
    width: 60px;
    height: 60px;
    border-radius: 50%;
    background: var(--accent);
    color: #111;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 4px 12px rgba(255,110,199,0.4);
    cursor: pointer;
    z-index: 100;
    font-size: 1.5rem;
    transition: all 0.3s ease;
  }
  
  .fab:hover {
    transform: scale(1.1);
    box-shadow: 0 6px 16px rgba(255,110,199,0.5);
  }
  
  /* Sensory safe mode */
  .sensory-safe {
    --bg: #0a0014;
    --card: #150020;
    --accent: #cc5aa3;
    --mint: #00c4b3;
    --text: #ddd;
    --soft-purple: #200030;
    --light-purple: #2a003a;
  }
  
  .sensory-safe .breathing-shape {
    animation-duration: 12s;
    box-shadow: 0 0 15px rgba(204,90,163,0.4);
  }
  
  .sensory-safe h2 {
    box-shadow: none;
  }
  
  /* responsive */
  @media (min-width: 520px){
    .ground-grid{
      grid-template-columns:1fr 1fr;
    }
    
    .audio-controls{
      grid-template-columns:1fr 1fr 1fr;
    }
    
    .audio-btn.mute {
      grid-column: auto;
      margin-top:0;
    }
  }
  
  @media (max-width: 520px){
    h1 {
      font-size: 1.5rem;
    }
    
    h2 {
      font-size: 1.1rem;
      padding: 0.8rem 1rem;
    }
    
    .breathing-shape{
      width:120px;
      height:120px;
      font-size:1rem;
    }
    
    .landing-buttons {
      max-width: 100%;
    }
    
    .top-controls {
      flex-direction: column;
      align-items: center;
    }
    
    .mode-btn {
      width: 100%;
      max-width: 250px;
    }
    
    .timer-display {
      font-size: 2.5rem;
    }
  }
  
  /* PWA install prompt */
  .install-prompt {
    position: fixed;
    bottom: 1rem;
    left: 1rem;
    right: 1rem;
    background: var(--card);
    padding: 1rem;
    border-radius: 12px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    z-index: 100;
    display: none;
    animation: slideUp 0.3s ease;
  }
  
  @keyframes slideUp {
    from { transform: translateY(100px); opacity: 0; }
    to { transform: translateY(0); opacity: 1; }
  }
  
  .install-prompt button {
    background: var(--mint);
    color: #111;
    border: none;
    border-radius: 20px;
    padding: 0.5rem 1rem;
    margin-left: 0.5rem;
    cursor: pointer;
    font-weight: 600;
  }
  
  /* Back to top button */
  .back-to-top {
    position: fixed;
    bottom: 1.5rem;
    left: 1.5rem;
    width: 50px;
    height: 50px;
    border-radius: 50%;
    background: var(--mint);
    color: #111;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 4px 12px rgba(0,247,224,0.4);
    cursor: pointer;
    z-index: 99;
    opacity: 0;
    transition: all 0.3s ease;
  }
  
  .back-to-top.visible {
    opacity: 1;
  }
  
  .back-to-top:hover {
    transform: translateY(-3px);
    box-shadow: 0 6px 16px rgba(0,247,224,0.5);
  }
</style>
</head>
<body>
  <main>
    <!-- Landing Page -->
    <section id="landing">
      <div class="landing-icon">üçë</div>
      <h1>Bad Trip Guide ‚Äî PLURderapolis</h1>
      <div class="landing-message">
        <p>You are safe. If you can, take 3 slow breaths now.</p>
        <p>This space is designed to help you through difficult moments.</p>
      </div>
      <div class="landing-buttons">
        <button id="startGuided" class="landing-btn">‚û°Ô∏è Guided Experience</button>
        <button id="startModular" class="landing-btn secondary">üîÄ Choose What I Need</button>
      </div>
    </section>

    <!-- Main Guide Content (initially hidden) -->
    <div id="guideContent">
      <header>
        <h1>üçë Bad Trip Guide ‚Äî PLURderapolis</h1>
        <div class="top-controls" role="toolbar" aria-label="Top controls">
          <button id="toggleSafe" class="mode-btn" aria-pressed="false">üåô Sensory Safe Mode</button>
          <button id="guidedMode" class="mode-btn">‚û°Ô∏è Guided Experience</button>
          <button id="modularMode" class="mode-btn">üîÄ Choose Tools</button>
        </div>
        <div id="progressContainer" aria-hidden="true"><div id="progressBar"></div></div>
      </header>

      <!-- Start Here (intro) -->
      <section class="step-section" data-step="0">
        <h2 tabindex="0" role="button" aria-expanded="false" aria-controls="intro">üåü Start Here</h2>
        <div id="intro" class="collapsible-content" aria-hidden="true">
          <p style="font-weight:600; text-align:center; font-size:1.1rem;">You are safe. This page will walk you through grounding and calming tools ‚Äî either step-by-step or pick what helps.</p>
          <p style="text-align:center">If things feel intense: slow your breath, drink water, and use the emergency links at the bottom.</p>
          <div style="text-align:center; margin-top:1.5rem;">
            <button class="mode-btn" id="startFromHere">Start Here</button>
          </div>
        </div>
      </section>

      <!-- Breathing -->
      <section class="step-section" data-step="1">
        <h2 tabindex="0" role="button" aria-expanded="false" aria-controls="breathing">üí® Breathing Exercise</h2>
        <div id="breathing" class="collapsible-content" aria-hidden="true">
          <div class="breathing-container" aria-hidden="false">
            <div id="breathShape" class="breathing-shape">Breathe</div>
            <div style="text-align:center;font-weight:600;color:var(--mint); font-size:1.1rem;">Breathe with the circle ‚Äî inhale as it expands, exhale as it shrinks. Repeat 5‚Äì7 cycles.</div>
            <div class="breathing-controls">
              <button id="skipBreathing" class="mode-btn">Skip Breathing</button>
            </div>
          </div>
        </div>
      </section>

      <!-- Grounding -->
      <section class="step-section" data-step="2">
        <h2 tabindex="0" role="button" aria-expanded="false" aria-controls="grounding">ü™® Ground Yourself ‚Äî 5-4-3-2-1</h2>
        <div id="grounding" class="collapsible-content" aria-hidden="true">
          <p>Click each item as you name it. When all five are done you'll see a completion message.</p>
          <div class="ground-grid" aria-live="polite">
            <button class="ground-btn" data-count="5">üëÄ Name 5 things you can see</button>
            <button class="ground-btn" data-count="4">‚úã Name 4 things you can touch</button>
            <button class="ground-btn" data-count="3">üëÇ Name 3 things you can hear</button>
            <button class="ground-btn" data-count="2">üëÉ Name 2 things you can smell</button>
            <button class="ground-btn" data-count="1">üëÖ Name 1 thing you can taste</button>
          </div>
          <div class="grounding-alternative">
            <p><strong>Alternative version:</strong> Name 3 things you like, 3 favorite colors, or 3 comforting objects.</p>
            <button id="startAlternative" class="ground-btn">Start Alternative Grounding</button>
          </div>
          <p id="groundingComplete" style="display:none;margin-top:1.5rem;font-weight:900;color:var(--accent);text-align:center; font-size:1.2rem;">‚úÖ Grounding complete ‚Äî you're safe.</p>
        </div>
      </section>

      <!-- Soothing Sounds -->
      <section class="step-section" data-step="3">
        <h2 tabindex="0" role="button" aria-expanded="false" aria-controls="sounds">üé∂ Soothing Sounds</h2>
        <div id="sounds" class="collapsible-content" aria-hidden="true">
          <p style="text-align:center">Tap a sound to toggle play/pause. Only one sound plays at a time. Use Mute All to end every sound.</p>
          <div class="audio-controls" role="group" aria-label="Sound options">
            <button class="audio-btn" data-sound="whiteNoise">White Noise</button>
            <button class="audio-btn" data-sound="ocean">Ocean Waves</button>
            <button class="audio-btn" data-sound="forest">Forest / Birds</button>
            <button class="audio-btn mute" id="stopAll">üîá Mute All</button>
          </div>
        </div>
      </section>

      <!-- Check-In -->
      <section class="step-section" data-step="4">
        <h2 tabindex="0" role="button" aria-expanded="false" aria-controls="checkin">üßç Check-In With Yourself</h2>
        <div id="checkin" class="collapsible-content" aria-hidden="true">
          <ul class="ground-list">
            <li>Am I hydrated? Slowly sip water.</li>
            <li>Can I talk to a trusted friend or sitter? Call or text them.</li>
            <li>Can I sit or lie down safely? Slow deep breaths help.</li>
            <li>Are my clothes comfortable? Remove tight layers if needed.</li>
          </ul>
          <p style="text-align:center;margin-top:1.5rem;font-style:italic">If you cannot do any of these, that's okay ‚Äî move to next.</p>
          <div style="text-align:center;margin-top:1.5rem;">
            <button id="skipCheckin" class="mode-btn">Continue</button>
          </div>
        </div>
      </section>

      <!-- Tripping at Shows -->
      <section class="step-section" data-step="5">
        <h2 tabindex="0" role="button" aria-expanded="false" aria-controls="shows">üéµ Tripping at Shows ‚Äî Stay Safe</h2>
        <div id="shows" class="collapsible-content" aria-hidden="true">
          <ul class="ground-list">
            <li><strong>Hydrate:</strong> sip water slowly and often. Avoid chugging or sugary drinks.</li>
            <li><strong>Eat:</strong> light carbs or fruit help; avoid heavy greasy foods if you're nauseous.</li>
            <li><strong>Environment:</strong> step outside or to a chill zone if overwhelmed ‚Äî quiet spaces help a lot.</li>
            <li><strong>Buddy system:</strong> stay with someone you trust; check in every 10 minutes.</li>
            <li><strong>Avoid:</strong> mixing substances or lots of alcohol; don't push your body (dance breaks are fine).</li>
            <li><strong>Tools:</strong> sunglasses, earplugs, a small bottle of water, and breathing exercises.</li>
          </ul>
        </div>
      </section>

      <!-- Wait / Calm Timer -->
      <section class="step-section" data-step="6">
        <h2 tabindex="0" role="button" aria-expanded="false" aria-controls="wait">‚è≥ Just Wait ‚Äî Calm Timer</h2>
        <div id="wait" class="collapsible-content" aria-hidden="true">
          <p style="text-align:center">Settle in. Panic often drops after 10‚Äì20 minutes. Use the timer below.</p>
          <div id="timerDisplay" class="timer-display" aria-live="polite">15:00</div>
          <div class="timer-controls">
            <button id="startTimer" class="timer-btn">Start</button>
            <button id="pauseTimer" class="timer-btn">Pause</button>
            <button id="resetTimer" class="timer-btn">Reset</button>
          </div>
          <div id="timerMessage" class="timer-message">Many people find things stabilize after ~10-20 min</div>
          <div id="progressMessage" style="display:none;text-align:center;margin-top:1.5rem;color:var(--mint);font-weight:700; font-size:1.1rem;">
            You're doing your part by waiting. This will pass.
          </div>
        </div>
      </section>

      <!-- Mantras -->
      <section class="step-section" data-step="7">
        <h2 tabindex="0" role="button" aria-expanded="false" aria-controls="mantras">üß† Mantras to Remember</h2>
        <div id="mantras" class="collapsible-content" aria-hidden="true">
          <div class="mantra-box">
            <div id="mantraText" class="mantra-text" role="button" tabindex="0" aria-pressed="false">I am safe and this will pass.</div>
            <button id="nextMantra" class="mantra-next">Next Mantra</button>
          </div>
        </div>
      </section>

      <!-- Aftercare / Reflection -->
      <section class="step-section" data-step="8">
        <h2 tabindex="0" role="button" aria-expanded="false" aria-controls="aftercare">üí≠ Aftercare & Reflection</h2>
        <div id="aftercare" class="collapsible-content" aria-hidden="true">
          <div class="aftercare-prompt">
            <p><strong>What helped during this experience?</strong></p>
            <textarea placeholder="Jot down what worked for you..."></textarea>
          </div>
          <div class="aftercare-prompt">
            <p><strong>What would I try next time?</strong></p>
            <textarea placeholder="Note any insights..."></textarea>
          </div>
          <p style="text-align:center">Remember to rest, practice self-care, and reach out to supportive friends.</p>
        </div>
      </section>

      <!-- Emergency / Resources -->
      <section class="step-section" data-step="9">
        <h2 tabindex="0" role="button" aria-expanded="false" aria-controls="backup">üìû Need Backup?</h2>
        <div id="backup" class="collapsible-content" aria-hidden="true">
          <p style="text-align:center">If you need human support right now, these resources are available:</p>
          <a class="resource-btn" href="https://tripsit.me/" target="_blank" rel="noopener">TripSit ‚Äî Live Chat & Resources</a>
          <a class="resource-btn" href="https://firesideproject.org/" target="_blank" rel="noopener">Fireside Project ‚Äî Support Line</a>
          <a class="resource-btn" href="https://neverusealone.com/" target="_blank" rel="noopener">Never Use Alone ‚Äî Phone Check</a>
          <a class="resource-btn" href="/panic.html">üö® Panic Button (your site)</a>
          <a class="resource-btn" href="/emergency.html">üöë Emergency Help (your site)</a>
          <a class="resource-btn" href="index.html">üè† I'm Feeling Better ‚Äî Back Home</a>
        </div>
      </section>

      <p id="encouragement" class="encouragement" role="status" aria-live="polite"></p>
    </div>

    <footer>
      <small>PLURderapolis ‚Ä¢ Your partners in shine üçë</small>
    </footer>
  </main>

  <!-- Floating Action Button -->
  <div class="fab" id="fab" style="display:none">
    üçë
  </div>

  <!-- Back to Top Button -->
  <div class="back-to-top" id="backToTop">
    ‚Üë
  </div>

  <!-- PWA Install Prompt -->
  <div class="install-prompt" id="installPrompt">
    <span>Add to home screen for quick access</span>
    <button id="installBtn">Add</button>
    <button id="dismissInstall">Dismiss</button>
  </div>

<script>
// PWA Manifest
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('/sw.js')
      .then((registration) => {
        console.log('SW registered: ', registration);
      })
      .catch((registrationError) => {
        console.log('SW registration failed: ', registrationError);
      });
  });
}

// Install prompt
let deferredPrompt;
const installPrompt = document.getElementById('installPrompt');
const installBtn = document.getElementById('installBtn');
const dismissInstall = document.getElementById('dismissInstall');

window.addEventListener('beforeinstallprompt', (e) => {
  e.preventDefault();
  deferredPrompt = e;
  installPrompt.style.display = 'block';
});

installBtn.addEventListener('click', () => {
  installPrompt.style.display = 'none';
  deferredPrompt.prompt();
  deferredPrompt.userChoice.then((choiceResult) => {
    deferredPrompt = null;
  });
});

dismissInstall.addEventListener('click', () => {
  installPrompt.style.display = 'none';
});

/* --- Landing Page Logic --- */
const landing = document.getElementById('landing');
const guideContent = document.getElementById('guideContent');
const startGuided = document.getElementById('startGuided');
const startModular = document.getElementById('startModular');
const fab = document.getElementById('fab');

startGuided.addEventListener('click', () => {
  landing.style.display = 'none';
  guideContent.style.display = 'block';
  fab.style.display = 'flex';
  // Start guided mode after a brief delay
  setTimeout(() => {
    document.getElementById('guidedMode').click();
  }, 500);
});

startModular.addEventListener('click', () => {
  landing.style.display = 'none';
  guideContent.style.display = 'block';
  fab.style.display = 'flex';
  // Start modular mode after a brief delay
  setTimeout(() => {
    document.getElementById('modularMode').click();
  }, 500);
});

// FAB functionality
fab.addEventListener('click', () => {
  document.getElementById('backup').scrollIntoView({ behavior: 'smooth' });
});

/* --- Helper & State --- */
const sections = Array.from(document.querySelectorAll('.step-section'));
const progressBar = document.getElementById('progressBar');
const encouragement = document.getElementById('encouragement');
let mantraIndex = 0;
const mantras = [
  "I am safe and this will pass.",
  "This feeling is temporary ‚Äî I can wait.",
  "I can breathe. I can slow down.",
  "I have survived this before. I will again.",
  "Small steps. One breath at a time.",
  "I am not my thoughts. I am the observer.",
  "This too shall pass. Everything changes.",
  "I am exactly where I need to be.",
  "I release what I cannot control.",
  "I am supported by the universe."
];

/* --- Audio Context and Frequency Generators --- */
let audioContext = null;
let currentOscillator = null;
let currentGainNode = null;

function initAudioContext() {
  if (!audioContext) {
    audioContext = new (window.AudioContext || window.webkitAudioContext)();
  }
}

function createFrequencySound(type) {
  // Stop any currently playing sound
  stopAllAudio();
  
  initAudioContext();
  
  // Create oscillator and gain node
  currentOscillator = audioContext.createOscillator();
  currentGainNode = audioContext.createGain();
  
  // Set frequency and type based on the selected sound
  switch(type) {
    case 'whiteNoise':
      // White noise is created with a buffer of random values
      createWhiteNoise();
      return;
    case 'ocean':
      currentOscillator.type = 'sine';
      currentOscillator.frequency.value = 110; // Low frequency for ocean-like sound
      // Add modulation for wave effect
      const lfo = audioContext.createOscillator();
      lfo.frequency.value = 0.2; // Slow modulation for wave effect
      const lfoGain = audioContext.createGain();
      lfoGain.gain.value = 20; // Modulation depth
      lfo.connect(lfoGain);
      lfoGain.connect(currentOscillator.frequency);
      lfo.start();
      break;
    case 'forest':
      currentOscillator.type = 'sine';
      currentOscillator.frequency.value = 500;
      break;
  }
  
  // Set volume
  currentGainNode.gain.value = 0.2;
  
  // Connect and start
  currentOscillator.connect(currentGainNode);
  currentGainNode.connect(audioContext.destination);
  currentOscillator.start();
}

function createWhiteNoise() {
  const bufferSize = 2 * audioContext.sampleRate;
  const noiseBuffer = audioContext.createBuffer(1, bufferSize, audioContext.sampleRate);
  const output = noiseBuffer.getChannelData(0);
  
  for (let i = 0; i < bufferSize; i++) {
    output[i] = Math.random() * 2 - 1;
  }
  
  currentOscillator = audioContext.createBufferSource();
  currentOscillator.buffer = noiseBuffer;
  currentOscillator.loop = true;
  currentGainNode = audioContext.createGain();
  currentGainNode.gain.value = 0.05;
  
  currentOscillator.connect(currentGainNode);
  currentGainNode.connect(audioContext.destination);
  currentOscillator.start();
}

function stopAllAudio() {
  if (currentOscillator) {
    try {
      currentOscillator.stop();
      currentOscillator.disconnect();
    } catch(e) {}
    currentOscillator = null;
  }
  if (currentGainNode) {
    currentGainNode.disconnect();
    currentGainNode = null;
  }
  updateAudioButtons();
}

/* --- Collapsible logic (headers open/close) --- */
document.querySelectorAll('section h2').forEach(header => {
  header.addEventListener('click', () => {
    const id = header.getAttribute('aria-controls');
    const content = document.getElementById(id);
    if (!content) return;
    
    // Close all other sections
    document.querySelectorAll('.collapsible-content').forEach(c => {
      if (c !== content) {
        c.classList.remove('open');
        c.setAttribute('aria-hidden', 'true');
        c.previousElementSibling.classList.remove('open');
        c.previousElementSibling.setAttribute('aria-expanded', 'false');
      }
    });
    
    // Toggle current section
    const opened = content.classList.toggle('open');
    header.classList.toggle('open', opened);
    header.setAttribute('aria-expanded', opened);
    content.setAttribute('aria-hidden', !opened);
    
    updateProgress();
    maybeEncourage();
    
    // Scroll to the opened section
    if (opened) {
      setTimeout(() => {
        header.scrollIntoView({ behavior: 'smooth', block: 'start' });
      }, 300);
    }
  });
  
  header.addEventListener('keypress', (e) => {
    if (e.key === 'Enter' || e.key === ' ') header.click();
  });
});

/* --- Start from here button --- */
document.getElementById('startFromHere').addEventListener('click', () => {
  document.querySelectorAll('.collapsible-content').forEach(c => {
    c.classList.remove('open');
    c.setAttribute('aria-hidden', 'true');
    c.previousElementSibling.classList.remove('open');
    c.previousElementSibling.setAttribute('aria-expanded', 'false');
  });
  
  // Open the first section (Breathing)
  const firstSection = document.querySelector('[data-step="1"]');
  const firstHeader = firstSection.querySelector('h2');
  const firstContent = firstSection.querySelector('.collapsible-content');
  
  firstContent.classList.add('open');
  firstHeader.classList.add('open');
  firstHeader.setAttribute('aria-expanded', 'true');
  firstContent.setAttribute('aria-hidden', 'false');
  
  updateProgress();
  maybeEncourage();
  
  // Scroll to the first section
  setTimeout(() => {
    firstHeader.scrollIntoView({ behavior: 'smooth', block: 'start' });
  }, 300);
});

/* --- Sensory Safe Mode --- */
const safeBtn = document.getElementById('toggleSafe');
safeBtn.addEventListener('click', () => {
  const on = document.body.classList.toggle('sensory-safe');
  safeBtn.setAttribute('aria-pressed', on);
  safeBtn.textContent = on ? 'üåô Sensory Safe Mode (On)' : 'üåô Sensory Safe Mode';
  // stop all audio on safe mode on
  if (on) stopAllAudio();
});

/* --- Guided / Modular Modes --- */
document.getElementById('guidedMode').addEventListener('click', () => {
  // close all first
  document.querySelectorAll('.collapsible-content').forEach(c => { 
    c.classList.remove('open'); 
    c.setAttribute('aria-hidden','true'); 
  });
  document.querySelectorAll('section h2').forEach(h => {
    h.classList.remove('open');
    h.setAttribute('aria-expanded','false');
  });
  
  let i = 0;
  function openStep() {
    if (i >= sections.length) return;
    const sec = sections[i];
    const content = sec.querySelector('.collapsible-content');
    const header = sec.querySelector('h2');
    
    content.classList.add('open');
    content.setAttribute('aria-hidden','false');
    header.classList.add('open');
    header.setAttribute('aria-expanded','true');
    
    updateProgress();
    maybeEncourage();
    
    // Scroll to the current section
    setTimeout(() => {
      header.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }, 300);
    
    i++;
    setTimeout(openStep, 3000); // 3 second pause between steps
  }
  openStep();
});

document.getElementById('modularMode').addEventListener('click', () => {
  document.querySelectorAll('.collapsible-content').forEach(c => { 
    c.classList.remove('open'); 
    c.setAttribute('aria-hidden','true'); 
  });
  document.querySelectorAll('section h2').forEach(h => {
    h.classList.remove('open');
    h.setAttribute('aria-expanded','false');
  });
  updateProgress();
});

/* --- Progress bar --- */
function updateProgress() {
  const total = sections.length;
  const openCount = sections.filter(s => s.querySelector('.collapsible-content').classList.contains('open')).length;
  const pct = Math.round((openCount / total) * 100);
  progressBar.style.width = pct + '%';
}

/* --- Encouragement messages --- */
function maybeEncourage() {
  encouragement.style.display = 'block';
  const msgs = [
    "üåü Keep going ‚Äî you're doing great.",
    "‚úÖ Small steps. You're safe.",
    "üíõ Breathe. You got this.",
    "‚ú® Nice work ‚Äî keep using the tools.",
    "ü™∑ You are exactly where you need to be.",
    "üåä This will pass like a wave.",
    "üïäÔ∏è Peace is available in this moment."
  ];
  encouragement.textContent = msgs[Math.floor(Math.random() * msgs.length)];
  setTimeout(()=> encouragement.style.display = 'none', 4000);
}

/* --- Breathing visuals - only circle remains --- */
const breathShape = document.getElementById('breathShape');
// Set the default to circle
breathShape.className = 'breathing-shape';

// Skip breathing button
document.getElementById('skipBreathing').addEventListener('click', () => {
  document.getElementById('breathing').classList.remove('open');
  document.querySelector('[aria-controls="breathing"]').classList.remove('open');
  document.querySelector('[aria-controls="breathing"]').setAttribute('aria-expanded', 'false');
  updateProgress();
});

/* --- Grounding buttons (interactive) --- */
const groundButtons = document.querySelectorAll('.ground-btn');
const groundingCompleteEl = document.getElementById('groundingComplete');
let groundedCount = 0;
groundButtons.forEach(btn => {
  btn.addEventListener('click', () => {
    if (btn.classList.contains('done')) return;
    btn.classList.add('done');
    groundedCount++;
    // show textual cue
    maybeEncourage();
    if (groundedCount >= groundButtons.length) {
      groundingCompleteEl.style.display = 'block';
      groundingCompleteEl.setAttribute('aria-hidden', 'false');
    }
  });
});

// Alternative grounding
document.getElementById('startAlternative').addEventListener('click', () => {
  const alternatives = [
    "Name 3 things you like",
    "Name 3 favorite colors",
    "Name 3 comforting objects",
    "Name 3 people who care about you",
    "Name 3 places that feel safe",
    "Name 3 songs that calm you",
    "Name 3 things you're grateful for"
  ];
  
  let altIndex = 0;
  const interval = setInterval(() => {
    if (altIndex >= alternatives.length) {
      clearInterval(interval);
      groundingCompleteEl.style.display = 'block';
      groundingCompleteEl.setAttribute('aria-hidden', 'false');
      return;
    }
    
    encouragement.style.display = 'block';
    encouragement.textContent = alternatives[altIndex];
    altIndex++;
    
    setTimeout(() => {
      encouragement.style.display = 'none';
    }, 3000);
  }, 3500);
});

/* --- Audio controls (one plays at a time) --- */
const audioButtons = document.querySelectorAll('.audio-btn');
audioButtons.forEach(btn => {
  btn.addEventListener('click', () => {
    const id = btn.dataset.sound;
    if (id === 'stopAll') { stopAllAudio(); return; }
    
    // Check if this sound is already playing
    if (btn.classList.contains('playing')) {
      stopAllAudio();
    } else {
      // Stop any other playing audio
      stopAllAudio();
      // Start the selected sound
      createFrequencySound(id);
      btn.classList.add('playing');
    }
  });
});

function updateAudioButtons() {
  audioButtons.forEach(b => b.classList.remove('playing'));
}

/* --- Mantra: tap to change & Next button --- */
const mantraText = document.getElementById('mantraText');
const nextMantra = document.getElementById('nextMantra');

function showNextMantra() {
  mantraIndex = (mantraIndex + 1) % mantras.length;
  mantraText.textContent = mantras[mantraIndex];
  // Add a subtle animation
  mantraText.style.transform = 'scale(0.95)';
  setTimeout(() => {
    mantraText.style.transform = 'scale(1)';
  }, 150);
}
nextMantra.addEventListener('click', showNextMantra);
mantraText.addEventListener('click', showNextMantra);
mantraText.addEventListener('keypress', (e) => { if (e.key === 'Enter' || e.key === ' ') showNextMantra(); });

/* --- Skip Check-in --- */
document.getElementById('skipCheckin').addEventListener('click', () => {
  document.getElementById('checkin').classList.remove('open');
  document.querySelector('[aria-controls="checkin"]').classList.remove('open');
  document.querySelector('[aria-controls="checkin"]').setAttribute('aria-expanded', 'false');
  updateProgress();
});

/* --- Timer logic (15 minutes default) --- */
let timer = null;
let timeLeft = 900; // seconds
const timerDisplay = document.getElementById('timerDisplay');
const startBtn = document.getElementById('startTimer');
const pauseBtn = document.getElementById('pauseTimer');
const resetBtn = document.getElementById('resetTimer');
const timerMessage = document.getElementById('timerMessage');
const progressMessage = document.getElementById('progressMessage');

function updateTimerDisplay() {
  const m = String(Math.floor(timeLeft / 60)).padStart(2, '0');
  const s = String(timeLeft % 60).padStart(2, '0');
  timerDisplay.textContent = `${m}:${s}`;
  
  // Update messages based on time left
  if (timeLeft <= 600 && timeLeft > 300) { // 10-5 minutes left
    timerMessage.textContent = "You're halfway there. Keep breathing.";
  } else if (timeLeft <= 300) { // 5 minutes or less
    timerMessage.textContent = "Almost there. This will pass soon.";
    progressMessage.style.display = 'block';
  }
}

startBtn.addEventListener('click', () => {
  if (timer) return; // already running
  timer = setInterval(() => {
    if (timeLeft <= 0) { 
      clearInterval(timer); 
      timer = null; 
      timerMessage.textContent = "Time's up. How are you feeling now?";
      progressMessage.style.display = 'none';
      maybeEncourage(); 
      return; 
    }
    timeLeft--;
    updateTimerDisplay();
  }, 1000);
});

pauseBtn.addEventListener('click', () => {
  if (timer) { clearInterval(timer); timer = null; }
});
resetBtn.addEventListener('click', () => { 
  clearInterval(timer); 
  timer = null; 
  timeLeft = 900; 
  updateTimerDisplay();
  timerMessage.textContent = "Many people find things stabilize after ~10-20 min";
  progressMessage.style.display = 'none';
});

updateTimerDisplay();

/* --- Back to top button --- */
const backToTop = document.getElementById('backToTop');

window.addEventListener('scroll', () => {
  if (window.pageYOffset > 300) {
    backToTop.classList.add('visible');
  } else {
    backToTop.classList.remove('visible');
  }
});

backToTop.addEventListener('click', () => {
  window.scrollTo({ top: 0, behavior: 'smooth' });
});

/* --- Initialize --- */
(function init(){
  // Set default breathing shape
  breathShape.className = 'breathing-shape';
  updateProgress();
})();
</script>

<!-- PWA Service Worker -->
<script>
// Simple service worker for caching
if ('serviceWorker' in navigator) {
  window.addEventListener('load', function() {
    navigator.serviceWorker.register('/sw.js').then(function(registration) {
      console.log('ServiceWorker registration successful');
    }, function(err) {
      console.log('ServiceWorker registration failed: ', err);
    });
  });
}
</script>
</body>
</html>
