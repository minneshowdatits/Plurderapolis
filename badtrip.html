<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Bad Trip Mode ‚Äî PLURderapolis</title>
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@600;700&family=Roboto&display=swap" rel="stylesheet">
<style>
  /* Base theme */
  :root{
    --bg:#1c0028;
    --card:#2a0040;
    --accent:#ff6ec7;
    --mint:#00f7e0;
    --text:#eee;
  }
  html,body{height:100%}
  body{
    margin:0; padding:1rem; font-family:'Roboto',sans-serif;
    background:var(--bg); color:var(--text); -webkit-font-smoothing:antialiased;
  }
  h1,h2{font-family:'Montserrat',sans-serif; text-align:center; margin:1rem 0}
  h1{font-size:2rem; color:var(--accent); text-shadow:0 0 8px #ff6ec7aa;}
  h2{
    background:var(--card); color:var(--mint);
    padding:.8rem; border-radius:8px; cursor:pointer;
    box-shadow:0 0 10px #00f7e055; transition:background .2s;
  }
  h2:hover{background:#3a0055}
  main{max-width:780px; margin:0 auto}
  /* Collapsible */
  .collapsible-content{display:none; padding:1rem; margin:.5rem 0 1.2rem; background:var(--card); border-radius:8px; box-shadow:0 0 15px #00000055}
  .collapsible-content.open{display:block}
  /* Controls */
  .top-controls{display:flex;gap:1rem;justify-content:center;margin:1rem 0;flex-wrap:wrap}
  .mode-btn{
    background:var(--mint); color:#111; font-family:'Montserrat',sans-serif; font-weight:700;
    border:none;border-radius:25px;padding:.6rem 1rem;cursor:pointer;box-shadow:0 0 8px #00f7e0aa;
  }
  .mode-btn:hover{background:#00d6c7}
  /* progress */
  #progressContainer{width:100%;background:#222;border-radius:8px;height:12px;margin:1rem 0}
  #progressBar{width:0;height:100%;background:var(--accent);border-radius:8px;transition:width .4s ease}
  /* breathing */
  .breathing-container{display:flex;flex-direction:column;align-items:center;gap:.75rem;margin:0 auto}
  .breathing-shape{width:120px;height:120px;border-radius:50%;background:radial-gradient(circle,var(--accent)20%,#2a0040 90%);box-shadow:0 0 20px #ff6ec7aa; animation:breathe 8s infinite}
  @keyframes breathe{0%{transform:scale(1);opacity:.75}40%{transform:scale(1.45);opacity:1}60%{transform:scale(1.45);opacity:1}100%{transform:scale(1);opacity:.75}}
  /* grounding */
  .ground-list{list-style:disc;padding-left:1.1rem}
  .ground-grid{display:grid;grid-template-columns:1fr 1fr;gap:.5rem}
  .ground-btn{
    background:var(--mint); color:#111; padding:.6rem .8rem; border-radius:18px; border:none; cursor:pointer; font-weight:700;
    box-shadow:0 0 8px #00f7e0aa;
  }
  .ground-btn.done{background:#444;color:#ccc;text-decoration:line-through;box-shadow:none;cursor:default}
  /* sounds */
  .audio-controls{display:flex;gap:.6rem;flex-wrap:wrap;justify-content:center;margin-top:.5rem}
  .audio-btn{padding:.45rem .9rem;border-radius:20px;border:none;background:var(--mint);color:#112;cursor:pointer;font-weight:700;box-shadow:0 0 8px #00f7e0aa}
  .audio-btn.playing{background:var(--accent); color:#111}
  .audio-btn:hover{opacity:.95}
  /* mantras */
  .mantra-box{display:flex;flex-direction:column;align-items:center;gap:.6rem}
  .mantra-text{font-weight:700;color:var(--mint);font-size:1.05rem;text-align:center;padding:.6rem 1rem;border-radius:12px;background:rgba(255,255,255,0.02);cursor:pointer}
  .mantra-next{padding:.45rem .9rem;border-radius:20px;border:none;background:var(--accent);color:#111;font-weight:800;box-shadow:0 0 8px #ff6ec7aa;cursor:pointer}
  /* timer */
  .timer-display{font-size:2rem;font-weight:800;color:var(--accent);text-align:center;margin:1rem 0;text-shadow:0 0 8px #ff6ec7e0}
  .timer-controls{display:flex;gap:.6rem;justify-content:center;flex-wrap:wrap}
  .timer-btn{padding:.45rem .9rem;border-radius:20px;border:none;background:var(--mint);color:#111;font-weight:700;box-shadow:0 0 8px #00f7e0aa}
  /* resources */
  .resource-btn{display:block;width:100%;padding:.6rem 1rem;border-radius:20px;border:none;background:var(--accent);color:#111;font-weight:800;margin:.4rem 0;text-align:center;text-decoration:none;box-shadow:0 0 8px #ff6ec7aa}
  .resource-btn:hover{background:#ff49b2}
  /* encouraging */
  .encouragement{display:none;text-align:center;font-weight:800;color:var(--mint);margin:.6rem 0}
  footer{color:#aaa;text-align:center;margin:2rem 0 1rem;font-size:.9rem}
  /* responsive */
  @media (max-width:520px){
    .ground-grid{grid-template-columns:1fr}
    .breathing-shape{width:88px;height:88px}
  }
</style>
</head>
<body>
  <main>
    <header>
      <h1>üçë Bad Trip Guide ‚Äî PLURderapolis</h1>
      <div class="top-controls" role="toolbar" aria-label="Top controls">
        <button id="toggleSafe" class="mode-btn" aria-pressed="false">üåô Sensory Safe</button>
        <button id="guidedMode" class="mode-btn">‚û°Ô∏è Guided Start</button>
        <button id="modularMode" class="mode-btn">üîÄ Modular Mode</button>
      </div>
      <div id="progressContainer" aria-hidden="true"><div id="progressBar"></div></div>
    </header>

    <!-- Start Here (intro) -->
    <section class="step-section" data-step="0">
      <h2 tabindex="0" role="button" aria-expanded="false" aria-controls="intro">üåü Start Here</h2>
      <div id="intro" class="collapsible-content" aria-hidden="true">
        <p style="font-weight:700; text-align:center">You are safe. This page will walk you through grounding and calming tools ‚Äî either step-by-step or pick what helps.</p>
        <p style="text-align:center">If things feel intense: slow your breath, drink water, and use the emergency links at the bottom.</p>
      </div>
    </section>

    <!-- Breathing -->
    <section class="step-section" data-step="1">
      <h2 tabindex="0" role="button" aria-expanded="false" aria-controls="breathing">üí® Breathing Exercise</h2>
      <div id="breathing" class="collapsible-content" aria-hidden="true">
        <div class="breathing-container" aria-hidden="false">
          <div id="breathShape" class="breathing-shape" aria-hidden="true"></div>
          <div style="text-align:center;font-weight:700;color:var(--mint)">Breathe with the circle ‚Äî inhale as it expands, exhale as it shrinks.</div>
        </div>
      </div>
    </section>

    <!-- Grounding -->
    <section class="step-section" data-step="2">
      <h2 tabindex="0" role="button" aria-expanded="false" aria-controls="grounding">ü™® Ground Yourself ‚Äî 5-4-3-2-1</h2>
      <div id="grounding" class="collapsible-content" aria-hidden="true">
        <p>Click each item as you name it. When all five are done you'll see a completion message.</p>
        <div class="ground-grid" aria-live="polite">
          <button class="ground-btn" data-count="5">üëÄ Name 5 things you can see</button>
          <button class="ground-btn" data-count="4">‚úã Name 4 things you can touch</button>
          <button class="ground-btn" data-count="3">üëÇ Name 3 things you can hear</button>
          <button class="ground-btn" data-count="2">üëÉ Name 2 things you can smell</button>
          <button class="ground-btn" data-count="1">üëÖ Name 1 thing you can taste</button>
        </div>
        <p id="groundingComplete" style="display:none;margin-top:1rem;font-weight:900;color:var(--accent);text-align:center">‚úÖ Grounding complete ‚Äî you're safe.</p>
      </div>
    </section>

    <!-- Soothing Sounds -->
    <section class="step-section" data-step="3">
      <h2 tabindex="0" role="button" aria-expanded="false" aria-controls="sounds">üé∂ Soothing Sounds</h2>
      <div id="sounds" class="collapsible-content" aria-hidden="true">
        <p style="text-align:center">Tap a sound to toggle play/pause. Only one sound plays at a time. Use Stop All to end every sound.</p>
        <div class="audio-controls" role="group" aria-label="Sound options">
          <button class="audio-btn" data-sound="whiteNoise">White Noise</button>
          <button class="audio-btn" data-sound="ocean">Ocean Waves</button>
          <button class="audio-btn" data-sound="rain">Rain / Thunder</button>
          <button class="audio-btn" data-sound="forest">Forest / Birds</button>
          <button class="audio-btn" id="stopAll">Stop All</button>
        </div>
      </div>
    </section>

    <!-- Mantras -->
    <section class="step-section" data-step="4">
      <h2 tabindex="0" role="button" aria-expanded="false" aria-controls="mantras">üß† Mantras to Remember (tap to change)</h2>
      <div id="mantras" class="collapsible-content" aria-hidden="true">
        <div class="mantra-box">
          <div id="mantraText" class="mantra-text" role="button" tabindex="0" aria-pressed="false">I am safe and this will pass.</div>
          <button id="nextMantra" class="mantra-next">Next Mantra</button>
        </div>
      </div>
    </section>

    <!-- Check-In -->
    <section class="step-section" data-step="5">
      <h2 tabindex="0" role="button" aria-expanded="false" aria-controls="checkin">üßç Check-In With Yourself</h2>
      <div id="checkin" class="collapsible-content" aria-hidden="true">
        <ul>
          <li>Am I hydrated? Slowly sip water.</li>
          <li>Can I talk to a trusted friend or sitter? Call or text them.</li>
          <li>Can I sit or lie down safely? Slow deep breaths help.</li>
          <li>Are my clothes comfortable? Remove tight layers if needed.</li>
        </ul>
      </div>
    </section>

    <!-- Wait / Calm Timer -->
    <section class="step-section" data-step="6">
      <h2 tabindex="0" role="button" aria-expanded="false" aria-controls="wait">‚è≥ Just Wait ‚Äî Calm Timer</h2>
      <div id="wait" class="collapsible-content" aria-hidden="true">
        <p style="text-align:center">Settle in. Panic often drops after 10‚Äì20 minutes. Use the timer below.</p>
        <div id="timerDisplay" class="timer-display" aria-live="polite">15:00</div>
        <div class="timer-controls">
          <button id="startTimer" class="timer-btn">Start</button>
          <button id="pauseTimer" class="timer-btn">Pause</button>
          <button id="resetTimer" class="timer-btn">Reset</button>
        </div>
      </div>
    </section>

    <!-- Tripping at Shows -->
    <section class="step-section" data-step="7">
      <h2 tabindex="0" role="button" aria-expanded="false" aria-controls="shows">üéµ Tripping at Shows ‚Äî Stay Safe</h2>
      <div id="shows" class="collapsible-content" aria-hidden="true">
        <ul>
          <li><strong>Hydrate:</strong> sip water slowly and often. Avoid chugging or sugary drinks.</li>
          <li><strong>Eat:</strong> light carbs or fruit help; avoid heavy greasy foods if you're nauseous.</li>
          <li><strong>Environment:</strong> step outside or to a chill zone if overwhelmed ‚Äî quiet spaces help a lot.</li>
          <li><strong>Buddy system:</strong> stay with someone you trust; check in every 10 minutes.</li>
          <li><strong>Avoid:</strong> mixing substances or lots of alcohol; don't push your body (dance breaks are fine).</li>
          <li><strong>Tools:</strong> sunglasses, earplugs, a small bottle of water, and breathing exercises.</li>
        </ul>
      </div>
    </section>

    <!-- Emergency / Resources -->
    <section class="step-section" data-step="8">
      <h2 tabindex="0" role="button" aria-expanded="false" aria-controls="backup">üìû Need Backup?</h2>
      <div id="backup" class="collapsible-content" aria-hidden="true">
        <p style="text-align:center">If you need human support right now, these resources are available:</p>
        <a class="resource-btn" href="https://tripsit.me/" target="_blank" rel="noopener">TripSit ‚Äî Live Chat & Resources</a>
        <a class="resource-btn" href="https://firesideproject.org/" target="_blank" rel="noopener">Fireside Project ‚Äî Support Line</a>
        <a class="resource-btn" href="https://neverusealone.com/" target="_blank" rel="noopener">Never Use Alone ‚Äî Phone Check</a>
        <a class="resource-btn" href="/panic.html">üö® Panic Button (your site)</a>
        <a class="resource-btn" href="/emergency.html">üöë Emergency Help (your site)</a>
        <a class="resource-btn" href="index.html">üè† I'm Feeling Better ‚Äî Back Home</a>
      </div>
    </section>

    <p id="encouragement" class="encouragement" role="status" aria-live="polite"></p>

    <footer>
      <small>PLURderapolis ‚Ä¢ Your partners in shine üçë</small>
    </footer>
  </main>

<script>
/* --- Helper & State --- */
const sections = Array.from(document.querySelectorAll('.step-section'));
const progressBar = document.getElementById('progressBar');
const encouragement = document.getElementById('encouragement');
let mantraIndex = 0;
const mantras = [
  "I am safe and this will pass.",
  "This feeling is temporary ‚Äî I can wait.",
  "I can breathe. I can slow down.",
  "I have survived this before. I will again.",
  "Small steps. One breath at a time."
];

/* --- Audio Context and Frequency Generators --- */
let audioContext = null;
let currentOscillator = null;
let currentGainNode = null;

function initAudioContext() {
  if (!audioContext) {
    audioContext = new (window.AudioContext || window.webkitAudioContext)();
  }
}

function createFrequencySound(type) {
  // Stop any currently playing sound
  stopAllAudio();
  
  initAudioContext();
  
  // Create oscillator and gain node
  currentOscillator = audioContext.createOscillator();
  currentGainNode = audioContext.createGain();
  
  // Set frequency and type based on the selected sound
  switch(type) {
    case 'whiteNoise':
      // White noise is created with a buffer of random values
      createWhiteNoise();
      return;
    case 'ocean':
      currentOscillator.type = 'sine';
      currentOscillator.frequency.value = 110; // Low frequency for ocean-like sound
      // Add modulation for wave effect
      const lfo = audioContext.createOscillator();
      lfo.frequency.value = 0.2; // Slow modulation for wave effect
      const lfoGain = audioContext.createGain();
      lfoGain.gain.value = 20; // Modulation depth
      lfo.connect(lfoGain);
      lfoGain.connect(currentOscillator.frequency);
      lfo.start();
      break;
    case 'rain':
      currentOscillator.type = 'sawtooth';
      currentOscillator.frequency.value = 300;
      break;
    case 'forest':
      currentOscillator.type = 'sine';
      currentOscillator.frequency.value = 500;
      break;
  }
  
  // Set volume
  currentGainNode.gain.value = 0.2;
  
  // Connect and start
  currentOscillator.connect(currentGainNode);
  currentGainNode.connect(audioContext.destination);
  currentOscillator.start();
}

function createWhiteNoise() {
  const bufferSize = 2 * audioContext.sampleRate;
  const noiseBuffer = audioContext.createBuffer(1, bufferSize, audioContext.sampleRate);
  const output = noiseBuffer.getChannelData(0);
  
  for (let i = 0; i < bufferSize; i++) {
    output[i] = Math.random() * 2 - 1;
  }
  
  currentOscillator = audioContext.createBufferSource();
  currentOscillator.buffer = noiseBuffer;
  currentOscillator.loop = true;
  currentGainNode = audioContext.createGain();
  currentGainNode.gain.value = 0.05;
  
  currentOscillator.connect(currentGainNode);
  currentGainNode.connect(audioContext.destination);
  currentOscillator.start();
}

function stopAllAudio() {
  if (currentOscillator) {
    try {
      currentOscillator.stop();
      currentOscillator.disconnect();
    } catch(e) {}
    currentOscillator = null;
  }
  if (currentGainNode) {
    currentGainNode.disconnect();
    currentGainNode = null;
  }
  updateAudioButtons();
}

/* --- Collapsible logic (headers open/close) --- */
document.querySelectorAll('section h2').forEach(header => {
  header.addEventListener('click', () => {
    const id = header.getAttribute('aria-controls');
    const content = document.getElementById(id);
    if (!content) return;
    const opened = content.classList.toggle('open');
    header.setAttribute('aria-expanded', opened);
    content.setAttribute('aria-hidden', !opened);
    updateProgress();
    maybeEncourage();
  });
  header.addEventListener('keypress', (e) => {
    if (e.key === 'Enter' || e.key === ' ') header.click();
  });
});

/* --- Sensory Safe Mode --- */
const safeBtn = document.getElementById('toggleSafe');
safeBtn.addEventListener('click', () => {
  const on = document.body.classList.toggle('safe-mode');
  safeBtn.setAttribute('aria-pressed', on);
  // stop all audio on safe mode on
  if (on) stopAllAudio();
});

/* --- Guided / Modular Modes --- */
document.getElementById('guidedMode').addEventListener('click', () => {
  // close all first
  document.querySelectorAll('.collapsible-content').forEach(c => { c.classList.remove('open'); c.setAttribute('aria-hidden','true'); });
  document.querySelectorAll('section h2').forEach(h=>h.setAttribute('aria-expanded','false'));
  let i = 0;
  function openStep() {
    if (i >= sections.length) return;
    const sec = sections[i];
    const content = sec.querySelector('.collapsible-content');
    content.classList.add('open');
    content.setAttribute('aria-hidden','false');
    sec.querySelector('h2').setAttribute('aria-expanded','true');
    updateProgress();
    maybeEncourage();
    i++;
    setTimeout(openStep, 900); // short pause between steps
  }
  openStep();
});

document.getElementById('modularMode').addEventListener('click', () => {
  document.querySelectorAll('.collapsible-content').forEach(c => { c.classList.remove('open'); c.setAttribute('aria-hidden','true'); });
  document.querySelectorAll('section h2').forEach(h=>h.setAttribute('aria-expanded','false'));
  updateProgress();
});

/* --- Progress bar --- */
function updateProgress() {
  const total = sections.length;
  const openCount = sections.filter(s => s.querySelector('.collapsible-content').classList.contains('open')).length;
  const pct = Math.round((openCount / total) * 100);
  progressBar.style.width = pct + '%';
}

/* --- Encouragement messages --- */
function maybeEncourage() {
  encouragement.style.display = 'block';
  const msgs = [
    "üåü Keep going ‚Äî you're doing great.",
    "‚úÖ Small steps. You're safe.",
    "üíõ Breathe. You got this.",
    "‚ú® Nice work ‚Äî keep using the tools."
  ];
  encouragement.textContent = msgs[Math.floor(Math.random() * msgs.length)];
  setTimeout(()=> encouragement.style.display = 'none', 3200);
}

/* --- Breathing visuals - only circle remains --- */
const breathShape = document.getElementById('breathShape');
// Set the default to circle
breathShape.className = 'breathing-shape';

/* --- Grounding buttons (interactive) --- */
const groundButtons = document.querySelectorAll('.ground-btn');
const groundingCompleteEl = document.getElementById('groundingComplete');
let groundedCount = 0;
groundButtons.forEach(btn => {
  btn.addEventListener('click', () => {
    if (btn.classList.contains('done')) return;
    btn.classList.add('done');
    groundedCount++;
    // show textual cue
    maybeEncourage();
    if (groundedCount >= groundButtons.length) {
      groundingCompleteEl.style.display = 'block';
      groundingCompleteEl.setAttribute('aria-hidden', 'false');
    }
  });
});

/* --- Audio controls (one plays at a time) --- */
const audioButtons = document.querySelectorAll('.audio-btn');
audioButtons.forEach(btn => {
  btn.addEventListener('click', () => {
    const id = btn.dataset.sound;
    if (id === 'stopAll') { stopAllAudio(); return; }
    
    // Check if this sound is already playing
    if (btn.classList.contains('playing')) {
      stopAllAudio();
    } else {
      // Stop any other playing audio
      stopAllAudio();
      // Start the selected sound
      createFrequencySound(id);
      btn.classList.add('playing');
    }
  });
});

function updateAudioButtons() {
  audioButtons.forEach(b => b.classList.remove('playing'));
}

/* --- Mantra: tap to change & Next button --- */
const mantraText = document.getElementById('mantraText');
const nextMantra = document.getElementById('nextMantra');

function showNextMantra() {
  mantraIndex = (mantraIndex + 1) % mantras.length;
  mantraText.textContent = mantras[mantraIndex];
}
nextMantra.addEventListener('click', showNextMantra);
mantraText.addEventListener('click', showNextMantra);
mantraText.addEventListener('keypress', (e) => { if (e.key === 'Enter' || e.key === ' ') showNextMantra(); });

/* --- Timer logic (15 minutes default) --- */
let timer = null;
let timeLeft = 900; // seconds
const timerDisplay = document.getElementById('timerDisplay');
const startBtn = document.getElementById('startTimer');
const pauseBtn = document.getElementById('pauseTimer');
const resetBtn = document.getElementById('resetTimer');

function updateTimerDisplay() {
  const m = String(Math.floor(timeLeft / 60)).padStart(2, '0');
  const s = String(timeLeft % 60).padStart(2, '0');
  timerDisplay.textContent = `${m}:${s}`;
}

startBtn.addEventListener('click', () => {
  if (timer) return; // already running
  timer = setInterval(() => {
    if (timeLeft <= 0) { clearInterval(timer); timer = null; maybeEncourage(); return; }
    timeLeft--;
    updateTimerDisplay();
  }, 1000);
});

pauseBtn.addEventListener('click', () => {
  if (timer) { clearInterval(timer); timer = null; }
});
resetBtn.addEventListener('click', () => { clearInterval(timer); timer = null; timeLeft = 900; updateTimerDisplay(); });

updateTimerDisplay();

/* --- Initialize --- */
(function init(){
  // Set default breathing shape
  breathShape.className = 'breathing-shape';
  updateProgress();
})();
</script>
</body>
</html>
