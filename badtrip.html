<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>PLURderapolis ‚Äî Bad Trip Guide & Emergency Grounding</title>
<meta name="description" content="A safe space for grounding during difficult psychedelic experiences. Mobile-optimized with offline support.">
<meta name="theme-color" content="#1c0028">
<link rel="manifest" href="manifest.json">
<link rel="apple-touch-icon" href="/icon-192.png">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&family=Roboto:wght@300;400;500&display=swap" rel="stylesheet">
<style>
  /* Performance optimizations */
  * {
    -webkit-tap-highlight-color: transparent;
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
  }
  
  /* CSS Variables */
  :root {
    --bg: #1c0028;
    --card: #2a0040;
    --accent: #ff6ec7;
    --mint: #00f7e0;
    --text: #eee;
    --soft-purple: #3a0055;
    --light-purple: #4a0066;
    --safe-bg: #0a0014;
    --transition-fast: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    --transition-medium: all 0.35s cubic-bezier(0.4, 0, 0.2, 1);
    --transition-slow: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
    --transition-bounce: all 0.6s cubic-bezier(0.68, -0.55, 0.265, 1.55);
    --header-height: 70px;
    --safe-area-inset-bottom: env(safe-area-inset-bottom, 0px);
  }
  
  /* Smooth page load */
  @keyframes pageEntrance {
    0% { opacity: 0; transform: translateY(10px); }
    100% { opacity: 1; transform: translateY(0); }
  }
  
  body {
    margin: 0;
    padding: 0;
    font-family: 'Roboto', system-ui, -apple-system, sans-serif;
    background: var(--bg);
    color: var(--text);
    line-height: 1.6;
    overflow-x: hidden;
    background: radial-gradient(ellipse at top, #2a0040 0%, #1c0028 100%);
    animation: pageEntrance 0.8s ease-out;
    min-height: 100vh;
    padding-bottom: var(--safe-area-inset-bottom);
  }
  
  /* Smooth scrolling */
  html {
    scroll-behavior: smooth;
    -webkit-overflow-scrolling: touch;
  }
  
  /* Main container for better mobile optimization */
  .app-container {
    max-width: 800px;
    margin: 0 auto;
    padding: 0 16px;
    position: relative;
    min-height: 100vh;
  }
  
  /* Enhanced Header with navigation */
  .site-header {
    position: sticky;
    top: 0;
    z-index: 1000;
    background: rgba(28, 0, 40, 0.95);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    padding: 12px 0;
    border-bottom: 1px solid rgba(255, 110, 199, 0.1);
  }
  
  .header-content {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 16px;
  }
  
  .logo-link {
    display: flex;
    align-items: center;
    gap: 10px;
    text-decoration: none;
    transition: var(--transition-medium);
  }
  
  .logo-link:hover {
    transform: translateY(-2px);
  }
  
  .logo-icon {
    font-size: 28px;
    filter: drop-shadow(0 0 8px rgba(0, 247, 224, 0.5));
  }
  
  .logo-text {
    font-family: 'Montserrat', sans-serif;
    font-weight: 700;
    color: var(--mint);
    font-size: 1.4rem;
    text-shadow: 0 0 10px rgba(0, 247, 224, 0.3);
  }
  
  .quick-nav {
    display: flex;
    gap: 8px;
  }
  
  .nav-btn {
    background: rgba(255, 110, 199, 0.15);
    border: 1px solid rgba(255, 110, 199, 0.2);
    color: var(--text);
    padding: 8px 12px;
    border-radius: 20px;
    font-size: 0.85rem;
    cursor: pointer;
    transition: var(--transition-fast);
    white-space: nowrap;
  }
  
  .nav-btn:hover {
    background: rgba(255, 110, 199, 0.25);
    transform: translateY(-1px);
  }
  
  /* Enhanced Landing Page */
  #landing {
    min-height: calc(100vh - 120px);
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    text-align: center;
    padding: 40px 20px;
    animation: fadeInUp 1s ease-out 0.3s both;
  }
  
  .landing-icon {
    font-size: 5rem;
    margin-bottom: 24px;
    animation: float 4s ease-in-out infinite, gentlePulse 3s ease-in-out infinite;
    filter: drop-shadow(0 0 15px rgba(0, 247, 224, 0.6));
  }
  
  @keyframes float {
    0%, 100% { transform: translateY(0px) rotate(0deg); }
    50% { transform: translateY(-20px) rotate(5deg); }
  }
  
  @keyframes gentlePulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.8; }
  }
  
  .landing-message {
    font-size: 1.3rem;
    max-width: 600px;
    margin: 0 auto 40px;
    color: var(--mint);
    animation: fadeInUp 1s ease-out 0.5s both;
  }
  
  .landing-buttons {
    display: flex;
    flex-direction: column;
    gap: 16px;
    max-width: 320px;
    width: 100%;
    animation: fadeInUp 1s ease-out 0.7s both;
  }
  
  .landing-btn {
    background: linear-gradient(135deg, var(--mint), #00d6c7);
    color: #111;
    font-family: 'Montserrat', sans-serif;
    font-weight: 600;
    border: none;
    border-radius: 50px;
    padding: 16px 24px;
    cursor: pointer;
    font-size: 1.1rem;
    transition: var(--transition-bounce);
    position: relative;
    overflow: hidden;
    box-shadow: 0 6px 20px rgba(0, 247, 224, 0.3);
  }
  
  .landing-btn::after {
    content: '';
    position: absolute;
    top: 50%;
    left: 50%;
    width: 5px;
    height: 5px;
    background: rgba(255, 255, 255, 0.5);
    opacity: 0;
    border-radius: 100%;
    transform: scale(1, 1) translate(-50%);
    transform-origin: 50% 50%;
  }
  
  .landing-btn:focus:not(:active)::after {
    animation: ripple 1s ease-out;
  }
  
  @keyframes ripple {
    0% { transform: scale(0, 0); opacity: 0.5; }
    100% { transform: scale(40, 40); opacity: 0; }
  }
  
  .landing-btn:hover {
    transform: translateY(-4px) scale(1.05);
    box-shadow: 0 10px 25px rgba(0, 247, 224, 0.4);
  }
  
  .landing-btn.secondary {
    background: linear-gradient(135deg, var(--accent), #ff49b2);
    box-shadow: 0 6px 20px rgba(255, 110, 199, 0.3);
  }
  
  /* Enhanced Main Content */
  #guideContent {
    display: none;
    animation: slideUpFade 0.6s cubic-bezier(0.4, 0, 0.2, 1);
  }
  
  @keyframes slideUpFade {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
  }
  
  /* Enhanced Section Headers */
  .step-section {
    margin-bottom: 16px;
    animation: fadeIn 0.5s ease-out;
  }
  
  @keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
  }
  
  .section-header {
    background: var(--soft-purple);
    border: none;
    border-radius: 16px;
    padding: 18px 20px;
    margin: 0;
    font-family: 'Montserrat', sans-serif;
    font-size: 1.2rem;
    color: var(--text);
    cursor: pointer;
    transition: var(--transition-medium);
    position: relative;
    overflow: hidden;
    display: flex;
    align-items: center;
    gap: 12px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
  }
  
  .section-header::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.05), transparent);
    transform: translateX(-100%);
    transition: transform 0.6s ease;
  }
  
  .section-header:hover::before {
    transform: translateX(100%);
  }
  
  .section-header:hover {
    background: var(--light-purple);
    transform: translateY(-2px);
    box-shadow: 0 6px 16px rgba(0, 0, 0, 0.2);
  }
  
  .section-header:after {
    content: '+';
    margin-left: auto;
    font-size: 1.5rem;
    font-weight: 300;
    transition: var(--transition-medium);
  }
  
  .section-header.open:after {
    transform: rotate(45deg);
  }
  
  /* Enhanced Collapsible Content */
  .collapsible-content {
    display: none;
    padding: 24px;
    margin: 8px 0 24px;
    background: var(--card);
    border-radius: 16px;
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
    animation: contentExpand 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    border: 1px solid rgba(255, 255, 255, 0.05);
  }
  
  @keyframes contentExpand {
    0% { 
      opacity: 0;
      transform: translateY(-10px) scale(0.98);
      max-height: 0;
    }
    100% { 
      opacity: 1;
      transform: translateY(0) scale(1);
      max-height: 2000px;
    }
  }
  
  .collapsible-content.open {
    display: block;
  }
  
  /* Enhanced Controls */
  .controls-row {
    display: flex;
    flex-wrap: wrap;
    gap: 12px;
    justify-content: center;
    margin: 24px 0;
    padding: 16px;
    background: rgba(255, 255, 255, 0.03);
    border-radius: 16px;
    border: 1px solid rgba(255, 255, 255, 0.05);
  }
  
  .control-btn {
    background: linear-gradient(135deg, var(--mint), #00d6c7);
    color: #111;
    border: none;
    border-radius: 25px;
    padding: 12px 20px;
    font-family: 'Montserrat', sans-serif;
    font-weight: 600;
    cursor: pointer;
    transition: var(--transition-bounce);
    flex: 1;
    min-width: 140px;
    box-shadow: 0 4px 12px rgba(0, 247, 224, 0.25);
  }
  
  .control-btn:hover {
    transform: translateY(-3px) scale(1.05);
    box-shadow: 0 8px 20px rgba(0, 247, 224, 0.35);
  }
  
  /* Enhanced Progress Bar */
  .progress-container {
    width: 100%;
    height: 12px;
    background: rgba(255, 255, 255, 0.1);
    border-radius: 6px;
    overflow: hidden;
    margin: 24px 0;
    box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.2);
  }
  
  .progress-bar {
    height: 100%;
    background: linear-gradient(90deg, var(--mint), var(--accent));
    border-radius: 6px;
    transition: width 0.8s cubic-bezier(0.34, 1.56, 0.64, 1);
    position: relative;
    overflow: hidden;
  }
  
  .progress-bar::after {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(
      90deg,
      transparent,
      rgba(255, 255, 255, 0.4),
      transparent
    );
    animation: shimmer 2s infinite;
  }
  
  /* Enhanced Breathing */
  .breathing-container {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 24px;
    padding: 20px;
  }
  
  .breathing-visual {
    width: 180px;
    height: 180px;
    border-radius: 50%;
    background: radial-gradient(circle, var(--accent) 0%, transparent 70%);
    box-shadow: 0 0 50px rgba(255, 110, 199, 0.8);
    animation: breathe 8s infinite cubic-bezier(0.4, 0, 0.2, 1);
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: 700;
    font-size: 1.3rem;
    position: relative;
  }
  
  .breathing-visual::before {
    content: '';
    position: absolute;
    top: -10px;
    left: -10px;
    right: -10px;
    bottom: -10px;
    border-radius: 50%;
    border: 2px solid rgba(0, 247, 224, 0.3);
    animation: pulseRing 8s infinite linear;
  }
  
  @keyframes breathe {
    0% { transform: scale(1); opacity: 0.7; }
    40% { transform: scale(1.5); opacity: 1; }
    60% { transform: scale(1.5); opacity: 1; }
    100% { transform: scale(1); opacity: 0.7; }
  }
  
  @keyframes pulseRing {
    0% { transform: scale(1); opacity: 0.3; }
    50% { transform: scale(1.1); opacity: 0.1; }
    100% { transform: scale(1); opacity: 0.3; }
  }
  
  /* Enhanced Mobile Grounding Grid */
  .grounding-grid {
    display: grid;
    grid-template-columns: 1fr;
    gap: 12px;
    margin: 20px 0;
  }
  
  @media (min-width: 480px) {
    .grounding-grid {
      grid-template-columns: repeat(2, 1fr);
    }
  }
  
  .ground-btn {
    background: linear-gradient(135deg, var(--mint), #00d6c7);
    color: #111;
    border: none;
    border-radius: 16px;
    padding: 16px;
    text-align: left;
    font-weight: 600;
    cursor: pointer;
    transition: var(--transition-medium);
    display: flex;
    align-items: center;
    gap: 12px;
    box-shadow: 0 4px 12px rgba(0, 247, 224, 0.2);
  }
  
  .ground-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 16px rgba(0, 247, 224, 0.3);
  }
  
  .ground-btn.done {
    background: #444;
    color: #999;
    text-decoration: line-through;
    transform: none;
    box-shadow: none;
  }
  
  /* Enhanced Audio Controls */
  .audio-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 12px;
    margin: 20px 0;
  }
  
  @media (min-width: 480px) {
    .audio-grid {
      grid-template-columns: repeat(3, 1fr);
    }
  }
  
  .audio-btn {
    background: linear-gradient(135deg, var(--mint), #00d6c7);
    color: #111;
    border: none;
    border-radius: 16px;
    padding: 16px 12px;
    font-weight: 600;
    cursor: pointer;
    transition: var(--transition-medium);
    box-shadow: 0 4px 12px rgba(0, 247, 224, 0.2);
  }
  
  .audio-btn.playing {
    background: linear-gradient(135deg, var(--accent), #ff49b2);
    animation: pulseGlow 2s infinite;
  }
  
  .audio-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 16px rgba(0, 247, 224, 0.3);
  }
  
  /* Enhanced Timer */
  .timer-display {
    font-size: 4rem;
    font-weight: 800;
    text-align: center;
    margin: 30px 0;
    font-family: 'Montserrat', monospace;
    color: var(--accent);
    text-shadow: 0 0 20px rgba(255, 110, 199, 0.5);
    animation: gentlePulseTimer 3s infinite;
  }
  
  @keyframes gentlePulseTimer {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.9; }
  }
  
  /* Enhanced Cheat Sheet Section */
  .cheat-sheet-container {
    background: linear-gradient(135deg, var(--card), #3a0055);
    border-radius: 16px;
    padding: 24px;
    margin: 24px 0;
    border: 2px solid rgba(0, 247, 224, 0.2);
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
  }
  
  .cheat-sheet-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 20px;
    margin: 20px 0;
  }
  
  .cheat-card {
    background: rgba(0, 0, 0, 0.3);
    border-radius: 12px;
    padding: 20px;
    border: 1px solid rgba(255, 255, 255, 0.1);
    transition: var(--transition-medium);
  }
  
  .cheat-card:hover {
    transform: translateY(-4px);
    border-color: var(--mint);
  }
  
  .download-btn {
    display: inline-flex;
    align-items: center;
    gap: 10px;
    background: linear-gradient(135deg, var(--accent), #ff49b2);
    color: #111;
    padding: 14px 24px;
    border-radius: 50px;
    font-weight: 700;
    text-decoration: none;
    transition: var(--transition-bounce);
    margin-top: 20px;
    box-shadow: 0 6px 20px rgba(255, 110, 199, 0.3);
  }
  
  .download-btn:hover {
    transform: translateY(-4px) scale(1.05);
    box-shadow: 0 10px 25px rgba(255, 110, 199, 0.4);
  }
  
  /* Enhanced Related Links */
  .links-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 16px;
    margin: 24px 0;
  }
  
  .resource-link {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 16px;
    background: var(--card);
    border-radius: 12px;
    text-decoration: none;
    color: var(--text);
    transition: var(--transition-medium);
    border: 1px solid rgba(255, 255, 255, 0.05);
  }
  
  .resource-link:hover {
    transform: translateY(-3px);
    background: var(--light-purple);
    border-color: var(--accent);
  }
  
  .link-icon {
    font-size: 1.5rem;
    flex-shrink: 0;
  }
  
  .link-text h4 {
    margin: 0 0 4px 0;
    color: var(--mint);
  }
  
  .link-text p {
    margin: 0;
    font-size: 0.9rem;
    opacity: 0.8;
  }
  
  /* Enhanced Mobile Bottom Navigation */
  .mobile-nav {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    background: rgba(28, 0, 40, 0.95);
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    border-top: 1px solid rgba(255, 255, 255, 0.1);
    padding: 12px 16px;
    display: none;
    z-index: 1000;
    padding-bottom: calc(12px + env(safe-area-inset-bottom));
  }
  
  .nav-items {
    display: flex;
    justify-content: space-around;
  }
  
  .nav-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 4px;
    background: none;
    border: none;
    color: var(--text);
    padding: 8px;
    border-radius: 12px;
    cursor: pointer;
    transition: var(--transition-fast);
    flex: 1;
    max-width: 80px;
  }
  
  .nav-item:hover {
    background: rgba(255, 255, 255, 0.1);
  }
  
  .nav-icon {
    font-size: 1.4rem;
  }
  
  .nav-label {
    font-size: 0.75rem;
  }
  
  /* Enhanced Offline Indicator */
  .offline-indicator {
    position: fixed;
    top: 80px;
    right: 20px;
    background: var(--accent);
    color: #111;
    padding: 8px 16px;
    border-radius: 20px;
    font-size: 0.85rem;
    font-weight: 600;
    z-index: 1000;
    animation: slideInRight 0.3s ease;
    box-shadow: 0 4px 12px rgba(255, 110, 199, 0.3);
    display: none;
  }
  
  @keyframes slideInRight {
    from { transform: translateX(100%); opacity: 0; }
    to { transform: translateX(0); opacity: 1; }
  }
  
  /* Enhanced Legal Footer */
  .legal-footer {
    margin-top: 60px;
    padding-top: 30px;
    border-top: 1px solid rgba(255, 255, 255, 0.1);
    font-size: 0.85rem;
    color: #aaa;
    text-align: center;
  }
  
  .disclaimer {
    background: rgba(0, 0, 0, 0.3);
    padding: 20px;
    border-radius: 12px;
    margin: 20px 0;
    font-size: 0.8rem;
    line-height: 1.5;
    text-align: left;
  }
  
  /* Enhanced Responsive Design */
  @media (max-width: 768px) {
    .app-container {
      padding: 0 12px;
    }
    
    .header-content {
      flex-direction: column;
      gap: 12px;
    }
    
    .quick-nav {
      width: 100%;
      overflow-x: auto;
      padding-bottom: 8px;
      -webkit-overflow-scrolling: touch;
    }
    
    .nav-btn {
      font-size: 0.8rem;
      padding: 8px 12px;
      flex-shrink: 0;
    }
    
    .controls-row {
      flex-direction: column;
    }
    
    .control-btn {
      min-width: 100%;
    }
    
    .breathing-visual {
      width: 150px;
      height: 150px;
    }
    
    .timer-display {
      font-size: 3rem;
    }
    
    .mobile-nav {
      display: block;
    }
    
    .cheat-sheet-grid {
      grid-template-columns: 1fr;
    }
    
    .links-grid {
      grid-template-columns: 1fr;
    }
  }
  
  @media (max-width: 480px) {
    .landing-icon {
      font-size: 4rem;
    }
    
    .logo-text {
      font-size: 1.2rem;
    }
    
    .section-header {
      padding: 16px;
      font-size: 1.1rem;
    }
    
    .collapsible-content {
      padding: 20px;
    }
  }
  
  /* Touch-friendly improvements */
  button, 
  [role="button"],
  .landing-btn,
  .control-btn,
  .ground-btn,
  .audio-btn {
    min-height: 44px;
    min-width: 44px;
    touch-action: manipulation;
  }
  
  /* Prevent zoom on mobile inputs */
  @media (max-width: 768px) {
    input,
    textarea,
    select {
      font-size: 16px;
    }
  }
  
  /* Smooth scroll for anchor links */
  :target {
    scroll-margin-top: 100px;
  }
  
  /* Loading animation */
  .loading-spinner {
    display: none;
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 50px;
    height: 50px;
    border: 3px solid rgba(0, 247, 224, 0.3);
    border-top: 3px solid var(--mint);
    border-radius: 50%;
    animation: spin 1s linear infinite;
    z-index: 2000;
  }
  
  @keyframes spin {
    0% { transform: translate(-50%, -50%) rotate(0deg); }
    100% { transform: translate(-50%, -50%) rotate(360deg); }
  }
</style>
</head>
<body>
  <!-- Loading Spinner -->
  <div class="loading-spinner" id="loadingSpinner"></div>
  
  <!-- Offline Indicator -->
  <div class="offline-indicator" id="offlineIndicator">üïäÔ∏è Offline Mode Active</div>
  
  <!-- Header -->
  <header class="site-header">
    <div class="app-container">
      <div class="header-content">
        <a href="https://plurderapolis.org" class="logo-link" title="Return to PLURderapolis Home">
          <span class="logo-icon">üçë</span>
          <span class="logo-text">PLURderapolis</span>
        </a>
        <div class="quick-nav">
          <button class="nav-btn" id="quickBreathing">üí® Breathe</button>
          <button class="nav-btn" id="quickGrounding">ü™® Ground</button>
          <button class="nav-btn" id="quickSounds">üé∂ Sounds</button>
          <button class="nav-btn" id="quickEmergency">üÜò Emergency</button>
        </div>
      </div>
    </div>
  </header>

  <!-- Main App Container -->
  <div class="app-container">
    
    <!-- Landing Page -->
    <section id="landing">
      <div class="landing-icon">üçë</div>
      <h1 style="font-size: 2rem; color: var(--mint); margin-bottom: 20px;">Bad Trip Guide</h1>
      <div class="landing-message">
        <p>You are safe. This moment will pass.</p>
        <p>Take 3 slow breaths now. This space is designed to help you through difficult moments with gentle guidance.</p>
      </div>
      <div class="landing-buttons">
        <button id="startGuided" class="landing-btn">‚û°Ô∏è Guided Step-by-Step</button>
        <button id="startModular" class="landing-btn secondary">üîÄ Choose What I Need</button>
        <button id="quickCheatSheet" class="landing-btn" style="background: linear-gradient(135deg, #8a2be2, #6a0dad);">üìã Quick Cheat Sheet</button>
      </div>
      
      <!-- Quick Stats -->
      <div style="margin-top: 40px; font-size: 0.9rem; color: #aaa; animation: fadeInUp 1s ease-out 0.9s both;">
        <p>‚úÖ Works offline ‚Ä¢ üì± Mobile optimized ‚Ä¢ üéµ Soothing sounds ‚Ä¢ ‚è±Ô∏è Guided timer</p>
      </div>
    </section>

    <!-- Main Guide Content -->
    <div id="guideContent">
      
      <!-- Quick Access Controls -->
      <div class="controls-row">
        <button id="toggleSafe" class="control-btn" aria-pressed="false">üåô Sensory Safe Mode</button>
        <button id="guidedMode" class="control-btn">‚û°Ô∏è Guided Experience</button>
        <button id="modularMode" class="control-btn">üîÄ Choose Tools</button>
        <button id="downloadCheatSheet" class="control-btn" style="background: linear-gradient(135deg, #8a2be2, #6a0dad);">üì• Download Cheat Sheet</button>
      </div>
      
      <!-- Progress Bar -->
      <div class="progress-container">
        <div class="progress-bar" id="progressBar"></div>
      </div>

      <!-- Start Here -->
      <section class="step-section" data-step="0">
        <h2 class="section-header" tabindex="0" role="button" aria-expanded="false" aria-controls="intro">
          üåü Start Here ‚Äî You Are Safe
        </h2>
        <div id="intro" class="collapsible-content" aria-hidden="true">
          <p style="font-size: 1.1rem; text-align: center; margin-bottom: 20px;">
            <strong>Remember:</strong> This feeling is temporary. Your body knows how to return to balance.
          </p>
          <ul style="background: rgba(0,0,0,0.2); padding: 20px; border-radius: 12px; margin: 20px 0;">
            <li>üîπ <strong>Breathe slowly</strong> ‚Äî Inhale for 4, hold for 4, exhale for 6</li>
            <li>üîπ <strong>Drink water</strong> ‚Äî Small sips, no gulping</li>
            <li>üîπ <strong>Find a safe spot</strong> ‚Äî Sit or lie down if possible</li>
            <li>üîπ <strong>Use this guide</strong> ‚Äî Step by step or pick what helps</li>
          </ul>
          <div style="text-align: center; margin-top: 24px;">
            <button class="control-btn" id="startFromHere">Start Guided Breathing</button>
          </div>
        </div>
      </section>

      <!-- Breathing Exercise -->
      <section class="step-section" data-step="1">
        <h2 class="section-header" tabindex="0" role="button" aria-expanded="false" aria-controls="breathing">
          üí® Breathing Exercise ‚Äî Calm Your Nervous System
        </h2>
        <div id="breathing" class="collapsible-content" aria-hidden="true">
          <div class="breathing-container">
            <div id="breathShape" class="breathing-visual">
              <span id="breathText">Breathe In</span>
            </div>
            <div style="text-align: center; max-width: 400px;">
              <p style="font-weight: 600; color: var(--mint); font-size: 1.1rem;">
                Follow the circle: Inhale as it grows, exhale as it shrinks
              </p>
              <p style="margin-top: 10px; opacity: 0.9;">
                Complete 5-7 cycles. This activates your parasympathetic nervous system.
              </p>
            </div>
            <div style="display: flex; gap: 12px;">
              <button id="skipBreathing" class="control-btn" style="background: rgba(255,255,255,0.1); color: var(--text);">Skip Breathing</button>
              <button id="breathSlower" class="control-btn">Slower Breathing</button>
              <button id="breathFaster" class="control-btn">Faster Breathing</button>
            </div>
          </div>
        </div>
      </section>

      <!-- Grounding -->
      <section class="step-section" data-step="2">
        <h2 class="section-header" tabindex="0" role="button" aria-expanded="false" aria-controls="grounding">
          ü™® 5-4-3-2-1 Grounding Technique
        </h2>
        <div id="grounding" class="collapsible-content" aria-hidden="true">
          <p style="text-align: center; margin-bottom: 20px;">
            Click each item as you notice it. This brings you back to the present moment.
          </p>
          <div class="grounding-grid" aria-live="polite">
            <button class="ground-btn" data-count="5">üëÄ 5 things you can see</button>
            <button class="ground-btn" data-count="4">‚úã 4 things you can touch</button>
            <button class="ground-btn" data-count="3">üëÇ 3 things you can hear</button>
            <button class="ground-btn" data-count="2">üëÉ 2 things you can smell</button>
            <button class="ground-btn" data-count="1">üëÖ 1 thing you can taste</button>
          </div>
          
          <div style="margin-top: 30px; padding: 20px; background: rgba(0,0,0,0.2); border-radius: 12px;">
            <p><strong>Alternative grounding:</strong> If the 5-4-3-2-1 feels hard, try:</p>
            <button id="startAlternative" class="control-btn" style="margin-top: 10px; width: 100%; background: linear-gradient(135deg, #8a2be2, #6a0dad);">
              Name 3 things you love
            </button>
          </div>
          
          <p id="groundingComplete" style="display:none; margin-top: 24px; padding: 20px; background: rgba(0,247,224,0.1); border-radius: 12px; text-align: center; font-weight: 900; color: var(--mint); font-size: 1.2rem; animation: pulse 2s infinite;">
            ‚úÖ Grounding complete ‚Äî You're present and safe.
          </p>
        </div>
      </section>

      <!-- Soothing Sounds -->
      <section class="step-section" data-step="3">
        <h2 class="section-header" tabindex="0" role="button" aria-expanded="false" aria-controls="sounds">
          üé∂ Soothing Sounds & Audio Grounding
        </h2>
        <div id="sounds" class="collapsible-content" aria-hidden="true">
          <p style="text-align: center; margin-bottom: 20px;">
            Choose one sound to focus on. Only one plays at a time. Works offline.
          </p>
          <div class="audio-grid" role="group" aria-label="Sound options">
            <button class="audio-btn" data-sound="whiteNoise">ü§ç White Noise</button>
            <button class="audio-btn" data-sound="ocean">üåä Ocean Waves</button>
            <button class="audio-btn" data-sound="forest">üå≥ Forest Sounds</button>
            <button class="audio-btn" data-sound="rain">üåßÔ∏è Gentle Rain</button>
            <button class="audio-btn" data-sound="brownNoise">üß∏ Brown Noise</button>
            <button class="audio-btn mute" id="stopAll" style="grid-column: 1 / -1; background: rgba(255,255,255,0.1); color: var(--text);">
              üîá Mute All Sounds
            </button>
          </div>
          
          <div style="margin-top: 30px; padding: 20px; background: rgba(0,0,0,0.2); border-radius: 12px;">
            <p><strong>Pro tip:</strong> Use headphones for better immersion. Brown noise is especially grounding for anxiety.</p>
          </div>
        </div>
      </section>

      <!-- Check-In -->
      <section class="step-section" data-step="4">
        <h2 class="section-header" tabindex="0" role="button" aria-expanded="false" aria-controls="checkin">
          üßç Body & Environment Check-In
        </h2>
        <div id="checkin" class="collapsible-content" aria-hidden="true">
          <div class="grounding-grid" style="grid-template-columns: 1fr;">
            <div style="background: rgba(0,0,0,0.2); padding: 20px; border-radius: 12px; margin-bottom: 10px;">
              <p style="margin: 0 0 10px 0; color: var(--mint);"><strong>Hydration Check</strong></p>
              <p style="margin: 0; opacity: 0.9;">Take small sips of water. Avoid chugging.</p>
            </div>
            <div style="background: rgba(0,0,0,0.2); padding: 20px; border-radius: 12px; margin-bottom: 10px;">
              <p style="margin: 0 0 10px 0; color: var(--mint);"><strong>Comfort Check</strong></p>
              <p style="margin: 0; opacity: 0.9;">Adjust clothing, temperature, lighting.</p>
            </div>
            <div style="background: rgba(0,0,0,0.2); padding: 20px; border-radius: 12px; margin-bottom: 10px;">
              <p style="margin: 0 0 10px 0; color: var(--mint);"><strong>Position Check</strong></p>
              <p style="margin: 0; opacity: 0.9;">Sit or lie down if possible.</p>
            </div>
          </div>
          
          <div style="text-align: center; margin-top: 24px;">
            <button id="skipCheckin" class="control-btn">Continue to Next Step</button>
          </div>
        </div>
      </section>

      <!-- Timer -->
      <section class="step-section" data-step="5">
        <h2 class="section-header" tabindex="0" role="button" aria-expanded="false" aria-controls="wait">
          ‚è≥ Just Wait ‚Äî Guided Timer
        </h2>
        <div id="wait" class="collapsible-content" aria-hidden="true">
          <p style="text-align: center; max-width: 500px; margin: 0 auto 30px;">
            Most difficult moments pass within 15-20 minutes. Set this timer and breathe.
          </p>
          
          <div id="timerDisplay" class="timer-display">15:00</div>
          
          <div style="display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; margin-bottom: 30px;">
            <button id="startTimer" class="control-btn">‚ñ∂Ô∏è Start</button>
            <button id="pauseTimer" class="control-btn">‚è∏Ô∏è Pause</button>
            <button id="resetTimer" class="control-btn">üîÑ Reset</button>
            <button id="quick5min" class="control-btn" style="background: linear-gradient(135deg, #8a2be2, #6a0dad);">5 Min</button>
            <button id="quick10min" class="control-btn" style="background: linear-gradient(135deg, #8a2be2, #6a0dad);">10 Min</button>
          </div>
          
          <div id="timerMessage" style="text-align: center; font-style: italic; color: var(--mint); font-size: 1.1rem; padding: 20px; background: rgba(0,0,0,0.2); border-radius: 12px;">
            "This too shall pass." ‚Äî Many find stabilization after 10-20 minutes
          </div>
          
          <div id="progressMessage" style="display:none; text-align: center; margin-top: 30px; padding: 20px; background: rgba(0,247,224,0.1); border-radius: 12px; font-weight: 700; color: var(--mint);">
            You're doing your part by waiting. This will pass. üåà
          </div>
        </div>
      </section>

      <!-- Mantras -->
      <section class="step-section" data-step="6">
        <h2 class="section-header" tabindex="0" role="button" aria-expanded="false" aria-controls="mantras">
          üß† Affirmations & Mantras
        </h2>
        <div id="mantras" class="collapsible-content" aria-hidden="true">
          <div style="text-align: center; margin-bottom: 30px;">
            <p>Tap to change. Repeat silently or aloud.</p>
          </div>
          
          <div style="background: rgba(0,0,0,0.3); padding: 30px; border-radius: 16px; margin-bottom: 20px; min-height: 120px; display: flex; align-items: center; justify-content: center; cursor: pointer;" id="mantraText">
            <span style="font-size: 1.3rem; font-weight: 600; color: var(--mint); text-align: center;">I am safe and this will pass.</span>
          </div>
          
          <div style="display: flex; gap: 12px; justify-content: center;">
            <button id="nextMantra" class="control-btn">Next Mantra ‚û°Ô∏è</button>
            <button id="saveMantra" class="control-btn" style="background: linear-gradient(135deg, #8a2be2, #6a0dad);">‚≠ê Save This</button>
          </div>
        </div>
      </section>

      <!-- Cheat Sheet Section -->
      <section class="step-section">
        <h2 class="section-header" tabindex="0" role="button" aria-expanded="false" aria-controls="cheatSheet">
          üìã Quick Reference Cheat Sheet
        </h2>
        <div id="cheatSheet" class="collapsible-content">
          <div class="cheat-sheet-container">
            <h3 style="color: var(--mint); text-align: center; margin-bottom: 24px;">Emergency Grounding Protocol</h3>
            
            <div class="cheat-sheet-grid">
              <div class="cheat-card">
                <h4 style="color: var(--accent); margin-top: 0;">üÜò IMMEDIATE</h4>
                <ul style="margin: 10px 0; padding-left: 20px;">
                  <li>Stop, breathe (4-7-8)</li>
                  <li>Drink water slowly</li>
                  <li>Sit/lie down safely</li>
                  <li>Repeat: "I am safe"</li>
                </ul>
              </div>
              
              <div class="cheat-card">
                <h4 style="color: var(--accent); margin-top: 0;">üéØ GROUNDING</h4>
                <ul style="margin: 10px 0; padding-left: 20px;">
                  <li>5-4-3-2-1 technique</li>
                  <li>Cold compress on neck</li>
                  <li>Heavy blanket</li>
                  <li>Focus on breath</li>
                </ul>
              </div>
              
              <div class="cheat-card">
                <h4 style="color: var(--accent); margin-top: 0;">üïí TIMELINE</h4>
                <ul style="margin: 10px 0; padding-left: 20px;">
                  <li>0-5 min: Breathe</li>
                  <li>5-15 min: Ground</li>
                  <li>15-30 min: Wait</li>
                  <li>30+ min: External help</li>
                </ul>
              </div>
            </div>
            
            <div style="text-align: center; margin-top: 30px;">
              <a href="#" class="download-btn" id="downloadCheatSheetBtn">
                üì• Download Printable Cheat Sheet
              </a>
              <p style="font-size: 0.9rem; margin-top: 12px; opacity: 0.8;">
                Save for offline use ‚Ä¢ Print for harm reduction kits
              </p>
            </div>
          </div>
        </div>
      </section>

      <!-- Related Links -->
      <section class="step-section">
        <h2 class="section-header" tabindex="0" role="button" aria-expanded="false" aria-controls="relatedLinks">
          üîó More from PLURderapolis
        </h2>
        <div id="relatedLinks" class="collapsible-content">
          <div class="links-grid">
            <a href="https://plurderapolis.org/harm-reduction" class="resource-link" target="_blank">
              <span class="link-icon">üõ°Ô∏è</span>
              <div class="link-text">
                <h4>Harm Reduction Guide</h4>
                <p>Comprehensive safety protocols and testing info</p>
              </div>
            </a>
            
            <a href="https://plurderapolis.org/community" class="resource-link" target="_blank">
              <span class="link-icon">üë•</span>
              <div class="link-text">
                <h4>Community Support</h4>
                <p>Connect with experienced trip sitters</p>
              </div>
            </a>
            
            <a href="https://plurderapolis.org/education" class="resource-link" target="_blank">
              <span class="link-icon">üìö</span>
              <div class="link-text">
                <h4>Education Resources</h4>
                <p>Learn about psychedelic safety</p>
              </div>
            </a>
            
            <a href="https://plurderapolis.org/events" class="resource-link" target="_blank">
              <span class="link-icon">üé™</span>
              <div class="link-text">
                <h4>Event Safety</h4>
                <p>Festival and show safety guides</p>
              </div>
            </a>
            
            <a href="https://plurderapolis.org/integration" class="resource-link" target="_blank">
              <span class="link-icon">üå±</span>
              <div class="link-text">
                <h4>Integration Support</h4>
                <p>Process your experiences safely</p>
              </div>
            </a>
            
            <a href="https://plurderapolis.org/emergency" class="resource-link" target="_blank">
              <span class="link-icon">üö®</span>
              <div class="link-text">
                <h4>Emergency Protocols</h4>
                <p>When to seek medical help</p>
              </div>
            </a>
          </div>
        </div>
      </section>

      <!-- Emergency Resources -->
      <section class="step-section" data-step="7">
        <h2 class="section-header" tabindex="0" role="button" aria-expanded="false" aria-controls="backup">
          üÜò Emergency & External Support
        </h2>
        <div id="backup" class="collapsible-content" aria-hidden="true">
          <p style="text-align: center; margin-bottom: 24px; font-weight: 600; color: var(--mint);">
            If you need human support right now:
          </p>
          
          <div class="grounding-grid" style="grid-template-columns: 1fr;">
            <a class="ground-btn" href="https://firesideproject.org/" target="_blank" rel="noopener" style="text-decoration: none; background: linear-gradient(135deg, #FF6B6B, #FF8E8E);">
              üìû Fireside Project ‚Äî 62-FIRESIDE
            </a>
            <a class="ground-btn" href="https://tripsit.me/" target="_blank" rel="noopener" style="text-decoration: none; background: linear-gradient(135deg, #4ECDC4, #44A08D);">
              üí¨ TripSit ‚Äî Live Chat & Resources
            </a>
            <a class="ground-btn" href="https://neverusealone.com/" target="_blank" rel="noopener" style="text-decoration: none; background: linear-gradient(135deg, #556270, #4ECDC4);">
              üì± Never Use Alone ‚Äî 800-484-3731
            </a>
            <a class="ground-btn" href="/panic.html" style="text-decoration: none; background: linear-gradient(135deg, #8a2be2, #6a0dad);">
              üö® Panic Button (Minimal Distraction)
            </a>
            <a class="ground-btn" href="/emergency.html" style="text-decoration: none; background: linear-gradient(135deg, #FF0000, #8B0000); color: white;">
              üöë EMERGENCY MEDICAL HELP
            </a>
          </div>
          
          <div style="margin-top: 30px; padding: 20px; background: rgba(255,0,0,0.1); border-radius: 12px; border: 1px solid rgba(255,0,0,0.3);">
            <p style="margin: 0; color: #FF6B6B; font-weight: 600;">
              üö® Call 911 or your local emergency number if:
            </p>
            <ul style="margin: 10px 0 0 0; padding-left: 20px; color: #FF8E8E;">
              <li>Difficulty breathing</li>
              <li>Severe chest pain</li>
              <li>Unconsciousness</li>
              <li>Injury to self or others</li>
            </ul>
          </div>
        </div>
      </section>

      <!-- Encouragement Messages -->
      <div id="encouragement" style="display:none; margin: 30px 0; padding: 20px; background: linear-gradient(135deg, rgba(0,247,224,0.1), rgba(255,110,199,0.1)); border-radius: 16px; text-align: center; font-weight: 700; color: var(--mint); font-size: 1.1rem; animation: pulse 2s infinite;">
        You're doing great. Keep going. üí´
      </div>
      
    </div> <!-- End guideContent -->

    <!-- Legal Footer -->
    <footer class="legal-footer">
      <div class="disclaimer">
        <p><strong>Disclaimer:</strong> This guide is for harm reduction and educational purposes only. It is not a substitute for professional medical advice, diagnosis, or treatment. Always seek the advice of your physician or other qualified health provider with any questions you may have regarding a medical condition. If you are experiencing a medical emergency, call emergency services immediately. PLURderapolis is not responsible for any actions taken based on the information provided here.</p>
        <p style="margin-top: 10px;"><strong>Offline Note:</strong> This page works offline. Audio is generated in your browser, no internet needed.</p>
      </div>
      <p style="margin: 20px 0; color: var(--mint);">PLURderapolis ‚Ä¢ Your partners in safe journeying üçë</p>
      <p style="font-size: 0.8rem; opacity: 0.6;">v2.0 ‚Ä¢ Mobile Optimized ‚Ä¢ Offline Capable ‚Ä¢ Updated 2024</p>
    </footer>

  </div> <!-- End app-container -->

  <!-- Mobile Bottom Navigation -->
  <nav class="mobile-nav">
    <div class="nav-items">
      <button class="nav-item" id="mobileHome">
        <span class="nav-icon">üè†</span>
        <span class="nav-label">Home</span>
      </button>
      <button class="nav-item" id="mobileBreathe">
        <span class="nav-icon">üí®</span>
        <span class="nav-label">Breathe</span>
      </button>
      <button class="nav-item" id="mobileGround">
        <span class="nav-icon">ü™®</span>
        <span class="nav-label">Ground</span>
      </button>
      <button class="nav-item" id="mobileTimer">
        <span class="nav-icon">‚è±Ô∏è</span>
        <span class="nav-label">Timer</span>
      </button>
      <button class="nav-item" id="mobileEmergency">
        <span class="nav-icon">üÜò</span>
        <span class="nav-label">Emergency</span>
      </button>
    </div>
  </nav>

<!-- Service Worker Registration and Enhanced Script -->
<script>
// Service Worker for Offline Capability
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('/sw.js').then(registration => {
      console.log('ServiceWorker registered:', registration);
      
      // Check for updates
      registration.addEventListener('updatefound', () => {
        const newWorker = registration.installing;
        newWorker.addEventListener('statechange', () => {
          if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
            showUpdateNotification();
          }
        });
      });
    }).catch(error => {
      console.log('ServiceWorker registration failed:', error);
    });
  });
}

// Update notification
function showUpdateNotification() {
  if (confirm('A new version of the Bad Trip Guide is available. Reload to update?')) {
    window.location.reload();
  }
}

// Offline Detection
window.addEventListener('online', updateOnlineStatus);
window.addEventListener('offline', updateOnlineStatus);

function updateOnlineStatus() {
  const indicator = document.getElementById('offlineIndicator');
  if (!navigator.onLine) {
    indicator.style.display = 'block';
    setTimeout(() => {
      indicator.style.display = 'none';
    }, 3000);
  } else {
    indicator.style.display = 'none';
  }
}

// Initialize online status
updateOnlineStatus();

// Show loading spinner
function showLoading() {
  document.getElementById('loadingSpinner').style.display = 'block';
}

function hideLoading() {
  document.getElementById('loadingSpinner').style.display = 'none';
}

// Enhanced audio system with more sounds
let audioContext = null;
let currentOscillator = null;
let currentGainNode = null;
let isPlaying = false;
let breathSpeed = 8; // seconds per breath cycle

function initAudioContext() {
  if (!audioContext) {
    audioContext = new (window.AudioContext || window.webkitAudioContext)();
  }
}

// Enhanced sound generator with more options
function createSound(type) {
  stopAllAudio();
  initAudioContext();
  
  switch(type) {
    case 'whiteNoise':
      createWhiteNoise();
      break;
    case 'ocean':
      createOceanWaves();
      break;
    case 'forest':
      createForestSounds();
      break;
    case 'rain':
      createRainSound();
      break;
    case 'brownNoise':
      createBrownNoise();
      break;
  }
  isPlaying = true;
  updateAudioButtons();
}

function createWhiteNoise() {
  const bufferSize = 2 * audioContext.sampleRate;
  const buffer = audioContext.createBuffer(1, bufferSize, audioContext.sampleRate);
  const data = buffer.getChannelData(0);
  
  for (let i = 0; i < bufferSize; i++) {
    data[i] = Math.random() * 2 - 1;
  }
  
  currentOscillator = audioContext.createBufferSource();
  currentOscillator.buffer = buffer;
  currentOscillator.loop = true;
  currentGainNode = audioContext.createGain();
  currentGainNode.gain.value = 0.05;
  
  currentOscillator.connect(currentGainNode);
  currentGainNode.connect(audioContext.destination);
  currentOscillator.start();
}

function createOceanWaves() {
  currentOscillator = audioContext.createOscillator();
  currentOscillator.type = 'sine';
  currentOscillator.frequency.value = 80;
  
  // Create wave-like modulation
  const lfo = audioContext.createOscillator();
  lfo.frequency.value = 0.1;
  const lfoGain = audioContext.createGain();
  lfoGain.gain.value = 40;
  
  // Create occasional "wave crash"
  const crashOsc = audioContext.createOscillator();
  crashOsc.frequency.value = 200;
  const crashGain = audioContext.createGain();
  crashGain.gain.value = 0;
  
  lfo.connect(lfoGain);
  lfoGain.connect(currentOscillator.frequency);
  
  currentGainNode = audioContext.createGain();
  currentGainNode.gain.value = 0.1;
  
  currentOscillator.connect(currentGainNode);
  currentGainNode.connect(audioContext.destination);
  
  lfo.start();
  currentOscillator.start();
  
  // Add occasional wave crashes
  setInterval(() => {
    if (isPlaying && currentGainNode) {
      crashGain.gain.setValueAtTime(0.1, audioContext.currentTime);
      crashGain.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + 2);
    }
  }, 8000);
}

function createForestSounds() {
  // Create multiple oscillators for bird-like sounds
  currentOscillator = audioContext.createOscillator();
  currentOscillator.type = 'sine';
  currentOscillator.frequency.value = 1200;
  
  // Add chirp modulation
  const chirpLFO = audioContext.createOscillator();
  chirpLFO.frequency.value = 8;
  const chirpGain = audioContext.createGain();
  chirpGain.gain.value = 100;
  
  chirpLFO.connect(chirpGain);
  chirpGain.connect(currentOscillator.frequency);
  
  currentGainNode = audioContext.createGain();
  currentGainNode.gain.value = 0.05;
  
  currentOscillator.connect(currentGainNode);
  currentGainNode.connect(audioContext.destination);
  
  chirpLFO.start();
  currentOscillator.start();
}

function createRainSound() {
  // Brown noise-like rain
  createBrownNoise();
  if (currentGainNode) {
    currentGainNode.gain.value = 0.03;
  }
}

function createBrownNoise() {
  const bufferSize = 2 * audioContext.sampleRate;
  const buffer = audioContext.createBuffer(1, bufferSize, audioContext.sampleRate);
  const data = buffer.getChannelData(0);
  
  let lastOut = 0.0;
  for (let i = 0; i < bufferSize; i++) {
    const white = Math.random() * 2 - 1;
    data[i] = (lastOut + (0.02 * white)) / 1.02;
    lastOut = data[i];
    data[i] *= 3.5;
  }
  
  currentOscillator = audioContext.createBufferSource();
  currentOscillator.buffer = buffer;
  currentOscillator.loop = true;
  currentGainNode = audioContext.createGain();
  currentGainNode.gain.value = 0.1;
  
  currentOscillator.connect(currentGainNode);
  currentGainNode.connect(audioContext.destination);
  currentOscillator.start();
}

function stopAllAudio() {
  if (currentOscillator) {
    try {
      currentOscillator.stop();
      currentOscillator.disconnect();
    } catch(e) {}
    currentOscillator = null;
  }
  if (currentGainNode) {
    currentGainNode.disconnect();
    currentGainNode = null;
  }
  isPlaying = false;
  updateAudioButtons();
}

function updateAudioButtons() {
  document.querySelectorAll('.audio-btn').forEach(btn => {
    btn.classList.remove('playing');
  });
}

// Enhanced breathing animation with variable speed
let breathAnimation;
let isBreathing = false;
let breathPhase = 0; // 0 = inhale, 1 = hold, 2 = exhale, 3 = hold

function startBreathing() {
  if (isBreathing) return;
  
  isBreathing = true;
  const breathShape = document.getElementById('breathShape');
  const breathText = document.getElementById('breathText');
  const phases = ['Breathe In', 'Hold', 'Breathe Out', 'Hold'];
  const phaseTimes = [breathSpeed * 0.4, breathSpeed * 0.1, breathSpeed * 0.4, breathSpeed * 0.1];
  
  let startTime = Date.now();
  let currentPhase = 0;
  
  function updateBreath() {
    if (!isBreathing) return;
    
    const elapsed = Date.now() - startTime;
    const phaseProgress = elapsed / (phaseTimes[currentPhase] * 1000);
    
    if (phaseProgress >= 1) {
      currentPhase = (currentPhase + 1) % 4;
      startTime = Date.now();
      breathText.textContent = phases[currentPhase];
    }
    
    // Calculate scale based on phase
    let scale;
    if (currentPhase === 0) { // Inhale
      scale = 1 + 0.5 * phaseProgress;
    } else if (currentPhase === 1) { // Hold inhale
      scale = 1.5;
    } else if (currentPhase === 2) { // Exhale
      scale = 1.5 - 0.5 * phaseProgress;
    } else { // Hold exhale
      scale = 1;
    }
    
    breathShape.style.transform = `scale(${scale})`;
    
    requestAnimationFrame(updateBreath);
  }
  
  updateBreath();
}

function stopBreathing() {
  isBreathing = false;
  const breathShape = document.getElementById('breathShape');
  breathShape.style.transform = 'scale(1)';
  document.getElementById('breathText').textContent = 'Breathe';
}

// Download Cheat Sheet
function downloadCheatSheet() {
  showLoading();
  
  const cheatSheetContent = `
PLURDERAPOLIS BAD TRIP GUIDE - EMERGENCY CHEAT SHEET
====================================================

üÜò IMMEDIATE RESPONSE (First 5 minutes)
1. STOP - Pause whatever you're doing
2. BREATHE - 4-7-8 breathing: Inhale 4, Hold 7, Exhale 8
3. HYDRATE - Small sips of water
4. POSITION - Sit or lie down safely
5. AFFIRM - Repeat: "I am safe, this will pass"

üéØ GROUNDING TECHNIQUES
‚Ä¢ 5-4-3-2-1 Method:
  5 things you can SEE
  4 things you can TOUCH
  3 things you can HEAR
  2 things you can SMELL
  1 thing you can TASTE

‚Ä¢ Alternative: Name 3 things you love
‚Ä¢ Physical: Cold compress on neck/wrists
‚Ä¢ Tactile: Hold something textured

üïí TIMELINE EXPECTATIONS
0-5 min: Breathe and hydrate
5-15 min: Use grounding techniques
15-30 min: Most intensity passes
30+ min: Consider external support if needed

üîä AUDIO GROUNDING
‚Ä¢ White/Brown noise for anxiety
‚Ä¢ Ocean waves for calming
‚Ä¢ Forest sounds for distraction
‚Ä¢ Use ONE sound at a time

üìû EMERGENCY CONTACTS
‚Ä¢ Fireside Project: 62-FIRESIDE (623-473-7433)
‚Ä¢ TripSit: https://tripsit.me
‚Ä¢ Never Use Alone: 800-484-3731
‚Ä¢ EMERGENCY: Call 911 for medical emergencies

‚ö†Ô∏è RED FLAGS - SEEK HELP IMMEDIATELY
‚Ä¢ Difficulty breathing
‚Ä¢ Chest pain
‚Ä¢ Injury to self/others
‚Ä¢ Loss of consciousness
‚Ä¢ Severe allergic reaction

üå± AFTERCARE
‚Ä¢ Rest and hydrate
‚Ä¢ Eat light, easily digestible food
‚Ä¢ Gentle movement if possible
‚Ä¢ Journal about experience
‚Ä¢ Talk to trusted friend when ready

Remember: This is temporary. You are safe.
Generated by PLURderapolis.org - Your partners in safe journeying

Version: 2.0 ‚Ä¢ Date: ${new Date().toLocaleDateString()}
  `;
  
  const blob = new Blob([cheatSheetContent], { type: 'text/plain' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `PLURderapolis_Emergency_Cheat_Sheet_${new Date().toISOString().split('T')[0]}.txt`;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
  
  hideLoading();
  
  // Show confirmation
  const encouragement = document.getElementById('encouragement');
  encouragement.textContent = '‚úÖ Cheat sheet downloaded! Save it for offline use.';
  encouragement.style.display = 'block';
  setTimeout(() => {
    encouragement.style.display = 'none';
  }, 5000);
}

// Initialize everything when DOM is loaded
document.addEventListener('DOMContentLoaded', () => {
  // Show loading initially
  showLoading();
  
  // Initialize variables
  const landing = document.getElementById('landing');
  const guideContent = document.getElementById('guideContent');
  const sections = Array.from(document.querySelectorAll('.step-section'));
  const progressBar = document.getElementById('progressBar');
  const encouragement = document.getElementById('encouragement');
  
  let mantraIndex = 0;
  const mantras = [
    "I am safe and this will pass.",
    "This feeling is temporary ‚Äî I can wait.",
    "I can breathe. I can slow down.",
    "I have survived this before. I will again.",
    "Small steps. One breath at a time.",
    "I am not my thoughts. I am the observer.",
    "This too shall pass. Everything changes.",
    "I am exactly where I need to be.",
    "I release what I cannot control.",
    "I am supported by the universe."
  ];
  
  // Timer functionality
  let timer = null;
  let timeLeft = 900; // 15 minutes in seconds
  const timerDisplay = document.getElementById('timerDisplay');
  
  function updateTimerDisplay() {
    const minutes = Math.floor(timeLeft / 60);
    const seconds = timeLeft % 60;
    timerDisplay.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
    
    // Update progress message
    if (timeLeft <= 300) { // 5 minutes left
      document.getElementById('progressMessage').style.display = 'block';
    }
  }
  
  // Landing page buttons
  document.getElementById('startGuided').addEventListener('click', () => {
    landing.style.display = 'none';
    guideContent.style.display = 'block';
    document.getElementById('guidedMode').click();
    hideLoading();
  });
  
  document.getElementById('startModular').addEventListener('click', () => {
    landing.style.display = 'none';
    guideContent.style.display = 'block';
    document.getElementById('modularMode').click();
    hideLoading();
  });
  
  document.getElementById('quickCheatSheet').addEventListener('click', () => {
    landing.style.display = 'none';
    guideContent.style.display = 'block';
    document.getElementById('cheatSheet').classList.add('open');
    document.querySelector('[aria-controls="cheatSheet"]').classList.add('open');
    hideLoading();
  });
  
  // Quick navigation
  document.getElementById('quickBreathing').addEventListener('click', () => {
    landing.style.display = 'none';
    guideContent.style.display = 'block';
    document.getElementById('breathing').classList.add('open');
    document.querySelector('[aria-controls="breathing"]').classList.add('open');
    hideLoading();
  });
  
  document.getElementById('quickGrounding').addEventListener('click', () => {
    landing.style.display = 'none';
    guideContent.style.display = 'block';
    document.getElementById('grounding').classList.add('open');
    document.querySelector('[aria-controls="grounding"]').classList.add('open');
    hideLoading();
  });
  
  document.getElementById('quickSounds').addEventListener('click', () => {
    landing.style.display = 'none';
    guideContent.style.display = 'block';
    document.getElementById('sounds').classList.add('open');
    document.querySelector('[aria-controls="sounds"]').classList.add('open');
    hideLoading();
  });
  
  document.getElementById('quickEmergency').addEventListener('click', () => {
    landing.style.display = 'none';
    guideContent.style.display = 'block';
    document.getElementById('backup').classList.add('open');
    document.querySelector('[aria-controls="backup"]').classList.add('open');
    hideLoading();
  });
  
  // Mobile navigation
  document.getElementById('mobileHome').addEventListener('click', () => {
    window.scrollTo({ top: 0, behavior: 'smooth' });
  });
  
  document.getElementById('mobileBreathe').addEventListener('click', () => {
    document.getElementById('breathing').scrollIntoView({ behavior: 'smooth' });
    document.getElementById('breathing').classList.add('open');
    document.querySelector('[aria-controls="breathing"]').classList.add('open');
  });
  
  document.getElementById('mobileGround').addEventListener('click', () => {
    document.getElementById('grounding').scrollIntoView({ behavior: 'smooth' });
    document.getElementById('grounding').classList.add('open');
    document.querySelector('[aria-controls="grounding"]').classList.add('open');
  });
  
  document.getElementById('mobileTimer').addEventListener('click', () => {
    document.getElementById('wait').scrollIntoView({ behavior: 'smooth' });
    document.getElementById('wait').classList.add('open');
    document.querySelector('[aria-controls="wait"]').classList.add('open');
  });
  
  document.getElementById('mobileEmergency').addEventListener('click', () => {
    document.getElementById('backup').scrollIntoView({ behavior: 'smooth' });
    document.getElementById('backup').classList.add('open');
    document.querySelector('[aria-controls="backup"]').classList.add('open');
  });
  
  // Section toggle functionality
  document.querySelectorAll('.section-header').forEach(header => {
    header.addEventListener('click', () => {
      const content = document.getElementById(header.getAttribute('aria-controls'));
      const isOpen = content.classList.contains('open');
      
      // Close all other sections
      document.querySelectorAll('.collapsible-content').forEach(c => {
        if (c !== content) {
          c.classList.remove('open');
          c.previousElementSibling.classList.remove('open');
        }
      });
      
      // Toggle current section
      if (!isOpen) {
        content.classList.add('open');
        header.classList.add('open');
        header.setAttribute('aria-expanded', 'true');
        
        // Smooth scroll to section
        setTimeout(() => {
          header.scrollIntoView({ 
            behavior: 'smooth', 
            block: 'center',
            inline: 'nearest'
          });
        }, 100);
      }
      
      updateProgress();
    });
    
    // Keyboard support
    header.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' || e.key === ' ') {
        e.preventDefault();
        header.click();
      }
    });
  });
  
  // Update progress bar
  function updateProgress() {
    const openSections = sections.filter(section => {
      return section.querySelector('.collapsible-content').classList.contains('open');
    }).length;
    
    const progress = (openSections / sections.length) * 100;
    progressBar.style.width = `${progress}%`;
  }
  
  // Guided mode
  document.getElementById('guidedMode').addEventListener('click', () => {
    let currentSection = 0;
    
    function openNextSection() {
      if (currentSection >= sections.length) return;
      
      // Close all sections first
      document.querySelectorAll('.collapsible-content').forEach(c => {
        c.classList.remove('open');
        c.previousElementSibling.classList.remove('open');
      });
      
      // Open current section
      const section = sections[currentSection];
      const content = section.querySelector('.collapsible-content');
      const header = section.querySelector('.section-header');
      
      content.classList.add('open');
      header.classList.add('open');
      
      // Scroll to section
      setTimeout(() => {
        header.scrollIntoView({ behavior: 'smooth', block: 'center' });
      }, 300);
      
      currentSection++;
      
      // Continue with next section after delay
      if (currentSection < sections.length) {
        setTimeout(openNextSection, 8000); // 8 seconds per section
      }
    }
    
    openNextSection();
  });
  
  // Modular mode
  document.getElementById('modularMode').addEventListener('click', () => {
    document.querySelectorAll('.collapsible-content').forEach(c => {
      c.classList.remove('open');
      c.previousElementSibling.classList.remove('open');
    });
  });
  
  // Breathing controls
  document.getElementById('breathSlower').addEventListener('click', () => {
    breathSpeed = Math.min(12, breathSpeed + 1);
    stopBreathing();
    startBreathing();
  });
  
  document.getElementById('breathFaster').addEventListener('click', () => {
    breathSpeed = Math.max(4, breathSpeed - 1);
    stopBreathing();
    startBreathing();
  });
  
  // Start breathing when section opens
  document.querySelector('[aria-controls="breathing"]').addEventListener('click', () => {
    setTimeout(() => {
      startBreathing();
    }, 500);
  });
  
  // Stop breathing when leaving section
  document.querySelectorAll('.section-header').forEach(header => {
    if (header.getAttribute('aria-controls') !== 'breathing') {
      header.addEventListener('click', () => {
        stopBreathing();
      });
    }
  });
  
  // Grounding buttons
  let groundedCount = 0;
  document.querySelectorAll('.ground-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      if (!btn.classList.contains('done')) {
        btn.classList.add('done');
        groundedCount++;
        
        if (groundedCount === 5) {
          document.getElementById('groundingComplete').style.display = 'block';
          showEncouragement('‚úÖ Grounding complete! You\'re present and safe.');
        }
      }
    });
  });
  
  // Alternative grounding
  document.getElementById('startAlternative').addEventListener('click', () => {
    const alternatives = [
      "Name 3 things you're grateful for",
      "Name 3 people who care about you",
      "Name 3 places that feel safe",
      "Name 3 favorite memories",
      "Name 3 things you love about yourself"
    ];
    
    let current = 0;
    const interval = setInterval(() => {
      if (current >= alternatives.length) {
        clearInterval(interval);
        document.getElementById('groundingComplete').style.display = 'block';
        return;
      }
      
      showEncouragement(alternatives[current]);
      current++;
    }, 4000);
  });
  
  // Audio controls
  document.querySelectorAll('.audio-btn').forEach(btn => {
    if (btn.dataset.sound) {
      btn.addEventListener('click', () => {
        if (btn.classList.contains('playing')) {
          stopAllAudio();
        } else {
          createSound(btn.dataset.sound);
          btn.classList.add('playing');
        }
      });
    }
  });
  
  document.getElementById('stopAll').addEventListener('click', stopAllAudio);
  
  // Timer controls
  document.getElementById('startTimer').addEventListener('click', () => {
    if (!timer) {
      timer = setInterval(() => {
        if (timeLeft <= 0) {
          clearInterval(timer);
          timer = null;
          showEncouragement('‚è∞ Time\'s up! How are you feeling now?');
          return;
        }
        timeLeft--;
        updateTimerDisplay();
      }, 1000);
    }
  });
  
  document.getElementById('pauseTimer').addEventListener('click', () => {
    if (timer) {
      clearInterval(timer);
      timer = null;
    }
  });
  
  document.getElementById('resetTimer').addEventListener('click', () => {
    clearInterval(timer);
    timer = null;
    timeLeft = 900;
    updateTimerDisplay();
    document.getElementById('progressMessage').style.display = 'none';
  });
  
  document.getElementById('quick5min').addEventListener('click', () => {
    timeLeft = 300;
    updateTimerDisplay();
  });
  
  document.getElementById('quick10min').addEventListener('click', () => {
    timeLeft = 600;
    updateTimerDisplay();
  });
  
  // Mantras
  document.getElementById('mantraText').addEventListener('click', () => {
    mantraIndex = (mantraIndex + 1) % mantras.length;
    document.getElementById('mantraText').querySelector('span').textContent = mantras[mantraIndex];
  });
  
  document.getElementById('nextMantra').addEventListener('click', () => {
    mantraIndex = (mantraIndex + 1) % mantras.length;
    document.getElementById('mantraText').querySelector('span').textContent = mantras[mantraIndex];
  });
  
  // Download cheat sheet
  document.getElementById('downloadCheatSheetBtn').addEventListener('click', (e) => {
    e.preventDefault();
    downloadCheatSheet();
  });
  
  document.getElementById('downloadCheatSheet').addEventListener('click', downloadCheatSheet);
  
  // Show encouragement messages
  function showEncouragement(message) {
    encouragement.textContent = message;
    encouragement.style.display = 'block';
    setTimeout(() => {
      encouragement.style.display = 'none';
    }, 4000);
  }
  
  // Random encouragement
  function showRandomEncouragement() {
    const messages = [
      "üåü You're doing great. Keep going.",
      "üí´ This moment will pass.",
      "üåø You are safe exactly where you are.",
      "üïäÔ∏è Peace is available in this breath.",
      "üåà You've survived 100% of your bad days so far.",
      "üåÄ Everything is temporary, including this.",
      "üåä Ride the wave. You've got this."
    ];
    
    if (Math.random() > 0.7) { // 30% chance
      showEncouragement(messages[Math.floor(Math.random() * messages.length)]);
    }
  }
  
  // Show random encouragement every 2 minutes
  setInterval(showRandomEncouragement, 120000);
  
  // Initialize timer display
  updateTimerDisplay();
  
  // Hide loading after 1 second
  setTimeout(() => {
    hideLoading();
  }, 1000);
  
  // Add smooth scrolling to all anchor links
  document.querySelectorAll('a[href^="#"]').forEach(anchor => {
    anchor.addEventListener('click', function (e) {
      e.preventDefault();
      const target = document.querySelector(this.getAttribute('href'));
      if (target) {
        target.scrollIntoView({
          behavior: 'smooth',
          block: 'start'
        });
      }
    });
  });
  
  // Add touch-friendly enhancements
  document.addEventListener('touchstart', () => {}, { passive: true });
  
  // Prevent zoom on double-tap
  let lastTouchEnd = 0;
  document.addEventListener('touchend', (e) => {
    const now = Date.now();
    if (now - lastTouchEnd <= 300) {
      e.preventDefault();
    }
    lastTouchEnd = now;
  }, { passive: false });
  
  // Initialize with first mantra
  document.getElementById('mantraText').querySelector('span').textContent = mantras[0];
});

// PWA Service Worker
const registerServiceWorker = async () => {
  if ('serviceWorker' in navigator) {
    try {
      const registration = await navigator.serviceWorker.register('sw.js');
      if (registration.installing) {
        console.log('Service worker installing');
      } else if (registration.waiting) {
        console.log('Service worker installed');
      } else if (registration.active) {
        console.log('Service worker active');
      }
    } catch (error) {
      console.error(`Registration failed with ${error}`);
    }
  }
};

// Register service worker on page load
window.addEventListener('load', () => {
  registerServiceWorker();
});
</script>

<!-- Service Worker Script (sw.js content embedded for completeness) -->
<script id="service-worker" type="text/javascript">
// This would normally be in a separate sw.js file
const CACHE_NAME = 'plurderapolis-bad-trip-guide-v2';
const urlsToCache = [
  '/',
  '/index.html',
  '/manifest.json',
  '/icon-192.png',
  '/icon-512.png'
];

self.addEventListener('install', event => {
  event.waitUntil(
    caches.open(CACHE_NAME)
      .then(cache => cache.addAll(urlsToCache))
  );
});

self.addEventListener('fetch', event => {
  event.respondWith(
    caches.match(event.request)
      .then(response => response || fetch(event.request))
  );
});

self.addEventListener('activate', event => {
  event.waitUntil(
    caches.keys().then(cacheNames => {
      return Promise.all(
        cacheNames.map(cacheName => {
          if (cacheName !== CACHE_NAME) {
            return caches.delete(cacheName);
          }
        })
      );
    })
  );
});
</script>
</body>
</html>
