<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PLURderapolis ‚Äî Harm Reduction for Minnesota Ravers</title>
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@600;700&family=Roboto&display=swap" rel="stylesheet">
<style>
/* Reset & body */
body {
  margin: 0;
  font-family: 'Roboto', sans-serif;
  background-color: #0d0d0d;
  color: #fff;
  line-height: 1.6;
  overflow-x: hidden;
  background: radial-gradient(circle at bottom, #0d0d0d 0%, #1a001a 100%);
}

/* Neon Minneapolis skyline */
#skyline {
  position: fixed;
  bottom: 0;
  left: 0;
  width: 100%;
  height: 220px;
  background: url('images/skyline.png') no-repeat bottom center;
  background-size: contain;
  filter: drop-shadow(0 0 10px #00f7e0) drop-shadow(0 0 20px #ff69b4);
  pointer-events: none;
  z-index: 0;
  animation: skylineGlow 4s infinite alternate;
}
@keyframes skylineGlow {
  0% { filter: drop-shadow(0 0 8px #00f7e0) drop-shadow(0 0 16px #ff69b4); }
  100% { filter: drop-shadow(0 0 12px #00f7e0) drop-shadow(0 0 24px #ff69b4); }
}

/* Site Title */
.site-title {
  text-align: center;
  padding: 1rem 0;
  position: relative;
  z-index: 2;
}
.site-title h1 {
  font-family: 'Montserrat', sans-serif;
  font-weight: 700;
  font-size: clamp(2rem,5vw,3rem);
  color: #00f7e0;
  letter-spacing: 0.15em;
  text-transform: uppercase;
  background: linear-gradient(90deg, #00f7e0 0%, #a3f7ff 50%, #00f7e0 100%);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  animation: shineMove 6s linear infinite;
  filter: drop-shadow(0 0 6px #00f7e0aa);
}
.site-title .tagline {
  font-family: 'Roboto', sans-serif;
  color: #88e9e3;
  font-size: 1rem;
  letter-spacing: 0.1em;
  margin-top: 0.25rem;
  font-weight: 600;
  text-transform: uppercase;
  opacity: 0.8;
}
@keyframes shineMove {0% {background-position: 100% 0;}100% {background-position: 0 0;}}

/* Hamburger Menu */
.menu-btn {
  position: fixed;
  top: 15px;
  left: 15px;
  z-index: 1001;
  cursor: pointer;
  width: 35px;
  height: 30px;
  display: flex;
  flex-direction: column;
  justify-content: space-between;
}
.menu-btn div {
  height: 5px;
  background: #00f7e0;
  border-radius: 3px;
  transition: all 0.3s ease;
}
.menu-btn.active div:nth-child(1){ transform: rotate(45deg) translate(6px,6px);}
.menu-btn.active div:nth-child(2){ opacity:0;}
.menu-btn.active div:nth-child(3){ transform: rotate(-45deg) translate(7px,-7px);}
.side-nav {
  position: fixed;
  top: 0;
  left: -260px;
  width: 260px;
  height: 100%;
  background: #3a0052;
  box-shadow: 2px 0 10px #000000aa;
  overflow-y: auto;
  transition: left 0.3s ease;
  padding-top: 70px;
  z-index:1000;
}
.side-nav.active { left:0;}
.side-nav ul { list-style:none; padding:0;}
.side-nav ul li { padding:0;}
.side-nav ul li a {
  display:block; padding:12px 20px; color:#fff; text-decoration:none; border-bottom:1px solid #5d3a7d;
  font-weight:bold;
}
.side-nav ul li a:hover { background:#5d3a7d; }
.side-nav ul li ul { display:none; padding-left:10px;}
.side-nav ul li.show > ul { display:block; }
.side-nav ul li ul li a { font-weight:normal; font-size:0.95rem; }

/* Scroll alert */
.rave-alert-wrapper {
  background-color:#1a1a1a;
  overflow:hidden;
  border-top:1px solid #444;
  border-bottom:1px solid #444;
  position:relative;
  height:2.5rem;
  display:flex;
  align-items:center;
  width:100vw;
  z-index:2;
}
.rave-alert-link {
  display:inline-block;
  white-space:nowrap;
  color:#ff69b4;
  font-size:1.1rem;
  text-decoration:none;
  padding-left:100%;
  animation: scroll-left 20s linear infinite;
}
@keyframes scroll-left {0%{transform:translateX(0);}100%{transform:translateX(-100%);}}

/* Sections */
.section {
  margin:1.5rem auto;
  padding:1rem 1.5rem;
  max-width:1000px;
  background-color:#3a0052;
  border-radius:10px;
  box-shadow:0 0 12px rgba(0,255,255,0.1);
  position: relative;
  z-index: 1;
}
.section h2 { color:#00f7e0; font-family:'Montserrat',sans-serif;}
.section ul { padding-left:1.2rem;}
.section ul li { margin-bottom:0.5rem;}
.cta-button { display:inline-block; margin-top:0.8rem; background:#00f7e0; color:#2e003e; padding:0.6rem 1.1rem; border-radius:8px; text-decoration:none; font-weight:bold; transition: all 0.2s;}
.cta-button:hover{opacity:0.85; transform:scale(1.03);}

/* Cards layout */
.card-container { display:flex; flex-wrap:wrap; gap:1rem; justify-content:center;}
.card { background:#2a0036; border-radius:10px; padding:1rem; width:280px; box-shadow:0 0 15px rgba(255,111,145,0.3); transition: all 0.2s; }
.card:hover { transform:scale(1.03); box-shadow:0 0 25px rgba(255,111,145,0.6); }
.card h3 { color:#ff69b4; font-family:'Montserrat',sans-serif; margin-top:0;}
.card p { font-size:0.95rem; }

/* Search bar - moved to fixed top-center so it won't be inside the side-nav visually */
.search-bar {
  position: fixed;
  top: 86px; /* sits below site title */
  left: 50%;
  transform: translateX(-50%);
  margin: 0;
  max-width: 700px;
  width: calc(100% - 40px);
  display:flex;
  z-index:1005;
}
.search-bar input{ flex:1; padding:12px 14px; border:none; border-radius:8px 0 0 8px; font-size:1rem; }
.search-bar button{ padding:12px; border:none; background:#00f7e0; color:#2e003e; border-radius:0 8px 8px 0; cursor:pointer; }
#searchResults { position:absolute; top:110%; left:0; right:0; background:#3a0052; max-height:350px; overflow-y:auto; border-radius:0 0 8px 8px; display:none; z-index:1006; box-shadow:0 6px 24px rgba(0,0,0,0.6);}
#searchResults ul { list-style:none; padding:0; margin:0;}
#searchResults li { padding:10px 12px; border-bottom:1px solid #5d3a7d; cursor:pointer;}
#searchResults li:hover { background:#5d3a7d; }
#searchResults .result-title{ font-weight:700; color:#00f7e0; margin-bottom:4px; }
#searchResults .result-snippet{ font-size:0.85rem; color:#eaeaea; opacity:0.95; line-height:1.35; }
#searchResults mark{ background:#ff6ec7; color:#1c0028; padding:0 2px; border-radius:2px; }

/* Peach panic button */
#peachWrap {
  position:fixed; bottom:24px; right:24px; z-index:1002; display:flex; flex-direction:column; align-items:center; gap:6px;
}
#peachWrap a.emoji-panic{
  width:60px; height:60px; font-size:2.5rem;
  background: radial-gradient(circle at 35% 35%, #ffb07c, #ff6f91);
  border-radius:50% 50% 45% 55% / 60% 55% 45% 50%;
  position: relative;
  display:flex; justify-content:center; align-items:center;
  cursor:pointer; text-decoration:none; color:#fff;
  box-shadow: 0 0 10px #ff69b4, 0 0 20px #00f7e0;
  animation: emojiPulse 2s infinite;
}
#peachWrap a.emoji-panic::before{
  content:"";
  position:absolute;
  top:-10px; left:22px;
  width:15px; height:12px;
  background: linear-gradient(135deg,#7aff7a,#2eb62c);
  border-radius:50%;
  transform:rotate(-20deg);
}
#peachWrap a.emoji-panic:hover { transform:scale(1.2);}
@keyframes emojiPulse{0%{transform:scale(1);}50%{transform:scale(1.12);}100%{transform:scale(1);}}

/* Footer */
footer{margin-top:2rem;font-size:0.9rem;color:#aaa;text-align:center; position: relative; z-index:2;}
footer hr{border-color:#444;margin-bottom:1rem;}
footer p{max-width:800px;margin:0.5rem auto;}
footer ul{list-style:none;padding:0;display:flex;flex-wrap:wrap;justify-content:center;margin-top:1rem;}
footer ul li a{color:#00f7e0;padding:0 10px;text-decoration:none;}
footer ul li a:hover{text-decoration:underline;}

/* Responsive tweaks */
@media(max-width:800px){
  .search-bar{ max-width: calc(100% - 40px); top: 76px; width: calc(100% - 28px); }
  #searchResults { top: 110%; }
}
@media(max-width:600px){
  .site-title { padding-top: 12px; }
  .search-bar{ top: 72px; left: 50%; transform: translateX(-50%); width: calc(100% - 28px); }
  .section{margin:1rem;padding:0.8rem;}
  .cta-button{padding:0.5rem 0.8rem;}
  .card-container { flex-direction: column; align-items:center;}
}
</style>
</head>
<body>

<div id="skyline"></div>

<!-- Hamburger menu -->
<div class="menu-btn" id="menuBtn">
  <div></div><div></div><div></div>
</div>
<nav class="side-nav" id="sideNav">
  <ul>
    <li><a href="index.html">Home</a></li>
    <li><a href="#">Safety</a>
      <ul>
        <li><a href="panic.html">Panic Button</a></li>
        <li><a href="emergency.html">Emergency Guides</a></li>
        <li><a href="spiking.html">Drink Spiking</a></li>
      </ul>
    </li>
    <li><a href="#">Drug Info</a>
      <ul>
        <li><a href="polydrug.html">Polydrug Tool</a></li>
        <li><a href="rx-combos.html">RX + Party Combos</a></li>
        <li><a href="health.html">Raver Health</a></li>
      </ul>
    </li>
    <li><a href="#">Consent</a>
      <ul>
        <li><a href="consent.html">Consent Basics</a></li>
        <li><a href="accountability.html">Accountability</a></li>
      </ul>
    </li>
    <li><a href="#">Local Scene</a>
      <ul>
        <li><a href="spotlight.html">Scene Spotlight</a></li>
        <li><a href="calendar.html">Event Calendar</a></li>
      </ul>
    </li>
    <li><a href="#">Extras</a>
      <ul>
        <li><a href="seasonal.html">Seasonal Tips</a></li>
        <li><a href="sober.html">Sober Ravers</a></li>
        <li><a href="resources.html">MN Resources</a></li>
      </ul>
    </li>
  </ul>
</nav>

<!-- Scroll alert -->
<div class="rave-alert-wrapper">
  <a href="/mixes.html" class="rave-alert-link">
    üö® MN Drug Supply Alert: Gray Death circulating ‚Ä¢ Fake K = fentanyl + xylazine ‚Ä¢ Test before you trust ‚Ä¢ Carry Narcan ‚Ä¢ No solo dosing ‚Ä¢ Click for full info üñ§
  </a>
</div>

<!-- Site title -->
<div class="site-title">
  <h1>PLURderapolis</h1>
  <div class="tagline">Harm Reduction for Minnesota Ravers</div>
</div>

<!-- SEARCH - placed outside the nav so it won't appear inside the side menu -->
<div class="search-bar">
  <input type="text" id="searchInput" placeholder="Search the site..." autocomplete="off" />
  <button id="searchBtn" aria-label="Search">üîç</button>
  <div id="searchResults" role="listbox" aria-label="Search results"></div>
</div>

<!-- Sections -->
<div class="section">
  <h2>üí° What We Do</h2>
  <ul>
    <li>üíä Harm Reduction ‚Äî Narcan, test strips, interaction tools.</li>
    <li>üß† Mental Health & Crisis ‚Äî Peer support, Bad Trip Mode.</li>
    <li>üïäÔ∏è Consent & Culture ‚Äî Safer spaces, collective care.</li>
  </ul>
</div>

<div class="section">
  <h2>üîÄ Panic & Emergency Tools</h2>
  <div class="card-container">
    <div class="card">
      <h3>Panic Button</h3>
      <p>Immediate access to help in emergencies.</p>
      <a class="cta-button" href="panic.html">Go</a>
    </div>
    <div class="card">
      <h3>Emergency Guides</h3>
      <p>Step-by-step instructions for common crises.</p>
      <a class="cta-button" href="emergency.html">View</a>
    </div>
    <div class="card">
      <h3>Bad Trip Mode</h3>
      <p>Calming visuals & exercises to ride it out safely.</p>
      <a class="cta-button" href="badtrip.html" style="background-color:#ff6ec7; color:#1c0028;">Visit</a>
    </div>
  </div>
</div>

<div class="section">
  <h2>üîÄ Polydrug Interaction Tool</h2>
  <iframe src="polydrug.html" style="width:100%;height:400px;border:none;border-radius:8px;"></iframe>
  <a class="cta-button" href="polydrug.html">Open Full Tool</a>
</div>

<div class="section">
  <h2>üìö Resources</h2>
  <div class="card-container">
    <div class="card">
      <h3>MN Resources</h3>
      <p>Plan B, queer-friendly clinics, DV support, recovery help.</p>
      <a class="cta-button" href="resources.html">View</a>
    </div>
    <div class="card">
      <h3>Sober Ravers</h3>
      <p>Tips & support for enjoying the scene sober.</p>
      <a class="cta-button" href="sober.html">View</a>
    </div>
    <div class="card">
      <h3>Raver Health</h3>
      <p>Hydration, cooling, and drug safety tips.</p>
      <a class="cta-button" href="health.html">View</a>
    </div>
  </div>
</div>

<!-- Peach panic button -->
<div id="peachWrap">
  <a class="emoji-panic" id="panicButton" title="Emergency">üçë</a>
</div>

<!-- Footer -->
<footer>
  <hr/>
  <p>&copy; 2025 PLURderapolis ‚Äî Community Harm Reduction</p>
  <p>Your partners in shine ‚ú¶ <a href="mailto:plurderapolis@gmail.org" style="color:#00f7e0;">plurderapolis@gmail.org</a> | Instagram: <a href="https://www.instagram.com/plurderapolis" target="_blank" style="color:#00f7e0;">@plurderapolis</a></p>
  <p style="font-size:0.8rem;color:#ccc;">Disclaimer: PLURderapolis is a peer-run harm reduction resource for Minnesota ravers. The information provided is for educational purposes only and is not intended as medical or legal advice. Always consult with a qualified professional for concerns related to health, safety, or legal matters.</p>
  <ul>
    <li><a href="index.html">Home</a></li>
    <li><a href="panic.html">Panic</a></li>
    <li><a href="emergency.html">Emergency</a></li>
    <li><a href="polydrug.html">Polydrug</a></li>
    <li><a href="resources.html">Resources</a></li>
  </ul>
</footer>

<!-- Lunr.js -->
<script src="https://unpkg.com/lunr/lunr.js"></script>

<script>
// ----- UI: hamburger, nav toggles, panic button -----
const menuBtn = document.getElementById('menuBtn');
const sideNav = document.getElementById('sideNav');
menuBtn.addEventListener('click', () => {
  menuBtn.classList.toggle('active');
  sideNav.classList.toggle('active');
});
const navItems = document.querySelectorAll('.side-nav ul li');
navItems.forEach(item => {
  item.addEventListener('click', (e) => {
    // avoid toggling when clicking inner links
    if (e.target.tagName.toLowerCase() === 'a') return;
    item.classList.toggle('show');
  });
});

const peachBtn = document.getElementById('panicButton');
peachBtn.addEventListener('click', () => { window.location.href = "panic.html"; });

// ----- Full-text search (Lunr.js) -----

// Pages to index (adjust as you add/remove pages)
const pagesToIndex = [
  { id:"home",        title:"Home",                 url:"index.html" },
  { id:"panic",       title:"Panic Button",         url:"panic.html" },
  { id:"emergency",   title:"Emergency Guides",     url:"emergency.html" },
  { id:"spiking",     title:"Drink Spiking",        url:"spiking.html" },
  { id:"polydrug",    title:"Polydrug Tool",        url:"polydrug.html" },
  { id:"rx-combos",   title:"RX + Party Combos",    url:"rx-combos.html" },
  { id:"health",      title:"Raver Health",         url:"health.html" },
  { id:"consent",     title:"Consent Basics",       url:"consent.html" },
  { id:"account",     title:"Accountability",       url:"accountability.html" },
  { id:"spotlight",   title:"Scene Spotlight",      url:"spotlight.html" },
  { id:"calendar",    title:"Event Calendar",       url:"calendar.html" },
  { id:"seasonal",    title:"Seasonal Tips",        url:"seasonal.html" },
  { id:"sober",       title:"Sober Ravers",         url:"sober.html" },
  { id:"resources",   title:"MN Resources",         url:"resources.html" },
  { id:"badtrip",     title:"Bad Trip Mode",        url:"badtrip.html" },
  { id:"mixes",       title:"Mixes",                url:"mixes.html" }
];

let searchIndex = null;
const docsMap = new Map();

/** Strip tags & boilerplate for indexing */
function extractTextFromHTML(htmlString){
  const parser = new DOMParser();
  const doc = parser.parseFromString(htmlString, 'text/html');

  // remove non-content elements that pollute index
  ['script','style','nav','footer','header'].forEach(sel => {
    doc.querySelectorAll(sel).forEach(el => el.remove());
  });

  // prefer main/section if present
  const main = doc.querySelector('main') || doc.body;
  const text = (main.textContent || '').replace(/\s+/g,' ').trim();
  return text;
}

/** Build index by fetching all pages (same-origin). If fetch fails (local file://), fall back to indexing current DOM or title. */
async function buildSearchIndex(){
  const fetches = pagesToIndex.map(async p => {
    try {
      const res = await fetch(p.url, { cache: 'no-store' });
      if (!res.ok) throw new Error('HTTP ' + res.status);
      const html = await res.text();
      const content = extractTextFromHTML(html);
      const doc = { id: p.id, title: p.title, url: p.url, content };
      docsMap.set(p.id, doc);
      return doc;
    } catch (e) {
      // If it's the index page, use the current DOM content
      if (p.url === 'index.html' || p.url === window.location.pathname.split('/').pop()) {
        const fallbackContent = extractTextFromHTML(document.documentElement.outerHTML);
        const doc = { id: p.id, title: p.title, url: p.url, content: fallbackContent || p.title };
        docsMap.set(p.id, doc);
        return doc;
      }
      // otherwise fallback to indexing the page title (so it still surfaces)
      const fallback = { id: p.id, title: p.title, url: p.url, content: p.title };
      docsMap.set(p.id, fallback);
      return fallback;
    }
  });

  const docs = await Promise.all(fetches);

  searchIndex = lunr(function () {
    this.ref('id');
    this.field('title');
    this.field('content');

    docs.forEach(d => this.add(d));
  });
}

// Elements
const searchInput = document.getElementById('searchInput');
const searchBtn   = document.getElementById('searchBtn');
const resultsBox  = document.getElementById('searchResults');

// Debounce util
function debounce(fn, delay = 160){
  let t;
  return (...args) => { clearTimeout(t); t = setTimeout(() => fn(...args), delay); };
}

// build a snippet and highlight tokens
function makeSnippet(content, query){
  const q = (query || '').trim();
  if (!q) return '';
  const lc = content.toLowerCase();
  const tokens = q.toLowerCase().split(/\s+/).filter(Boolean);
  let pos = -1;
  for (const tok of tokens){
    pos = lc.indexOf(tok);
    if (pos !== -1) break;
  }
  if (pos === -1) pos = 0;
  const start = Math.max(0, pos - 60);
  const end = Math.min(content.length, pos + 140);
  let snippet = content.slice(start, end).trim();
  tokens.forEach(tok=>{
    const esc = tok.replace(/[.*+?^${}()|[\]\\]/g,'\\$&');
    const re = new RegExp(`(${esc})`, 'ig');
    snippet = snippet.replace(re, '<mark>$1</mark>');
  });
  if (start > 0) snippet = '‚Ä¶ ' + snippet;
  if (end < content.length) snippet += ' ‚Ä¶';
  return snippet;
}

function renderResults(items, query){
  resultsBox.innerHTML = '';
  const ul = document.createElement('ul');
  items.forEach(r => {
    const doc = docsMap.get(r.ref);
    const li = document.createElement('li');
    const title = document.createElement('div');
    title.className = 'result-title';
    title.textContent = doc.title;
    const snip = document.createElement('div');
    snip.className = 'result-snippet';
    snip.innerHTML = makeSnippet(doc.content || '', query);
    li.appendChild(title);
    li.appendChild(snip);
    li.onclick = () => { window.location.href = doc.url; };
    ul.appendChild(li);
  });
  resultsBox.appendChild(ul);
  resultsBox.style.display = 'block';
}

/** Main search handler (lazy builds index on first use) */
async function performSearch(){
  const query = (searchInput.value || '').trim();
  if (!query) {
    resultsBox.style.display = 'none';
    resultsBox.innerHTML = '';
    return;
  }

  if (!searchIndex) {
    resultsBox.style.display = 'block';
    resultsBox.innerHTML = "<p style='padding:8px;'>Building search index‚Ä¶</p>";
    await buildSearchIndex();
  }

  // try exact tokens with wildcard
  let results = [];
  try { results = searchIndex.search(query + '*'); } catch (e) { /* ignore */ }

  // loosen search if no results
  if (!results.length) {
    // try fuzzy / proximity if single term or try each token
    const tokens = query.split(/\s+/).filter(Boolean);
    try {
      if (tokens.length === 1) {
        results = searchIndex.search(query + '~1');
      } else {
        // combine tokens with AND to favor pages containing all words
        const combined = tokens.map(t => t + '*').join(' ');
        results = searchIndex.search(combined);
      }
    } catch (e) {
      // fallback: empty
      results = [];
    }
  }

  if (results.length) {
    renderResults(results.slice(0, 12), query);
  } else {
    resultsBox.style.display = 'block';
    resultsBox.innerHTML = "<p style='padding:8px;'>No results found</p>";
  }
}

const debouncedSearch = debounce(performSearch, 120);
searchInput.addEventListener('input', debouncedSearch);
searchBtn.addEventListener('click', performSearch);

// Hide results when clicking outside
document.addEventListener('click', (e) => {
  const bar = document.querySelector('.search-bar');
  if (!bar.contains(e.target)) {
    resultsBox.style.display = 'none';
  }
});

// Enter key -> go to top match
searchInput.addEventListener('keydown', async (e) => {
  if (e.key === 'Enter') {
    e.preventDefault();
    if (!searchIndex) await buildSearchIndex();
    const q = (searchInput.value || '').trim();
    if (!q) return;
    let results = [];
    try { results = searchIndex.search(q + '*'); } catch (_) {}
    if (!results.length) {
      try { results = searchIndex.search(q + '~1'); } catch (_) {}
    }
    if (results.length) {
      const top = docsMap.get(results[0].ref);
      if (top) window.location.href = top.url;
    }
  }
});
</script>

</body>
</html>
