<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Symptom Detective | PLURderapolis</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Comic+Neue:wght@400;700&display=swap">
    <!-- Animate.css for pre-built animations -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
    <style>
        :root {
            /* Enhanced PLURderapolis Color Palette */
            --plur-peace: #6A8DE0;      /* Soft Blue */
            --plur-love: #FF6BCB;       /* Vibrant Pink */
            --plur-unity: #7B68EE;      /* Unity Plum */
            --plur-respect: #6FCF97;    /* Respect Green */
            --plur-dark: #1A1A2E;       /* Deep Space */
            --plur-card: #2D2B55;       /* Card Background */
            --plur-light: #F0F4FF;      /* Soft Text */
            --plur-muted: #A0A0C0;      /* Muted Text */

            --bg: var(--plur-dark);
            --fg: var(--plur-light);
            --plum: var(--plur-unity);
            --accent: var(--plur-love);
            --card: var(--plur-card);
            --muted: var(--plur-muted);
            --success: var(--plur-respect);
            --warning: #FFB347;
            --danger: #FF8A8A;
            --pulse: var(--plur-love);
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Inter', system-ui, -apple-system, 'Segoe UI', Roboto, Arial, sans-serif;
            background: var(--bg);
            color: var(--fg);
            line-height: 1.5;
            padding: 16px;
            min-height: 100vh;
            position: relative;
            overflow-x: hidden;
        }

        /* PLUR-themed Animated Background */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: 
                radial-gradient(circle at 10% 20%, rgba(106, 141, 224, 0.15) 0%, transparent 20%),
                radial-gradient(circle at 90% 80%, rgba(255, 107, 203, 0.1) 0%, transparent 20%),
                radial-gradient(circle at 50% 50%, rgba(111, 207, 151, 0.05) 0%, transparent 30%);
            pointer-events: none;
            z-index: -1;
        }

        .plur-particle {
            position: fixed;
            border-radius: 50%;
            background: var(--plur-love);
            opacity: 0.3;
            animation: float-particle 20s infinite linear;
            z-index: -1;
        }

        .plur-particle:nth-child(odd) {
            background: var(--plur-peace);
        }
        .plur-particle:nth-child(3n) {
            background: var(--plur-respect);
        }

        #plur-game {
            max-width: 760px;
            margin: 0 auto;
        }

        .pg-header {
            display: flex;
            gap: 16px;
            align-items: center;
            margin-bottom: 20px;
            padding: 20px;
            background: rgba(45, 43, 85, 0.85);
            border-radius: 20px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(123, 104, 238, 0.4);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
            position: relative;
            overflow: hidden;
        }

        .pg-header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: linear-gradient(90deg, var(--plur-peace), var(--plur-love), var(--plur-unity), var(--plur-respect));
            background-size: 200% 100%;
            animation: shimmer 3s infinite linear;
        }

        .pg-logo {
            width: 70px;
            height: 70px;
            border-radius: 18px;
            background: linear-gradient(135deg, var(--plur-unity), var(--plur-love));
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 900;
            font-size: 28px;
            color: white;
            box-shadow: 0 6px 20px rgba(123, 104, 238, 0.4);
            animation: pulse-plur 3s infinite;
            font-family: 'Comic Neue', cursive;
            position: relative;
        }

        .pg-logo::after {
            content: 'üîç';
            position: absolute;
            bottom: -5px;
            right: -5px;
            font-size: 20px;
            background: white;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            animation: bounce 2s infinite;
        }

        .pg-title {
            font-weight: 800;
            font-size: 22px;
            background: linear-gradient(to right, var(--plur-peace), var(--plur-love), var(--plur-unity));
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            font-family: 'Comic Neue', cursive;
        }

        .pg-subtitle {
            font-size: 14px;
            color: var(--muted);
            margin-top: 6px;
        }

        .card {
            background: var(--card);
            padding: 24px;
            border-radius: 20px;
            margin: 20px 0;
            border: 1px solid rgba(123, 104, 238, 0.3);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
            transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275), box-shadow 0.4s ease;
            position: relative;
            overflow: hidden;
        }

        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: linear-gradient(90deg, var(--plur-peace), var(--plur-love), var(--plur-unity));
            transform: scaleX(0);
            transform-origin: left;
            transition: transform 0.5s ease;
        }

        .card:hover::before {
            transform: scaleX(1);
        }

        .card:hover {
            transform: translateY(-5px) scale(1.01);
            box-shadow: 0 12px 30px rgba(0, 0, 0, 0.25);
        }

        .question {
            font-weight: 700;
            color: var(--plur-unity);
            font-size: 20px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 12px;
            font-family: 'Comic Neue', cursive;
        }

        .question-icon {
            font-size: 28px;
        }

        .options-container {
            display: flex;
            flex-direction: column;
            gap: 14px;
        }

        .opt {
            display: flex;
            align-items: center;
            gap: 14px;
            background: linear-gradient(to right, #1E1E3F, #252450);
            padding: 18px;
            border-radius: 16px;
            border: 1px solid #3A3A5D;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            position: relative;
            overflow: hidden;
        }

        .opt::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(123, 104, 238, 0.3), transparent);
            transition: left 0.7s;
        }

        .opt:hover::before {
            left: 100%;
        }

        .opt:hover {
            border-color: var(--plur-unity);
            transform: translateX(8px) scale(1.02);
            box-shadow: 0 5px 15px rgba(123, 104, 238, 0.2);
        }

        .opt:active {
            transform: scale(0.98);
        }

        .opt-icon {
            font-size: 24px;
            width: 30px;
            text-align: center;
            transition: transform 0.3s ease;
        }

        .opt:hover .opt-icon {
            transform: scale(1.2);
        }

        .opt-text {
            flex: 1;
            font-size: 16px;
        }

        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            padding: 14px 24px;
            border-radius: 16px;
            border: 0;
            background: linear-gradient(135deg, var(--plur-unity), var(--plur-love));
            color: white;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            box-shadow: 0 6px 15px rgba(123, 104, 238, 0.4);
            font-size: 16px;
            position: relative;
            overflow: hidden;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }

        .btn:hover::before {
            left: 100%;
        }

        .btn:hover {
            transform: translateY(-3px) scale(1.05);
            box-shadow: 0 8px 20px rgba(123, 104, 238, 0.5);
        }

        .btn:active {
            transform: translateY(0);
        }

        .result-title {
            font-size: 26px;
            font-weight: 800;
            margin-bottom: 16px;
            background: linear-gradient(to right, var(--plur-peace), var(--plur-love), var(--plur-unity), var(--plur-respect));
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            font-family: 'Comic Neue', cursive;
            text-align: center;
            animation: colorShift 4s infinite alternate;
        }

        .chip {
            display: flex;
            align-items: center;
            gap: 8px;
            background: #1E1E3F;
            padding: 12px 16px;
            border-radius: 24px;
            border: 1px solid #3A3A5D;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        .chip:hover {
            transform: scale(1.08);
            border-color: var(--plur-unity);
            box-shadow: 0 4px 10px rgba(123, 104, 238, 0.3);
        }

        .chip.selected {
            background: linear-gradient(135deg, var(--plur-unity), var(--plur-love));
            color: white;
            border-color: var(--plur-love);
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(123, 104, 238, 0.4);
        }

        .emergency-alert {
            animation: pulseEmergency 1.5s infinite, shake 0.5s ease-in-out;
            border: 2px solid var(--danger);
            background: rgba(255, 138, 138, 0.15);
        }

        .progress-container {
            width: 100%;
            height: 8px;
            background: #1E1E3F;
            border-radius: 4px;
            margin: 20px 0;
            overflow: hidden;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.2);
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--plur-peace), var(--plur-love), var(--plur-unity), var(--plur-respect));
            border-radius: 4px;
            transition: width 0.7s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            width: 0%;
            position: relative;
            overflow: hidden;
        }

        .progress-bar::after {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
            animation: shimmer 2s infinite;
        }

        /* PLUR Mascot */
        .plur-mascot {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, var(--plur-unity), var(--plur-love));
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 40px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            cursor: pointer;
            z-index: 100;
            transition: transform 0.3s ease;
            animation: bounce 3s infinite;
        }

        .plur-mascot:hover {
            transform: scale(1.1);
        }

        /* Celebration animation */
        .plur-celebration {
            position: fixed;
            width: 10px;
            height: 10px;
            background: var(--plur-love);
            opacity: 0;
            z-index: 1000;
            border-radius: 50%;
        }

        .plur-celebration:nth-child(odd) {
            background: var(--plur-peace);
        }
        .plur-celebration:nth-child(3n) {
            background: var(--plur-respect);
        }

        /* Enhanced Animations */
        @keyframes pulse-plur {
            0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(123, 104, 238, 0.7); }
            50% { transform: scale(1.05); }
            70% { box-shadow: 0 0 0 15px rgba(123, 104, 238, 0); }
            100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(123, 104, 238, 0); }
        }

        @keyframes float-particle {
            0% { transform: translateY(0) rotate(0deg); }
            50% { transform: translateY(-20px) rotate(180deg); }
            100% { transform: translateY(0) rotate(360deg); }
        }

        @keyframes shimmer {
            0% { background-position: -200% 0; }
            100% { background-position: 200% 0; }
        }

        @keyframes colorShift {
            0% { filter: hue-rotate(0deg); }
            100% { filter: hue-rotate(30deg); }
        }

        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
            40% { transform: translateY(-8px); }
            60% { transform: translateY(-4px); }
        }

        @keyframes pulseEmergency {
            0% { box-shadow: 0 0 0 0 rgba(255, 138, 138, 0.7); }
            70% { box-shadow: 0 0 0 15px rgba(255, 138, 138, 0); }
            100% { box-shadow: 0 0 0 0 rgba(255, 138, 138, 0); }
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
            20%, 40%, 60%, 80% { transform: translateX(5px); }
        }

        @keyframes celebrate {
            0% { transform: translateY(0) scale(1); opacity: 1; }
            100% { transform: translateY(-100px) scale(0); opacity: 0; }
        }

        .bounce {
            animation: bounce 0.6s;
        }

        /* Staggered animation for options */
        .opt.stagger-item {
            opacity: 0;
            transform: translateY(20px);
        }

        @media (max-width: 600px) {
            .plur-mascot {
                width: 60px;
                height: 60px;
                font-size: 30px;
                bottom: 10px;
                right: 10px;
            }
            
            .pg-header {
                flex-direction: column;
                text-align: center;
                gap: 12px;
            }
        }
    </style>
</head>
<body>
    <!-- PLUR-themed Background Particles -->
    <div class="plur-particle" style="top: 10%; left: 5%; width: 15px; height: 15px; animation-delay: 0s;"></div>
    <div class="plur-particle" style="top: 20%; left: 10%; width: 10px; height: 10px; animation-delay: 2s;"></div>
    <div class="plur-particle" style="top: 70%; left: 80%; width: 12px; height: 12px; animation-delay: 5s;"></div>
    <div class="plur-particle" style="top: 40%; left: 90%; width: 8px; height: 8px; animation-delay: 7s;"></div>
    <div class="plur-particle" style="top: 80%; left: 15%; width: 14px; height: 14px; animation-delay: 10s;"></div>
    
    <!-- PLUR Mascot -->
    <div class="plur-mascot" onclick="plurCelebrate()">‚ù§Ô∏è</div>
    
    <div id="plur-game">
        <div class="pg-header animate__animated animate__fadeInDown">
            <div class="pg-logo">PL</div>
            <div>
                <div class="pg-title">Symptom Detective ‚Äî Quick Triage Game</div>
                <div class="pg-subtitle">Tap through 6-10 fast questions. If at any time the person is not breathing or unresponsive ‚Äî CALL 911.</div>
            </div>
        </div>

        <div class="progress-container">
            <div class="progress-bar" id="progress-bar"></div>
        </div>

        <div class="card animate__animated" id="screen"></div>

        <div class="legal-disclaimer">
            <strong>Disclaimer:</strong> This tool is for informational purposes only and is not a substitute for professional medical advice, diagnosis, or treatment. Always seek the advice of qualified health providers with any questions you may have regarding a medical condition. In case of emergency, call 911 immediately.
        </div>

        <div class="foot-note" id="foot-note" style="display:none">
            <strong>Sources:</strong> CDC naloxone & overdose guidance; Hunter criteria for serotonin syndrome; CDC/NIOSH heat guidance; NIAAA/Mayo Clinic on alcohol poisoning; Poison Help (1-800-222-1222). Use as field guidance ‚Äî not a substitute for EMS.
        </div>
    </div>

    <script>
        /* PLURderapolis Symptom Detective - Enhanced Branding & Animations */
        (function(){
            const screen = document.getElementById('screen');
            const foot = document.getElementById('foot-note');
            const progressBar = document.getElementById('progress-bar');
            
            // Question flow with progress tracking
            const questionFlow = [
                'start',
                'conscious',
                'breathing',
                'pupils',
                'temp',
                'signs',
                'result'
            ];
            
            let currentQuestionIndex = 0;

            // state
            const state = {
                flags: {},
                score: {opioid:0, stimulant:0, alcohol:0, serotonin:0, heat:0, dehydration:0, benzo:0},
                path: []
            };

            // Create PLUR background particles
            function createParticles() {
                const container = document.body;
                for (let i = 0; i < 15; i++) {
                    const particle = document.createElement('div');
                    particle.className = 'plur-particle';
                    const size = Math.random() * 10 + 5;
                    const posX = Math.random() * 100;
                    const posY = Math.random() * 100;
                    const delay = Math.random() * 15;
                    
                    particle.style.width = `${size}px`;
                    particle.style.height = `${size}px`;
                    particle.style.top = `${posY}%`;
                    particle.style.left = `${posX}%`;
                    particle.style.animationDelay = `${delay}s`;
                    particle.style.animationDuration = `${15 + Math.random() * 15}s`;
                    
                    container.appendChild(particle);
                }
            }

            // Update progress bar
            function updateProgress() {
                const progress = (currentQuestionIndex / (questionFlow.length - 1)) * 100;
                progressBar.style.width = `${progress}%`;
            }

            // utility: render html with animation
            function render(html, animation = 'animate__fadeIn'){ 
                screen.style.opacity = 0;
                setTimeout(() => {
                    screen.innerHTML = html;
                    screen.className = `card animate__animated ${animation}`;
                    screen.style.opacity = 1;
                    
                    // Add staggered animation to options
                    setTimeout(() => {
                        const options = screen.querySelectorAll('.opt, .chip');
                        options.forEach((opt, index) => {
                            opt.classList.add('stagger-item');
                            setTimeout(() => {
                                opt.style.opacity = 1;
                                opt.style.transform = 'translateY(0)';
                                opt.style.transition = 'opacity 0.5s ease, transform 0.5s ease';
                            }, index * 100);
                        });
                    }, 50);
                    
                    window.scrollTo({top:0,behavior:'smooth'});
                }, 300);
            }

            // PLUR Celebration
            window.plurCelebrate = function() {
                const colors = ['var(--plur-love)', 'var(--plur-peace)', 'var(--plur-unity)', 'var(--plur-respect)'];
                for (let i = 0; i < 30; i++) {
                    const celeb = document.createElement('div');
                    celeb.className = 'plur-celebration';
                    celeb.style.left = Math.random() * 100 + 'vw';
                    celeb.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                    celeb.style.animation = `celebrate ${Math.random() * 1 + 0.5}s ease-out forwards`;
                    document.body.appendChild(celeb);
                    
                    setTimeout(() => {
                        if (document.body.contains(celeb)) {
                            document.body.removeChild(celeb);
                        }
                    }, 1500);
                }
            };

            // emergency screen
            function emergencyView(reason){
                render(`<div class="question emergency-alert">
                    <span class="question-icon">üö®</span>
                    EMERGENCY ‚Äî CALL 911
                </div>
                <div style="margin-top:20px; font-size: 16px;">${reason}</div>
                <div style="margin-top:24px;">
                    <strong>Immediate actions</strong>
                    <ul style="margin-top:12px; padding-left:24px;">
                        <li>Call 911 now (one-tap on mobile from your phone).</li>
                        <li>If breathing is <strong>very slow</strong> or <strong>stopped</strong> ‚Äî start rescue breaths/CPR if trained.</li>
                        <li>If opioid suspected ‚Äî give naloxone (intranasal/IM) immediately; repeat per instructions.</li>
                        <li>If vomiting and unconscious ‚Äî put on side (recovery position) to protect airway unless spinal injury suspected.</li>
                    </ul>
                </div>
                <div style="margin-top:24px;">
                    <button class="btn" onclick="window.location.reload()">
                        <span class="opt-icon">üîÑ</span> Start Over
                    </button>
                </div>`, 'animate__headShake');
                foot.style.display='block';
                currentQuestionIndex = questionFlow.length - 1;
                updateProgress();
            }

            // start screen
            function start(){
                currentQuestionIndex = 0;
                updateProgress();
                render(`<div class="question">
                    <span class="question-icon">üîç</span>
                    Ready to play detective?
                </div>
                <div class="small" style="margin-bottom: 24px;">Answer the quick prompts ‚Äî it narrows down the most likely emergency and tells you exactly what to do.</div>
                <div class="options-container">
                    <div class="opt" onclick="next('conscious')">
                        <span class="opt-icon">üïµÔ∏è</span>
                        <span class="opt-text">Start Investigation</span>
                    </div>
                </div>`, 'animate__zoomIn');
                foot.style.display='none';
            }

            // branching screens
            function q_conscious(){
                currentQuestionIndex = 1;
                updateProgress();
                state.path.push('conscious');
                render(`<div class="question">
                    <span class="question-icon">üß†</span>
                    Is the person awake / responding?
                </div>
                <div class="options-container">
                    <div class="opt" onclick="pick('awake')">
                        <span class="opt-icon">‚úÖ</span>
                        <span class="opt-text">Yes ‚Äî awake & responsive</span>
                    </div>
                    <div class="opt" onclick="pick('slow')">
                        <span class="opt-icon">üò¥</span>
                        <span class="opt-text">Very drowsy / slow to respond</span>
                    </div>
                    <div class="opt" onclick="pick('unresponsive')">
                        <span class="opt-icon">üö´</span>
                        <span class="opt-text">Unresponsive / can't wake</span>
                    </div>
                </div>
                <div class="small" style="margin-top:16px">If unresponsive ‚Äî this is an emergency.</div>`, 'animate__fadeInUp');
            }

            function q_breathing(){
                currentQuestionIndex = 2;
                updateProgress();
                state.path.push('breathing');
                render(`<div class="question">
                    <span class="question-icon">üå¨Ô∏è</span>
                    How is their breathing?
                </div>
                <div class="options-container">
                    <div class="opt" onclick="pick('breath_normal')">
                        <span class="opt-icon">üòä</span>
                        <span class="opt-text">Normal</span>
                    </div>
                    <div class="opt" onclick="showRR()">
                        <span class="opt-icon">üî¢</span>
                        <span class="opt-text">Count breaths / enter number</span>
                    </div>
                    <div class="opt" onclick="pick('breath_gasp')">
                        <span class="opt-icon">üò´</span>
                        <span class="opt-text">Gasping, very slow, or irregular</span>
                    </div>
                </div>
                <div class="small" style="margin-top:16px">If breathing is &lt;8 breaths/min or gasping ‚Üí emergency.</div>`, 'animate__fadeInUp');
            }

            function showRR(){
                render(`<div class="question">
                    <span class="question-icon">‚è±Ô∏è</span>
                    Count breaths for 15 seconds, then multiply by 4
                </div>
                <div style="margin-top:16px">
                    <input id="rr" type="number" placeholder="Enter breaths per minute (e.g. 6 or 16)" min="0" />
                </div>
                <div style="display:flex; gap:12px; margin-top:20px">
                    <button class="btn" onclick="submitRR()">
                        <span class="opt-icon">üì§</span> Submit
                    </button>
                    <div class="opt" onclick="pick('breath_gasp')">
                        <span class="opt-icon">‚ùì</span>
                        <span class="opt-text">Can't count / gasping</span>
                    </div>
                </div>
                <div class="small" style="margin-top:16px">If &lt;8 ‚Üí emergency. If unsure, choose "Can't count / gasping".</div>`, 'animate__flipInX');
            }

            window.submitRR = function(){
                const rr = Number(document.getElementById('rr').value);
                if(!rr && rr !== 0){ 
                    alert('Enter a number or choose "Can\'t count / gasping"'); 
                    return; 
                }
                state.flags.rr = rr;
                if(rr < 8){ 
                    emergencyView('Breathing is less than 8 breaths per minute ‚Äî life-threatening.'); 
                    return; 
                }
                pick('breath_normal');
            };

            function q_pupils(){
                currentQuestionIndex = 3;
                updateProgress();
                state.path.push('pupils');
                render(`<div class="question">
                    <span class="question-icon">üëÅÔ∏è</span>
                    How do the pupils look?
                </div>
                <div class="options-container">
                    <div class="opt" onclick="pick('pup_pin')">
                        <span class="opt-icon">‚óè</span>
                        <span class="opt-text">Pinpoint (very small)</span>
                    </div>
                    <div class="opt" onclick="pick('pup_dil')">
                        <span class="opt-icon">‚óã</span>
                        <span class="opt-text">Dilated / wide</span>
                    </div>
                    <div class="opt" onclick="pick('pup_norm')">
                        <span class="opt-icon">‚óé</span>
                        <span class="opt-text">Normal</span>
                    </div>
                </div>
                <div class="small" style="margin-top:16px">Pinpoint suggests opioids; dilated suggests stimulants/serotonin/other.</div>`, 'animate__fadeInUp');
            }

            function q_temp(){
                currentQuestionIndex = 4;
                updateProgress();
                state.path.push('temp');
                render(`<div class="question">
                    <span class="question-icon">üå°Ô∏è</span>
                    Do they show signs of overheating or cold/blue skin?
                </div>
                <div class="options-container">
                    <div class="opt" onclick="pick('hot_sweat')">
                        <span class="opt-icon">üî•</span>
                        <span class="opt-text">Overheated, very sweaty, or collapsed in hot area</span>
                    </div>
                    <div class="opt" onclick="pick('cold_blue')">
                        <span class="opt-icon">‚ùÑÔ∏è</span>
                        <span class="opt-text">Cold, pale, or bluish skin</span>
                    </div>
                    <div class="opt" onclick="pick('temp_normal')">
                        <span class="opt-icon">üòê</span>
                        <span class="opt-text">Neither / not sure</span>
                    </div>
                </div>
                <div class="small" style="margin-top:16px">Heat stroke often has very high temp + altered mental status. Cold/blue can indicate poor oxygenation (opioid/alcohol).</div>`, 'animate__fadeInUp');
            }

            function q_signs(){
                currentQuestionIndex = 5;
                updateProgress();
                state.path.push('signs');
                render(`<div class="question">
                    <span class="question-icon">üîé</span>
                    Which of these do you see? (tap all that apply)
                </div>
                <div class="chips-container" id="chips-container">
                    <div class="chip" data-key="pinpoint" onclick="toggleChip(this)">
                        <span class="chip-icon">üëÅ</span> Pinpoint pupils
                    </div>
                    <div class="chip" data-key="blue_lips" onclick="toggleChip(this)">
                        <span class="chip-icon">üíô</span> Blue lips / nails
                    </div>
                    <div class="chip" data-key="gurgle" onclick="toggleChip(this)">
                        <span class="chip-icon">üí§</span> Gurgling / snoring sounds
                    </div>
                    <div class="chip" data-key="limp" onclick="toggleChip(this)">
                        <span class="chip-icon">ü´†</span> Limp body / clammy or pale skin
                    </div>
                    <div class="chip" data-key="overheat" onclick="toggleChip(this)">
                        <span class="chip-icon">üå°</span> Overheating / hot
                    </div>
                    <div class="chip" data-key="agitation" onclick="toggleChip(this)">
                        <span class="chip-icon">ü§Ø</span> Agitation / confusion / hallucinations
                    </div>
                    <div class="chip" data-key="fast_hr" onclick="toggleChip(this)">
                        <span class="chip-icon">‚ù§Ô∏è‚Äçüî•</span> Fast heartbeat
                    </div>
                    <div class="chip" data-key="chest_pain" onclick="toggleChip(this)">
                        <span class="chip-icon">üíî</span> Chest pain
                    </div>
                    <div class="chip" data-key="seizure" onclick="toggleChip(this)">
                        <span class="chip-icon">‚ö°</span> Seizure / collapse
                    </div>
                    <div class="chip" data-key="vomit_uncon" onclick="toggleChip(this)">
                        <span class="chip-icon">ü§Æ</span> Vomiting while unconscious
                    </div>
                    <div class="chip" data-key="cold_skin" onclick="toggleChip(this)">
                        <span class="chip-icon">‚ùÑÔ∏è</span> Cold / bluish skin
                    </div>
                    <div class="chip" data-key="slurred" onclick="toggleChip(this)">
                        <span class="chip-icon">üó£</span> Slurred speech
                    </div>
                    <div class="chip" data-key="sleepy" onclick="toggleChip(this)">
                        <span class="chip-icon">üò¥</span> Extreme sleepiness / very drowsy
                    </div>
                </div>
                <div style="margin-top:24px">
                    <button class="btn" onclick="finalize()">
                        <span class="opt-icon">üî¨</span> Analyze ‚Äî show result
                    </button>
                </div>
                <div class="small" style="margin-top:16px">Tip: Tap multiple chips if you see several signs. If unsure, choose the closest option.</div>`, 'animate__zoomIn');
            }

            // toggle chip and visual feedback
            window.toggleChip = function(element){
                const key = element.getAttribute('data-key');
                state.flags[key] = !state.flags[key];
                element.classList.toggle('selected');
                
                // Add bounce animation
                element.classList.add('animate__animated', 'animate__pulse');
                setTimeout(() => {
                    element.classList.remove('animate__animated', 'animate__pulse');
                }, 1000);
            };

            // pick short-option handler
            window.pick = function(opt){
                // Add transition animation before proceeding
                screen.classList.add('animate__fadeOut');
                setTimeout(() => {
                    switch(opt){
                        case 'awake': state.flags.awake=true; q_breathing(); break;
                        case 'slow': state.flags.very_drowsy=true; q_breathing(); break;
                        case 'unresponsive': state.flags.unresponsive=true; emergencyView('Unresponsive / cannot be woken.'); break;
                        case 'breath_normal': state.flags.breath_normal=true; q_pupils(); break;
                        case 'breath_gasp': emergencyView('Gasping, very slow, or irregular breathing ‚Äî life-threatening.'); break;
                        case 'pup_pin': state.flags.pinpoint_pupils=true; q_temp(); break;
                        case 'pup_dil': state.flags.dilated_pupils=true; q_temp(); break;
                        case 'pup_norm': q_temp(); break;
                        case 'hot_sweat': state.flags.hot_env=true; q_signs(); break;
                        case 'cold_blue': state.flags.cold_blue=true; q_signs(); break;
                        case 'temp_normal': q_signs(); break;
                        case 'hot_temp': state.flags.hot_temp=true; q_signs(); break;
                    }
                }, 300);
            };

            // final logic engine ‚Äî patterns & emergency rules
            function finalize(){
                currentQuestionIndex = 6;
                updateProgress();
                
                // emergency rule: unresponsive or rr<8 or seizure + not breathing = 911
                if(state.flags.unresponsive){ emergencyView('Unresponsive ‚Äî call 911'); return; }
                if(state.flags.rr !== undefined && state.flags.rr < 8){ emergencyView('Very slow breathing (<8/min) ‚Äî call 911'); return; }

                // map the specific chips (user-facing names to engine flags)
                const f = state.flags;

                // Score heuristics (weights tuned to be conservative)
                if(f.pinpoint_pupils || f.pinpoint) state.score.opioid += 3;
                if(f.gurgle) state.score.opioid += 2;
                if(f.limp || f.blue_lips || f.cold_blue) state.score.opioid += 2;
                if(f.sleepy || state.flags.very_drowsy) state.score.opioid += 1;
                if(f.rr !== undefined && f.rr < 12) state.score.opioid += 2;

                if(f.overheat || f.hot_env || f.hot_temp) state.score.heat += 3;
                if(f.seizure) state.score.heat += 1;
                if(f.fast_hr) state.score.stimulant += 2;
                if(f.agitation) state.score.stimulant += 2;
                if(f.chest_pain) state.score.stimulant += 1;
                if(f.seizure) state.score.stimulant += 2;

                if(f.vomit_uncon || (f.sleepy && f.vomit_uncon) || (f.rr !== undefined && f.rr < 10 && f.sleepy)){
                    state.score.alcohol += 4;
                }

                if(f.slurred || f.sleepy) state.score.benzo += 2;

                // serotonin signals: dilated pupils + agitation + clonus/seizure (we approximate with seizure/twitch)
                if(f.dilated_pupils && f.agitation && (f.seizure || f.overheat || f.fast_hr)) state.score.serotonin += 3;

                // dehydration: repeated vomiting + high temp + lightheadedness (mapped from sleepy/limp)
                if(f.vomit_uncon && (f.hot_env || f.overheat || f.sleepy)) state.score.dehydration += 2;

                // Emergency hard-stop: seizure + unresponsive or prolonged seizure
                if(f.seizure && (f.unresponsive || f.sleepy)) { emergencyView('Seizure or repeated seizures ‚Äî call 911'); return; }

                // Now choose best score
                const sorted = Object.entries(state.score).sort((a,b) => b[1] - a[1]);
                const top = sorted[0];

                // If the top score is zero or too close, show "mixed/unclear"
                if(top[1] === 0 || (sorted[0][1] === sorted[1][1] && sorted[0][1] < 3)){
                    // fallback checks for clear signals: pinpoint+slow breathing => opioid
                    if((f.pinpoint_pupils || f.pinpoint) && (f.rr !== undefined && f.rr < 12 || f.gurgle || f.limp)) {
                        showResult('Likely opioid overdose', [
                            'Pinpoint pupils and depressed breathing / gurgling or limp body are classic opioid signs.'
                        ], ['Give naloxone if available (intranasal or IM) and call 911. Support breathing; recovery position if breathing but unconscious.']);
                        return;
                    }
                    showResult('Unclear / Mixed signs', ['Symptoms are mixed or not decisive.'], ['Stay with person, monitor breathing, call Poison Control (1-800-222-1222) or 911 if concerned.']);
                    return;
                }

                const winner = top[0];
                // Map winner to friendly output
                if(winner === 'opioid'){
                    showResult('Likely Opioid Overdose', [
                        f.pinpoint_pupils ? 'Pinpoint pupils' : null,
                        (f.rr !== undefined && f.rr < 12) ? `Slow breathing (${f.rr} breaths/min)` : null,
                        f.gurgle ? 'Gurgling/snoring sounds' : null,
                        f.limp ? 'Limp body / clammy or pale' : null
                    ].filter(Boolean), [
                        'Give naloxone immediately if available and follow device instructions. Repeat if no response per naloxone instructions.',
                        'Call 911. If breathing is absent or very slow, start rescue breaths/CPR if trained.',
                        'If breathing but unconscious, put in recovery position to protect airway.'
                    ]);
                    return;
                }

                if(winner === 'stimulant'){
                    showResult('Possible Stimulant Toxicity (MDMA / cocaine / meth)', [
                        f.overheat || f.hot_env ? 'Overheating or collapsed in hot area' : null,
                        f.fast_hr ? 'Fast heartbeat' : null,
                        f.agitation ? 'Agitation / confusion / hallucinations' : null,
                        f.seizure ? 'Seizure / collapse' : null
                    ].filter(Boolean), [
                        'Call 911 for severe agitation, chest pain, seizure, or hyperthermia.',
                        'Move to shade, cool with water, remove excess clothes, give sips of water if alert.',
                        'Do NOT give stimulants. EMS may use benzodiazepines to control severe agitation or seizures.'
                    ]);
                    return;
                }

                if(winner === 'heat'){
                    showResult('Possible Heat Stroke / Severe Heat Illness', [
                        'Overheated or collapsed in hot environment',
                        f.seizure ? 'Seizure' : null,
                        f.sleepy ? 'Drowsiness or confusion' : null
                    ].filter(Boolean), [
                        'Call 911 immediately for suspected heat stroke (especially if temp high or altered mental status).',
                        'Cool aggressively: wet towels, fanning, move to shade; give small sips if alert.',
                        'Do not give alcohol or sedatives.'
                    ]);
                    return;
                }

                if(winner === 'alcohol'){
                    showResult('Possible Alcohol Poisoning', [
                        f.vomit_uncon ? 'Vomiting while unconscious' : null,
                        f.cold_skin || f.cold_blue ? 'Cold / pale / bluish skin' : null,
                        (f.rr !== undefined && f.rr < 10) ? `Slow breathing (${f.rr} bpm)` : null
                    ].filter(Boolean), [
                        'Call 911 if unconscious, vomiting while drowsy, or breathing slowly/irregularly.',
                        'Protect airway: if vomiting and breathing, place on side (recovery position).',
                        'Do not leave them alone; monitor breathing continuously.'
                    ]);
                    return;
                }

                if(winner === 'serotonin'){
                    showResult('Possible Serotonin Syndrome', [
                        f.dilated_pupils ? 'Dilated pupils' : null,
                        f.agitation ? 'Agitation / confusion' : null,
                        f.seizure ? 'Seizure/tremor' : null,
                        f.overheat ? 'High temperature / overheating' : null
                    ].filter(Boolean), [
                        'Call 911 ‚Äî serotonin syndrome can progress rapidly and needs hospital care.',
                        'Cooling, IV fluids, and medication management (including benzodiazepines) may be needed.',
                        'Tell EMS about any recent MDMA, SSRIs, or serotonergic medications the person used.'
                    ]);
                    return;
                }

                if(winner === 'dehydration'){
                    showResult('Likely Severe Dehydration', [
                        f.vomit_uncon ? 'Repeated vomiting' : null,
                        f.hot_env ? 'Heat exposure' : null,
                        f.sleepy ? 'Weakness / drowsiness' : null
                    ].filter(Boolean), [
                        'If alert: give oral rehydration (electrolyte solution, small sips often).',
                        'If confused, very weak, or low urine output ‚Üí seek medical care or call 911.'
                    ]);
                    return;
                }

                if(winner === 'benzo'){
                    showResult('Possible Sedative / Benzodiazepine Effect', [
                        f.slurred ? 'Slurred speech' : null,
                        f.sleepy ? 'Very drowsy / heavy sleepiness' : null
                    ].filter(Boolean), [
                        'If unresponsive or breathing poorly ‚Üí call 911.',
                        'If responsive, keep them awake and sitting, monitor breathing; if mixed with opioids, naloxone may help for the opioid component.'
                    ]);
                    return;
                }

                // fallback
                showResult('Unclear / Mixed signs', ['Symptoms are mixed.'], ['Stay with person, monitor breathing, call Poison Control (1-800-222-1222) or 911 if worried.']);
            }

            // show final result with explanation and 911 script + copy button
            function showResult(title, clues, actions){
                plurCelebrate(); // Trigger PLUR celebration when showing results
                
                const cluesHtml = clues.length ? `<div style="margin-top:20px"><strong>Key clues:</strong><ul style="margin-top:12px; padding-left:24px;">${clues.map(c=>`<li>${c}</li>`).join('')}</ul></div>` : '';
                const actionsHtml = `<div style="margin-top:20px"><strong>What to do now:</strong><ul style="margin-top:12px; padding-left:24px;">${actions.map(a=>`<li>${a}</li>`).join('')}</ul></div>`;
                // build 911 script from state flags concisely
                const rrTxt = state.flags.rr !== undefined ? `${state.flags.rr} breaths/min` : (state.flags.breath_normal ? 'normal' : 'unknown');
                const signsList = Object.keys(state.flags).filter(k => state.flags[k] === true).join(', ') || 'none obvious';
                const script = `I need an ambulance. Person is ${state.flags.unresponsive ? 'unresponsive' : (state.flags.very_drowsy ? 'very drowsy' : 'responsive')}. Breathing: ${rrTxt}. Key signs: ${signsList}. Location: [your location].`;

                render(`<div class="result-title">${title}</div>
                    <div class="small" style="margin-top:12px">This is the tool's best match based on observed signs ‚Äî it's conservative: when in doubt call 911.</div>
                    ${cluesHtml}
                    ${actionsHtml}
                    <div style="margin-top:24px">
                        <div class="small"><strong>What to say to 911 (quick script):</strong></div>
                        <div style="background:#1E1E3F;padding:16px;border-radius:12px;margin-top:12px;color:var(--muted);font-size:14px; border-left: 4px solid var(--plur-unity);" id="script-box">${script}</div>
                        <div style="margin-top:20px;display:flex;gap:12px">
                            <button class="btn" onclick="copyScript()">
                                <span class="opt-icon">üìã</span> Copy 911 script
                            </button>
                            <div class="opt" onclick="start()">
                                <span class="opt-icon">üîÑ</span>
                                <span class="opt-text">Play Again</span>
                            </div>
                        </div>
                    </div>`, 'animate__zoomIn');
                foot.style.display='block';
            }

            window.copyScript = function(){
                const txt = document.getElementById('script-box').innerText;
                navigator.clipboard?.writeText(txt).then(()=>{
                    alert('911 script copied to clipboard ‚Äî paste into phone call or show to EMS.');
                }, ()=>alert('Unable to copy ‚Äî please long-press the script to copy manually.'));
            };

            // Initialize the app
            createParticles();
            start();

            // expose next to global so inline onclicks in HTML can call
            window.next = function(step){
                switch(step){
                    case 'conscious': q_conscious(); break;
                    default: start();
                }
            };
            window.pick = window.pick || function(){};
            window.finalize = finalize;
        })();
    </script>
</body>
</html>
