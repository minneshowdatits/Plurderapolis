<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<meta name="description" content="PLURderapolis Polydrug Interaction Checker - Harm reduction focused tool to check drug combination risks and safety tips.">
<meta name="keywords" content="polydrug, drug interactions, harm reduction, PLURderapolis, drug safety, risk assessment">
<title>Polydrug Risks & Interaction Checker | PLURderapolis</title>
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@600;800&family=Open+Sans:wght@400;600&display=swap" rel="stylesheet" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
  :root{
    --bg:#121212;
    --card:#1b0b1b;
    --ink:#eee;
    --muted:#bcbcbc;
    --accent:#bf00bf;
    --accent-2:#e051ff;
    --line:#440044;
    --chip:#550055;
    --shadow:0 0 12px rgba(191,0,191,.25);
    --danger:#ff4d4d;
    --caution:#ffb84d;
    --low-risk:#4dff88;
    --card-gradient: linear-gradient(135deg, #1b0b1b 0%, #2a0a2a 100%);
    --glow: 0 0 15px rgba(191, 0, 191, 0.5);
    --success-glow: 0 0 15px rgba(77, 255, 136, 0.3);
  }
  *{box-sizing:border-box}
  html,body{margin:0;padding:0;background:var(--bg);color:var(--ink);font-family:'Open Sans',system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; scroll-behavior: smooth;}
  a{color:var(--accent); text-decoration: none; transition: all 0.3s ease;}
  a:hover {color: var(--accent-2); text-shadow: 0 0 8px rgba(224, 81, 255, 0.5);}
  .wrap{max-width:1000px;margin:auto;padding:16px}
  h1,h2,h3{font-family:'Montserrat',sans-serif;letter-spacing:.2px}
  h1{font-size:clamp(1.8rem,3vw,2.5rem);color:var(--accent);margin:8px 0 6px; text-align: center; text-shadow: 0 0 10px rgba(191, 0, 191, 0.4);}
  p.lede{color:#f0d1ff;margin:.25rem 0 1rem; font-size: 1.1rem; text-align: center; line-height: 1.5;}
  
  /* Navigation */
  .navigation {display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 10px;}
  .nav-links {display: flex; gap: 15px; flex-wrap: wrap;}
  .nav-button {background: var(--chip); color: var(--ink); border: 1px solid var(--line); border-radius: 999px; padding: 8px 15px; font-weight: 700; cursor: pointer; transition: all 0.3s ease; display: flex; align-items: center; gap: 5px;}
  .nav-button:hover {background: var(--accent); transform: translateY(-2px); box-shadow: var(--glow);}
  
  /* Header branding */
  .branding{display:flex;align-items:center;gap:10px;margin-bottom:10px; justify-content: center; flex-direction: column; text-align: center;}
  .logo{font-size:2.5rem;font-weight:800;color:var(--accent);background:linear-gradient(45deg, var(--accent), var(--accent-2));-webkit-background-clip:text;-webkit-text-fill-color:transparent; animation: logoPulse 4s infinite ease-in-out; text-shadow: 0 0 15px rgba(191, 0, 191, 0.5); margin-bottom: 5px;}
  @keyframes logoPulse {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.05); }
  }
  .tagline{color:var(--muted);font-size:1rem; max-width: 500px; line-height: 1.4;}
  
  /* Top checker card */
  .tool{background:var(--card-gradient);border-radius:14px;padding:20px;box-shadow:var(--shadow);position:sticky;top:0.35rem;z-index:5; animation: fadeIn 0.8s ease-out; border: 1px solid var(--line); margin-bottom: 25px;}
  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
  }
  .tool h2{font-size:1.3rem;margin:.2rem 0 .6rem;color:var(--accent-2); text-align: center; display: flex; align-items: center; justify-content: center; gap: 10px;}
  .row{display:flex;gap:12px;flex-wrap:wrap}
  .sel{flex:1 1 180px;min-width:160px;display:flex;flex-direction:column;gap:6px}
  label{font-weight:700;color:var(--accent);font-size:.9rem; display: flex; align-items: center; gap: 5px;}
  select{width:100%;padding:.6rem .7rem;border:1px solid var(--line);border-radius:10px;background:#220022;color:var(--ink);appearance:none; transition: all 0.3s ease;}
  select:focus {outline: none; border-color: var(--accent-2); box-shadow: 0 0 0 2px rgba(224, 81, 255, 0.3);}
  button.primary{background:var(--accent);color:#fff;border:0;border-radius:10px;padding:.7rem 1rem;font-weight:800;cursor:pointer; transition: all 0.3s ease; position: relative; overflow: hidden;}
  button.primary:hover {background: var(--accent-2); transform: translateY(-2px); box-shadow: 0 4px 12px rgba(191, 0, 191, 0.4);}
  button.primary:active{transform:translateY(1px)}
  button.primary::after {content: ''; position: absolute; top: 50%; left: 50%; width: 5px; height: 5px; background: rgba(255, 255, 255, 0.5); opacity: 0; border-radius: 100%; transform: scale(1, 1) translate(-50%); transform-origin: 50% 50%;}
  button.primary:focus:not(:active)::after {animation: ripple 1s ease-out;}
  @keyframes ripple {0% {transform: scale(0, 0); opacity: 0.5;} 100% {transform: scale(20, 20); opacity: 0;}}
  .icons{font-size:1.05rem;opacity:.95; animation: iconGlow 2s infinite alternate;}
  @keyframes iconGlow {
    from { text-shadow: 0 0 5px rgba(191, 0, 191, 0.5); }
    to { text-shadow: 0 0 10px rgba(224, 81, 255, 0.8); }
  }
  .result{margin-top:20px;border:1px dashed var(--line);border-radius:12px;padding:15px;background:#170717; animation: slideIn 0.5s ease-out; max-height: 500px; overflow-y: auto;}
  @keyframes slideIn {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
  }
  .result h3{margin:.2rem 0 .4rem;color:#ffd6ff;font-size:1.2rem; text-align: center;}
  .pairs{margin:.4rem 0 0;padding-left:18px}
  .pair-detail{background:#1f001f;border-radius:8px;padding:15px;margin:12px 0;border-left:4px solid var(--accent); animation: fadeInUp 0.5s ease-out; box-shadow: 0 2px 8px rgba(0,0,0,0.2); position: relative;}
  @keyframes fadeInUp {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
  }
  .pair-detail.risk-low{border-left-color:var(--low-risk); box-shadow: 0 2px 8px rgba(77, 255, 136, 0.1);}
  .pair-detail.risk-caution{border-left-color:var(--caution); box-shadow: 0 2px 8px rgba(255, 184, 77, 0.1);}
  .pair-detail.risk-strong{border-left-color:var(--accent);}
  .pair-detail.risk-danger{border-left-color:var(--danger); box-shadow: 0 2px 8px rgba(255, 77, 77, 0.1);}
  .risk-icon {position: absolute; top: 15px; right: 15px; font-size: 1.5rem;}
  .legend{display:flex;gap:10px;flex-wrap:wrap;margin:15px 0 0;font-size:.95rem;color:var(--muted); justify-content: center;}
  .legend span{display:inline-flex;gap:6px;align-items:center;background:#200120;border:1px solid var(--line);border-radius:999px;padding:.4rem .8rem; transition: all 0.3s ease;}
  .legend span:hover {transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);}
  
  /* Success message styling */
  .success-message {background: rgba(77, 255, 136, 0.1); border: 1px solid var(--low-risk); border-radius: 12px; padding: 15px; margin: 15px 0; text-align: center; animation: pulseSuccess 2s infinite;}
  @keyframes pulseSuccess {
    0%, 100% { box-shadow: 0 0 5px rgba(77, 255, 136, 0.3); }
    50% { box-shadow: 0 0 15px rgba(77, 255, 136, 0.5); }
  }
  
  /* Matrix */
  .controls{display:flex;align-items:center;gap:15px;margin:20px 0 15px;flex-wrap:wrap; justify-content: center;}
  .download{background:var(--accent);color:#fff;border:0;border-radius:999px;padding:.7rem 1.2rem;font-weight:800;cursor:pointer; transition: all 0.3s ease; display: flex; align-items: center; gap: 8px;}
  .download:hover {background: var(--accent-2); transform: translateY(-2px); box-shadow: 0 4px 12px rgba(191, 0, 191, 0.4);}
  .share{background:#2a002a;color:#fff;border:1px solid var(--line);border-radius:999px;padding:.7rem 1.2rem;font-weight:700;cursor:pointer; transition: all 0.3s ease; display: flex; align-items: center; gap: 8px;}
  .share:hover {background: #3a003a; transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);}
  .matrix{overflow:auto;border-radius:12px;box-shadow:var(--shadow);border:1px solid var(--line);background:#160616; animation: fadeIn 0.8s ease-out 0.2s both; margin-bottom: 25px;}
  table{border-collapse:collapse;width:100%;min-width:980px;font-size:.92rem}
  th,td{border:1px solid var(--line);padding:.45rem .55rem;text-align:center;vertical-align:middle; transition: all 0.3s ease; position: relative;}
  thead th{position:sticky;top:0;background:#3b0a3b;color:#ffe5ff;z-index:2; box-shadow: 0 2px 5px rgba(0,0,0,0.2);}
  tbody th{position:sticky;left:0;background:#2a002a;color:#fff;z-index:1; box-shadow: 2px 0 5px rgba(0,0,0,0.2);}
  td{background:#1f001f; transition: all 0.3s ease; cursor: pointer;}
  td:hover {transform: scale(1.05); z-index: 3; box-shadow: 0 0 10px rgba(191, 0, 191, 0.5);}
  td.risk-low{background:#0a2a14}
  td.risk-caution{background:#2a200a}
  td.risk-strong{background:#2a0a2a}
  td.risk-danger{background:#2a0a0a}
  .chip {display:inline-block;background:var(--chip);border-radius:999px;padding:.18rem .55rem;font-weight:700; transition: all 0.3s ease;}
  .chip:hover {transform: scale(1.05); background: var(--accent);}
  
  /* Sections at bottom (accordion) */
  details.info{background:var(--card-gradient);border:1px solid var(--line);border-radius:12px;padding:.8rem 1rem;margin:.8rem 0; transition: all 0.3s ease; box-shadow: 0 2px 5px rgba(0,0,0,0.1);}
  details.info:hover {border-color: var(--accent); transform: translateY(-2px);}
  details.info summary{cursor:pointer;font-weight:800;list-style:none; transition: all 0.3s ease; display: flex; align-items: center; padding: 8px 0; font-size: 1.1rem;}
  details.info summary:hover {color: var(--accent-2);}
  details.info summary::marker, details.info summary::-webkit-details-marker{display:none}
  details.info summary .tag{margin-left:.5rem;opacity:.85; font-size: 0.8rem; background: var(--chip); padding: 2px 8px; border-radius: 10px;}
  details.info[open] {animation: accordionOpen 0.5s ease-out;}
  @keyframes accordionOpen {
    from { opacity: 0; max-height: 0; }
    to { opacity: 1; max-height: 500px; }
  }
  
  /* Back to top button */
  .back-to-top{position:fixed;bottom:20px;right:20px;background:var(--accent);color:#fff;border:0;border-radius:50%;width:50px;height:50px;font-size:1.5rem;cursor:pointer;box-shadow:var(--shadow);z-index:100;display:none; transition: all 0.3s ease;}
  .back-to-top:hover {background: var(--accent-2); transform: translateY(-3px) scale(1.1); box-shadow: 0 6px 15px rgba(191, 0, 191, 0.5);}
  
  /* Footer */
  footer{border-top:1px solid var(--line);color:var(--muted);font-size:.9rem;padding:18px;margin-top:16px;text-align:center; animation: fadeIn 0.8s ease-out 0.4s both;}
  .pill{display:inline-block;background:var(--chip);padding:.22rem .6rem;border-radius:999px;font-weight:800; transition: all 0.3s ease;}
  .pill:hover {transform: scale(1.05); background: var(--accent);}
  
  /* Mobile niceties */
  @media (max-width:640px){
    .tool{position:static}
    .legend{font-size:.9rem}
    table{font-size:.86rem;min-width:840px}
    .controls{flex-direction:column;align-items:flex-start}
    .navigation {flex-direction: column; align-items: flex-start;}
    .nav-links {margin-top: 10px;}
    .branding {flex-direction: column; align-items: flex-start; gap: 5px;}
    h1 {text-align: left;}
    p.lede {text-align: left;}
  }
  
  /* Save page modal */
  .save-modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.7);
    z-index: 1000;
    justify-content: center;
    align-items: center;
    animation: fadeIn 0.3s ease-out;
  }
  
  .save-modal-content {
    background: var(--card-gradient);
    border-radius: 12px;
    padding: 20px;
    max-width: 500px;
    width: 90%;
    box-shadow: var(--shadow);
    border: 1px solid var(--line);
    animation: slideIn 0.3s ease-out;
  }
  
  .save-modal h3 {
    margin-top: 0;
    color: var(--accent-2);
  }
  
  .save-options {
    display: flex;
    gap: 10px;
    margin: 15px 0;
    flex-wrap: wrap;
  }
  
  .save-option {
    flex: 1;
    min-width: 120px;
    background: var(--chip);
    border: 1px solid var(--line);
    border-radius: 8px;
    padding: 10px;
    text-align: center;
    cursor: pointer;
    transition: all 0.3s ease;
  }
  
  .save-option:hover {
    background: var(--accent);
    transform: translateY(-2px);
  }
  
  .modal-close {
    background: var(--accent);
    color: white;
    border: none;
    border-radius: 8px;
    padding: 8px 15px;
    cursor: pointer;
    transition: all 0.3s ease;
  }
  
  .modal-close:hover {
    background: var(--accent-2);
  }
  
  /* Mobile swipe indicators */
  .swipe-indicator {
    display: none;
    text-align: center;
    margin: 10px 0;
    color: var(--muted);
    font-size: 0.9rem;
    animation: pulse 2s infinite;
  }
  
  @keyframes pulse {
    0%, 100% { opacity: 0.7; }
    50% { opacity: 1; }
  }
  
  @media (max-width: 768px) {
    .swipe-indicator {
      display: block;
    }
  }
  
  /* Section headings */
  .section-heading {
    display: flex;
    align-items: center;
    gap: 10px;
    margin: 25px 0 15px;
    color: var(--accent-2);
    font-size: 1.4rem;
  }
  
  .section-heading::after {
    content: '';
    flex: 1;
    height: 2px;
    background: linear-gradient(90deg, var(--accent-2), transparent);
  }
</style>
</head>
<body>
  <div class="wrap">
    <!-- Navigation -->
    <div class="navigation">
      <button class="nav-button" id="backButton" onclick="history.back()"><i class="fas fa-arrow-left"></i> Back</button>
      <div class="nav-links">
        <a href="resources.html" class="nav-button"><i class="fas fa-book"></i> Resources</a>
        <a href="emergency.html" class="nav-button"><i class="fas fa-exclamation-triangle"></i> Emergency</a>
        <a href="spiking.html" class="nav-button"><i class="fas fa-skull-crossbones"></i> Spiking</a>
        <a href="fake.html" class="nav-button"><i class="fas fa-search"></i> Fake Drugs</a>
        <a href="rx-combos.html" class="nav-button"><i class="fas fa-prescription-bottle"></i> Rx Combos</a>
      </div>
    </div>
    
    <!-- PLURderapolis branding -->
    <div class="branding">
      <div class="logo">PLURderapolis</div>
      <div class="tagline">Harm Reduction & Community Safety - Empowering informed decisions through education and support</div>
    </div>
    
    <h1>Polydrug Interaction Checker <span class="icons">⚡💊💀🌈</span></h1>
    <p class="lede">Mobile-first, harm-reduction focused tool to check drug combination risks. Pick up to three substances and see detailed safety information. Matrix is downloadable + shareable.</p>

    <!-- ===== Interaction Checker (TOP) ===== -->
    <section class="tool" aria-label="Polydrug Interaction Checker">
      <h2><i class="fas fa-search-plus"></i> Quick Check</h2>
      <div class="row">
        <div class="sel">
          <label for="drugA"><i class="fas fa-pills"></i> Substance A</label>
          <select id="drugA"></select>
        </div>
        <div class="sel">
          <label for="drugB"><i class="fas fa-pills"></i> Substance B</label>
          <select id="drugB"></select>
        </div>
        <div class="sel">
          <label for="drugC"><i class="fas fa-pills"></i> Substance C (optional)</label>
          <select id="drugC"></select>
        </div>
        <div class="sel" style="align-self:flex-end">
          <button class="primary" id="checkBtn"><i class="fas fa-search"></i> Check <span class="icons">⚡</span></button>
        </div>
      </div>

      <div class="legend" aria-label="Legend">
        <span><b>🌈</b> Low concern / typical</span>
        <span><b>⚡</b> Caution</span>
        <span><b>💊</b> Strong caution / interaction risk</span>
        <span><b>💀</b> Dangerous / avoid</span>
      </div>

      <div class="result" id="resultBox" aria-live="polite">
        <h3><i class="fas fa-clipboard-list"></i> Results will appear here</h3>
        <p>We'll show A+B, A+C, B+C and a combined A+B+C overview with detailed harm-reduction pointers.</p>
        <div class="success-message">
          <p><i class="fas fa-heart"></i> <strong>Thank you for being proactive about your safety!</strong> Checking interactions is a responsible harm reduction practice.</p>
        </div>
      </div>
    </section>

    <!-- ===== Controls + Matrix ===== -->
    <div class="swipe-indicator">
      <i class="fas fa-arrows-left-right"></i> Swipe left/right to explore the full matrix
    </div>
    
    <div class="controls">
      <button class="download" id="savePageBtn"><i class="fas fa-download"></i> Save Page</button>
      <button class="share" id="shareBtn"><i class="fas fa-share-alt"></i> Share Page</button>
    </div>

    <div class="section-heading">
      <i class="fas fa-table"></i> Interaction Matrix
    </div>

    <div class="matrix" role="region" aria-label="Combo Risk Matrix">
      <table id="matrix"></table>
    </div>

    <!-- ===== Tips (quick) ===== -->
    <details class="info" open>
      <summary><i class="fas fa-lightbulb"></i> Harm Reduction Tips <span class="tag">(quick)</span></summary>
      <ul>
        <li><strong>Test what you can.</strong> Start low, go slow. Space redoses.</li>
        <li><span class="pill">Never stack depressants</span> (alcohol, benzos, GHB, opioids) — biggest driver of fatal ODs.</li>
        <li><strong>Heat + stimulants = risk.</strong> Cool environment, electrolyte sips, rest breaks.</li>
        <li><strong>Carry naloxone</strong> if opioids could be around. Don't use alone. Recovery position if someone is out.</li>
        <li><strong>On Rx meds?</strong> Avoid chasing "muted" effects by redosing — risk goes up even if euphoria doesn't.</li>
      </ul>
      <div class="success-message">
        <p><i class="fas fa-star"></i> <strong>Great job educating yourself!</strong> Knowledge is the first step toward safer practices.</p>
      </div>
    </details>

    <!-- ===== Category cards at bottom ===== -->
    <div class="section-heading">
      <i class="fas fa-layer-group"></i> Combo Categories
    </div>

    <details class="info"><summary><i class="fas fa-capsules"></i> Depressant × Depressant <span class="tag">benzodiazepines, alcohol, GHB, opioids, trazodone, gabapentin</span></summary>
      <p><b>Risk:</b> <b>💀</b> — synergistic respiratory depression, blackouts, aspiration.</p>
      <ul>
        <li>Keep people awake & breathing; recovery position if unresponsive.</li>
        <li>Naloxone reverses opioids (not benzos/GHB); still call EMS.</li>
      </ul>
      <div class="success-message">
        <p><i class="fas fa-shield-alt"></i> <strong>You're being smart by checking this!</strong> Depressant combinations are among the most dangerous.</p>
      </div>
    </details>

    <details class="info"><summary><i class="fas fa-bolt"></i> Stimulant × Stimulant <span class="tag">MDMA, cocaine, ADHD meds, bupropion</span></summary>
      <p><b>Risk:</b> <b>💊→💀</b> — hypertension, hyperthermia, arrhythmia, panic.</p>
      <ul>
        <li>Avoid stacking; cool down, hydrate, don't chase muted highs.</li>
      </ul>
    </details>

    <details class="info"><summary><i class="fas fa-balance-scale"></i> Stimulant × Depressant <span class="tag">e.g., cocaine+alcohol, MDMA+GHB</span></summary>
      <p><b>Risk:</b> <b>💊</b> — masking sedation, dehydration, liver stress (cocaethylene with alcohol+cocaine).</p>
      <ul>
        <li>Don't redose to "even it out". Watch breathing and heat load.</li>
      </ul>
    </details>

    <details class="info"><summary><i class="fas fa-cloud-sun"></i> Psychedelics with Cannabis</summary>
      <p>Can potentiate intensity/anxiety. Delay THC until past peak; micro-puffs if at all.</p>
      <div class="success-message">
        <p><i class="fas fa-leaf"></i> <strong>Smart thinking!</strong> Cannabis can significantly alter psychedelic experiences.</p>
      </div>
    </details>

    <details class="info"><summary><i class="fas fa-head-side-virus"></i> Dissociative × Depressant <span class="tag">ketamine/nitrous + alcohol/benzos/GHB</span></summary>
      <p>Hypoxia/airway risk + amnesia. Sit down, supervised, fresh air breaks.</p>
    </details>

    <!-- ===== Legal disclaimer (single) ===== -->
    <footer>
      <p><strong>Legal & Medical Disclaimer:</strong> Educational content only; not medical advice. No mix is 100% safe. Accuracy is prioritized using established harm-reduction resources (TripSit, DanceSafe, IMPACT SF, TheBody) plus your local notes, but contexts differ. If someone shows trouble breathing, severe chest pain, seizures, or won't wake, call emergency services.</p>
      <p>© 2025 PLURderapolis • <span class="pill">Stay safe. Stay kind.</span></p>
    </footer>
  </div>

  <!-- Save Page Modal -->
  <div class="save-modal" id="saveModal">
    <div class="save-modal-content">
      <h3><i class="fas fa-save"></i> Save Page</h3>
      <p>Choose how you'd like to save this information:</p>
      <div class="save-options">
        <div class="save-option" id="savePdf">
          <i class="fas fa-file-pdf"></i>
          <div>PDF</div>
        </div>
        <div class="save-option" id="saveHtml">
          <i class="fas fa-code"></i>
          <div>HTML</div>
        </div>
        <div class="save-option" id="saveImage">
          <i class="fas fa-image"></i>
          <div>Image</div>
        </div>
      </div>
      <button class="modal-close" id="closeModal">Close</button>
    </div>
  </div>

  <!-- Back to top button -->
  <button class="back-to-top" id="backToTop" aria-label="Back to top"><i class="fas fa-arrow-up"></i></button>

<script>
/* ============================================================
   DATA INGEST: Your original 20-substance matrix (as posted)
   Symbols: —, 🟢, 🟡, 🔴, ⚠️, ❌, ☠️
   We will translate to minimalist icons later.
============================================================ */
const originalHeaders = ["Cannabis","Ketamine","MDMA","Cocaine","Alcohol","GHB / Opioids","Benzos","SSRIs","SNRIs","ADHD Meds","Antipsychotics","Mood Stabilizers","Wellbutrin","Trazodone","Gabapentin","LSD","Shrooms","Nitrous","DMT","GHB"];
// NOTE: Your pasted table had 20 columns; the last header label you included row-wise was "GHB" again.
// We're trusting the body rows you posted below (they match 20-wide). The body:
const originalRows = [
  ["Cannabis","—","🟡","🔴","🔴","🔴","🔴","🔴","🟡","🟡","🟢","🟡","🟡","🟢","🟢","🟢","🔴","🔴","🟢","🔴","🔴"],
  ["Ketamine","🟡","—","❌","❌","❌","❌","🟡","🟡","🟡","🔴","🟡","🟡","🟡","🟡","🟡","❌","❌","🟡","❌","❌"],
  ["MDMA","🔴","❌","—","🔴","🔴","❌","🔴","🔴","❌","❌","❌","❌","❌","🔴","🔴","🔴","🔴","🔴","❌","❌"],
  ["Cocaine","🔴","❌","🔴","—","🔴","❌","🔴","🔴","❌","❌","🔴","🔴","🔴","🔴","🔴","🔴","🔴","🔴","❌","❌"],
  ["Alcohol","🔴","❌","🔴","🔴","—","❌","☠️","⚠️","⚠️","⚠️","⚠️","⚠️","❌","❌","❌","🔴","🔴","❌","❌","☠️"],
  ["GHB / Opioids","🔴","❌","❌","❌","☠️","—","☠️","⚠️","⚠️","⚠️","⚠️","⚠️","⚠️","⚠️","⚠️","❌","❌","⚠️","☠️","—"],
  ["Benzos","🔴","🟡","🔴","🔴","☠️","☠️","—","⚠️","⚠️","⚠️","⚠️","⚠️","⚠️","⚠️","⚠️","⚠️","⚠️","⚠️","☠️","⚠️"],
  ["SSRIs","🟡","🟡","🔴","🔴","⚠️","⚠️","⚠️","—","⚠️","⚠️","⚠️","⚠️","⚠️","⚠️","⚠️","⚠️","⚠️","⚠️","⚠️","⚠️"],
  ["SNRIs","🟡","🟡","❌","❌","⚠️","⚠️","⚠️","⚠️","—","⚠️","⚠️","⚠️","⚠️","⚠️","⚠️","⚠️","⚠️","⚠️","⚠️","⚠️"],
  ["ADHD Meds","🟢","🟡","❌","❌","⚠️","⚠️","⚠️","⚠️","⚠️","—","🟡","🟡","🟡","🟡","🟡","⚠️","⚠️","⚠️","⚠️","⚠️"],
  ["Antipsychotics","🟡","🟡","❌","🔴","⚠️","⚠️","⚠️","⚠️","⚠️","🟡","—","🟡","🟡","🟡","🟡","⚠️","⚠️","⚠️","⚠️","⚠️"],
  ["Mood Stabilizers","🟡","🟡","❌","🔴","⚠️","⚠️","⚠️","⚠️","⚠️","🟡","🟡","—","🟡","🟡","🟡","⚠️","⚠️","⚠️","⚠️","⚠️"],
  ["Wellbutrin","🟢","🟡","❌","🔴","❌","⚠️","⚠️","⚠️","⚠️","🟡","🟡","🟡","—","🟡","🟡","⚠️","⚠️","⚠️","⚠️","⚠️"],
  ["Trazodone","🟢","🟡","🔴","🔴","❌","⚠️","⚠️","⚠️","⚠️","🟡","🟡","🟡","🟡","—","🟢","⚠️","⚠️","⚠️","⚠️","⚠️"],
  ["Gabapentin","🟢","🟡","🔴","🔴","❌","⚠️","⚠️","⚠️","⚠️","🟡","🟡","🟡","🟡","🟢","—","⚠️","⚠️","⚠️","⚠️","⚠️"],
  ["LSD","🔴","🟡","🔴","🔴","🔴","❌","⚠️","⚠️","⚠️","⚠️","⚠️","⚠️","⚠️","⚠️","⚠️","—","🟢","🟡","🟡","🔴"],
  ["Shrooms","🔴","❌","🔴","🔴","🔴","❌","⚠️","⚠️","⚠️","⚠️","⚠️","⚠️","⚠️","🟢","⚠️","🟢","—","🟡","🟡","🔴"],
  ["Nitrous","🟢","🟡","🔴","🔴","❌","⚠️","⚠️","⚠️","⚠️","⚠️","⚠️","⚠️","⚠️","⚠️","⚠️","🟡","🟡","—","⚠️","⚠️"],
  ["DMT","🔴","❌","❌","❌","❌","☠️","⚠️","⚠️","⚠️","⚠️","⚠️","⚠️","⚠️","⚠️","⚠️","🔴","🔴","⚠️","—","☠️"],
  ["GHB","🔴","❌","❌","☠️","☠️","—","☠️","⚠️","⚠️","⚠️","⚠️","⚠️","⚠️","⚠️","⚠️","🔴","🔴","⚠️","☠️","—"]
];

/* ============================================================
   TRANSLATION to minimalist icons
   —, 🟢 -> 🌈   |   🟡 -> ⚡   |   🔴/⚠️ -> 💊   |   ❌/☠️ -> 💀
============================================================ */
const toMini = s => {
  if (s==="—" || s==="🟢") return "🌈";
  if (s==="🟡") return "⚡";
  if (s==="🔴" || s==="⚠️") return "💊";
  if (s==="❌" || s==="☠️") return "💀";
  return s || "🌈";
};

/* ============================================================
   Expand "GHB / Opioids" -> split into "GHB" + "Opioids"
   Then add "Viagra". Non-specified Viagra cells are conservative.
============================================================ */
function buildExpandedMatrix(){
  // Build base map from original
  const baseCols = originalHeaders;
  const baseMap = new Map(); // key "row|col" -> minimalist icon
  for (const r of originalRows){
    const rowName = r[0];
    const cols = r.slice(1);
    cols.forEach((val,i)=>{
      const colName = baseCols[i];
      baseMap.set(`${rowName}|${colName}`, toMini(val));
    });
  }

  // Start list from original headers, but replace combined class with two
  const expanded = [
    "Cannabis","Ketamine","MDMA","Cocaine","Alcohol",
    "GHB","Opioids", // split
    "Benzos","SSRIs","SNRIs","ADHD Meds","Antipsychotics","Mood Stabilizers",
    "Wellbutrin","Trazodone","Gabapentin","LSD","Shrooms","Nitrous","DMT"
  ];

  // Helper to read combined mapping for either GHB or Opioids from "GHB / Opioids"
  const readCombined = (row, col) => {
    const key1 = `${row}|GHB / Opioids`;
    const key2 = `GHB / Opioids|${col}`;
    // prefer direct if exists
    if (baseMap.has(key1) && col==="GHB / Opioids") return baseMap.get(key1);
    if (baseMap.has(`${row}|${col}`)) return baseMap.get(`${row}|${col}`);
    if (baseMap.has(key1)) return baseMap.get(key1);
    if (baseMap.has(key2)) return baseMap.get(key2);
    return "⚡";
  };

  // Build expanded map (without Viagra yet)
  const m = new Map();

  // Copy all non-combined pairs first
  for (const r of expanded){
    for (const c of expanded){
      if (r===c){ m.set(`${r}|${c}`,"🌈"); continue; }
      // If either is GHB or Opioids, pull from combined where needed
      if ((r==="GHB" || r==="Opioids") && (c!=="GHB" && c!=="Opioids")){
        m.set(`${r}|${c}`, readCombined("GHB / Opioids", c));
        m.set(`${c}|${r}`, readCombined(c, "GHB / Opioids"));
      } else if ((c==="GHB" || c==="Opioids") && (r!=="GHB" && r!=="Opioids")){
        m.set(`${r}|${c}`, readCombined(r, "GHB / Opioids"));
        m.set(`${c}|${r}`, readCombined("GHB / Opioids", r));
      } else if ( (r!=="GHB" && r!=="Opioids") && (c!=="GHB" && c!=="Opioids") ){
        // both sides not split items: read from base
        const val = baseMap.get(`${r}|${c}`) ?? baseMap.get(`${c}|${r}`) ?? "⚡";
        m.set(`${r}|${c}`, val);
      }
    }
  }
  // Set explicit GHB <-> Opioids as 💀
  m.set("GHB|Opioids","💀"); m.set("Opioids|GHB","💀");

  // Now add Viagra row/col conservatively
  const withViagra = [...expanded, "Viagra"];
  for (const x of withViagra){
    if (x==="Viagra") continue;
  }
  // Defaults for Viagra
  const vDefaults = {
    "Cannabis":"🌈",
    "Ketamine":"⚡",
    "MDMA":"💊",
    "Cocaine":"💊",
    "Alcohol":"💊",
    "GHB":"💊",
    "Opioids":"💊",
    "Benzos":"⚡",
    "SSRIs":"🌈",
    "SNRIs":"⚡",
    "ADHD Meds":"💊",
    "Antipsychotics":"⚡",
    "Mood Stabilizers":"⚡",
    "Wellbutrin":"⚡",
    "Trazodone":"💊",
    "Gabapentin":"💊",
    "LSD":"⚡",
    "Shrooms":"⚡",
    "Nitrous":"🌈", // N2O ≠ nitrites
    "DMT":"⚡"
  };
  for (const s of expanded){
    const val = vDefaults[s] ?? "⚡";
    m.set(`Viagra|${s}`, val);
    m.set(`${s}|Viagra`, val);
  }
  m.set("Viagra|Viagra","🌈");

  return {headers: withViagra, map:m};
}

const {headers, map:mini} = buildExpandedMatrix();

/* ============================================================
   Detailed explanations for each interaction
============================================================ */
const detailedExplanations = {
  "🌈": (a, b) => `
    <p><strong>Low Risk Interaction:</strong> ${a} and ${b} typically have minimal negative interactions when used together. However, individual responses can vary based on dosage, tolerance, and personal health factors.</p>
    <p><strong>Harm Reduction Tips:</strong></p>
    <ul>
      <li>Start with lower doses than you would take individually</li>
      <li>Stay hydrated and in a safe environment</li>
      <li>Have a sober friend present if trying this combination for the first time</li>
    </ul>
    <div class="success-message">
      <p><i class="fas fa-check-circle"></i> <strong>Great news!</strong> This combination has a lower risk profile, but always practice harm reduction.</p>
    </div>
  `,
  "⚡": (a, b) => `
    <p><strong>Caution Advised:</strong> Combining ${a} and ${b} may increase side effects or intensify experiences beyond comfortable levels. This combination requires careful dosing and monitoring.</p>
    <p><strong>Potential Concerns:</strong> Increased heart rate, blood pressure changes, anxiety, or unexpected psychological effects.</p>
    <p><strong>Harm Reduction Tips:</strong></p>
    <ul>
      <li>Use significantly lower doses than you would take individually</li>
      <li>Wait longer between doses to assess effects</li>
      <li>Have benzodiazepines available if anxiety becomes overwhelming (only if prescribed)</li>
      <li>Avoid operating vehicles or machinery</li>
    </ul>
    <div class="success-message">
      <p><i class="fas fa-exclamation-triangle"></i> <strong>Smart move checking this!</strong> Being aware of potential interactions is key to harm reduction.</p>
    </div>
  `,
  "💊": (a, b) => `
    <p><strong>Strong Caution - Significant Interaction Risk:</strong> ${a} and ${b} have known pharmacological interactions that can significantly increase risks. This combination should be approached with extreme caution.</p>
    <p><strong>Specific Risks:</strong> Potential for serotonin syndrome, respiratory depression, cardiovascular stress, or unpredictable psychological effects.</p>
    <p><strong>Harm Reduction Tips:</strong></p>
    <ul>
      <li>Avoid this combination if possible</li>
      <li>If combining, use minimal doses and have medical supervision available</li>
      <li>Be aware of signs of overdose or adverse reactions</li>
      <li>Have naloxone available if opioids are involved</li>
      <li>Do not use alone</li>
    </ul>
    <div class="success-message">
      <p><i class="fas fa-shield-alt"></i> <strong>Thank you for being cautious!</strong> Identifying high-risk combinations is a critical safety step.</p>
    </div>
  `,
  "💀": (a, b) => `
    <p><strong>DANGEROUS COMBINATION - AVOID:</strong> Combining ${a} and ${b} creates a high risk of fatal overdose, severe medical complications, or permanent harm. This is one of the most dangerous drug combinations known.</p>
    <p><strong>Specific Life-Threatening Risks:</strong> Profound respiratory depression, cardiac arrest, seizure risk, extreme hyperthermia, or coma.</p>
    <p><strong>CRITICAL SAFETY INFORMATION:</strong></p>
    <ul>
      <li><strong>DO NOT COMBINE THESE SUBSTANCES</strong></li>
      <li>If accidental exposure occurs, call emergency services immediately</li>
      <li>Have multiple doses of naloxone available if opioids are involved</li>
      <li>This combination has resulted in numerous fatal overdoses</li>
      <li>Consider alternative substances that don't carry this extreme risk</li>
    </ul>
    <div class="success-message">
      <p><i class="fas fa-life-ring"></i> <strong>Potentially life-saving decision to check this!</strong> Avoiding dangerous combinations is the most effective harm reduction.</p>
    </div>
  `
};

const trioExplanations = {
  "🌈": (a, b, c) => `
    <p><strong>Three-Way Combination Assessment:</strong> While no major red flags are present for combining ${a}, ${b}, and ${c}, the complexity increases significantly with three substances.</p>
    <p><strong>Harm Reduction Strategy:</strong> Introduce substances sequentially with ample time between to assess effects. Consider eliminating one substance from the combination to reduce variables.</p>
    <div class="success-message">
      <p><i class="fas fa-star"></i> <strong>Excellent harm reduction practice!</strong> Checking three-way interactions shows advanced safety awareness.</p>
    </div>
  `,
  "⚡": (a, b, c) => `
    <p><strong>Three-Way Combination - Elevated Risk:</strong> Combining ${a}, ${b}, and ${c} creates overlapping effects that may be difficult to predict or manage.</p>
    <p><strong>Harm Reduction Strategy:</strong> Extreme caution advised. Consider eliminating the highest-risk pair from this combination. Have sober supervision and emergency contacts readily available.</p>
    <div class="success-message">
      <p><i class="fas fa-exclamation-circle"></i> <strong>Smart thinking checking this trio!</strong> Complex combinations require extra caution.</p>
    </div>
  `,
  "💊": (a, b, c) => `
    <p><strong>Three-Way Combination - High Risk:</strong> This combination of ${a}, ${b}, and ${c} includes significant interaction risks that compound when combined.</p>
    <p><strong>Harm Reduction Strategy:</strong> Strongly consider avoiding this combination entirely. If proceeding, have medical supervision, naloxone if opioids are involved, and clear emergency protocols.</p>
    <div class="success-message">
      <p><i class="fas fa-shield-alt"></i> <strong>Critical safety check!</strong> Identifying high-risk trios prevents dangerous situations.</p>
    </div>
  `,
  "💀": (a, b, c) => `
    <p><strong>THREE-WAY COMBINATION - EXTREME DANGER:</strong> This combination of ${a}, ${b}, and ${c} includes known dangerous pairs that create a potentially fatal scenario.</p>
    <p><strong>CRITICAL WARNING:</strong> This combination should be avoided under all circumstances. The risk of fatal overdose or severe medical emergency is extremely high.</p>
    <div class="success-message">
      <p><i class="fas fa-heartbeat"></i> <strong>Potentially life-saving discovery!</strong> Identifying extremely dangerous combinations is the highest form of harm reduction.</p>
    </div>
  `
};

/* ============================================================
   UI: Populate selects, render matrix, save functionality, share
============================================================ */
const allSubs = headers.slice(); // 21 including Viagra

function fillSelect(id){
  const sel = document.getElementById(id);
  sel.innerHTML = '<option value="">— Select —</option>' + allSubs.map(s=>`<option>${s}</option>`).join('');
}
["drugA","drugB","drugC"].forEach(fillSelect);

function iconExplain(x){
  switch(x){
    case "🌈": return "Low concern / typical co-use profile reported";
    case "⚡": return "Caution — increased side-effect potential; go slow";
    case "💊": return "Strong caution — meaningful interaction risk";
    case "💀": return "Danger — avoid / high overdose or medical risk";
    default: return "—";
  }
}

function getRiskClass(icon) {
  switch(icon) {
    case "🌈": return "risk-low";
    case "⚡": return "risk-caution";
    case "💊": return "risk-strong";
    case "💀": return "risk-danger";
    default: return "";
  }
}

function getRiskIcon(icon) {
  switch(icon) {
    case "🌈": return "🌈";
    case "⚡": return "⚡";
    case "💊": return "💊";
    case "💀": return "💀";
    default: return "";
  }
}

function renderPairs(sel){
  // Unique pairs + worst icon
  const pairs = [];
  const rank = {"🌈":1,"⚡":2,"💊":3,"💀":4};
  let worst = "🌈";
  for (let i=0;i<sel.length;i++){
    for (let j=i+1;j<sel.length;j++){
      const a = sel[i], b = sel[j];
      const v = mini.get(`${a}|${b}`) ?? mini.get(`${b}|${a}`) ?? "⚡";
      pairs.push({a,b,v});
      if (rank[v] > rank[worst]) worst = v;
    }
  }
  return {pairs,worst};
}

function tripleAdvisory(sel, worst){
  if (sel.length<3) return "";
  const [a,b,c]=sel;
  return `<div class="pair-detail ${getRiskClass(worst)}">
    <h4>Three-Way Combination: ${a} + ${b} + ${c} → ${worst}</h4>
    <span class="risk-icon">${getRiskIcon(worst)}</span>
    ${trioExplanations[worst](a, b, c)}
  </div>`;
}

document.getElementById("checkBtn").addEventListener("click", ()=>{
  const sel = ["drugA","drugB","drugC"].map(id=>document.getElementById(id).value).filter(Boolean);
  const box = document.getElementById("resultBox");
  if (sel.length<2){
    box.innerHTML = `<h3>Please select at least two substances.</h3>`;
    return;
  }
  const {pairs,worst} = renderPairs(sel);
  
  let content = `<h3><i class="fas fa-clipboard-check"></i> Interaction Analysis</h3>`;
  
  // Add detailed explanations for each pair
  pairs.forEach(pair => {
    content += `
      <div class="pair-detail ${getRiskClass(pair.v)}">
        <h4>${pair.a} + ${pair.b} → ${pair.v}</h4>
        <span class="risk-icon">${getRiskIcon(pair.v)}</span>
        ${detailedExplanations[pair.v](pair.a, pair.b)}
      </div>
    `;
  });
  
  // Add trio advisory if applicable
  if (sel.length === 3) {
    content += tripleAdvisory(sel, worst);
  }
  
  content += `<p style="margin-top:1rem;color:var(--muted);font-size:0.9rem;">Remember: individual responses vary based on dosage, tolerance, metabolism, and underlying health conditions. This information is for harm reduction purposes only.</p>`;
  
  box.innerHTML = content;
  
  // Scroll to results
  box.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
});

// Render matrix table
(function renderMatrix(){
  const tbl = document.getElementById("matrix");
  const thead = document.createElement("thead");
  const hrow = document.createElement("tr");
  hrow.appendChild(document.createElement("th")).textContent = "↓ / →";
  headers.forEach(h=>{ const th=document.createElement("th"); th.textContent=h; hrow.appendChild(th); });
  thead.appendChild(hrow);
  const tbody = document.createElement("tbody");
  headers.forEach(r=>{
    const tr = document.createElement("tr");
    const rowTh = document.createElement("th"); rowTh.textContent=r; tr.appendChild(rowTh);
    headers.forEach(c=>{
      const td = document.createElement("td");
      td.setAttribute("data-label", c);
      const val = mini.get(`${r}|${c}`) ?? mini.get(`${c}|${r}`) ?? "🌈";
      td.textContent = val;
      td.className = getRiskClass(val);
      td.title = `${r} + ${c}: ${iconExplain(val)}`;
      tr.appendChild(td);
    });
    tbody.appendChild(tr);
  });
  tbl.appendChild(thead); tbl.appendChild(tbody);
})();

// Save page functionality
const saveModal = document.getElementById("saveModal");
const savePageBtn = document.getElementById("savePageBtn");
const closeModal = document.getElementById("closeModal");

savePageBtn.addEventListener("click", () => {
  saveModal.style.display = "flex";
});

closeModal.addEventListener("click", () => {
  saveModal.style.display = "none";
});

// Save options
document.getElementById("savePdf").addEventListener("click", () => {
  alert("PDF generation would be implemented here with a library like jsPDF");
  saveModal.style.display = "none";
});

document.getElementById("saveHtml").addEventListener("click", () => {
  // Create a clone of the page content
  const content = document.querySelector('.wrap').cloneNode(true);
  
  // Remove interactive elements that won't work in a saved HTML
  const buttons = content.querySelectorAll('button');
  buttons.forEach(btn => {
    if (btn.id !== 'backButton') {
      btn.remove();
    }
  });
  
  // Remove selects
  const selects = content.querySelectorAll('select');
  selects.forEach(select => select.remove());
  
  // Create a new HTML document
  const htmlContent = `
    <!DOCTYPE html>
    <html>
    <head>
      <title>PLURderapolis Polydrug Interaction Checker</title>
      <meta charset="utf-8">
      <style>
        ${document.querySelector('style').innerHTML}
      </style>
    </head>
    <body>
      ${content.outerHTML}
    </body>
    </html>
  `;
  
  // Create and download the file
  const blob = new Blob([htmlContent], {type: 'text/html'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'plurderapolis-drug-interactions.html';
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
  
  saveModal.style.display = "none";
});

document.getElementById("saveImage").addEventListener("click", () => {
  alert("Image capture would be implemented here with a library like html2canvas");
  saveModal.style.display = "none";
});

// Share button (Web Share API)
document.getElementById("shareBtn").addEventListener("click", async ()=>{
  try{
    if (navigator.share){
      await navigator.share({title:"PLURderapolis Polydrug Matrix", text:"Check interactions + harm reduction tips", url:location.href});
    } else {
      alert("Copy this page URL to share:\n"+location.href);
    }
  }catch(e){ /* user cancelled */ }
});

// Back to top button functionality
const backToTopBtn = document.getElementById('backToTop');
window.addEventListener('scroll', () => {
  if (window.pageYOffset > 300) {
    backToTopBtn.style.display = 'block';
  } else {
    backToTopBtn.style.display = 'none';
  }
});

backToTopBtn.addEventListener('click', () => {
  window.scrollTo({ top: 0, behavior: 'smooth' });
});

// Close modal when clicking outside
window.addEventListener('click', (e) => {
  if (e.target === saveModal) {
    saveModal.style.display = 'none';
  }
});

// Add smooth scrolling for all anchor links
document.querySelectorAll('a[href^="#"]').forEach(anchor => {
  anchor.addEventListener('click', function (e) {
    e.preventDefault();
    const target = document.querySelector(this.getAttribute('href'));
    if (target) {
      target.scrollIntoView({
        behavior: 'smooth',
        block: 'start'
      });
    }
  });
});
</script>
</body>
</html>
