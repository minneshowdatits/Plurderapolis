<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<meta name="description" content="PLURderapolis Polydrug Interaction Checker - Harm reduction focused tool to check drug combination risks and safety tips.">
<meta name="keywords" content="polydrug, drug interactions, harm reduction, PLURderapolis, drug safety, risk assessment">
<title>Polydrug Risks & Interaction Checker | PLURderapolis</title>
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@600;800&family=Open+Sans:wght@400;600&display=swap" rel="stylesheet" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
  :root{
    --bg:#121212;
    --card:#1b0b1b;
    --ink:#eee;
    --muted:#bcbcbc;
    --accent:#bf00bf;
    --accent-2:#e051ff;
    --line:#440044;
    --chip:#550055;
    --shadow:0 0 12px rgba(191,0,191,.25);
    --danger:#ff4d4d;
    --caution:#ffb84d;
    --low-risk:#4dff88;
    --card-gradient: linear-gradient(135deg, #1b0b1b 0%, #2a0a2a 100%);
    --glow: 0 0 15px rgba(191, 0, 191, 0.5);
  }
  *{box-sizing:border-box}
  html,body{margin:0;padding:0;background:var(--bg);color:var(--ink);font-family:'Open Sans',system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; scroll-behavior: smooth;}
  a{color:var(--accent); text-decoration: none; transition: all 0.3s ease;}
  a:hover {color: var(--accent-2); text-shadow: 0 0 8px rgba(224, 81, 255, 0.5);}
  .wrap{max-width:1000px;margin:auto;padding:16px}
  h1,h2,h3{font-family:'Montserrat',sans-serif;letter-spacing:.2px}
  h1{font-size:clamp(1.8rem,3vw,2.5rem);color:var(--accent);margin:8px 0 6px; text-align: center; text-shadow: 0 0 10px rgba(191, 0, 191, 0.4);}
  p.lede{color:#f0d1ff;margin:.25rem 0 1rem; font-size: 1.1rem; text-align: center; line-height: 1.5;}
  
  /* Header branding */
  .branding{display:flex;align-items:center;gap:10px;margin-bottom:10px; justify-content: center; flex-direction: column; text-align: center;}
  .logo{font-size:2.5rem;font-weight:800;color:var(--accent);background:linear-gradient(45deg, var(--accent), var(--accent-2), #ff00ff, #bf00bf);-webkit-background-clip:text;-webkit-text-fill-color:transparent; animation: logoPulse 4s infinite ease-in-out, logoColors 8s infinite linear; text-shadow: 0 0 15px rgba(191, 0, 191, 0.5); margin-bottom: 5px; cursor: pointer;}
  @keyframes logoPulse {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.05); }
  }
  @keyframes logoColors {
    0% { filter: hue-rotate(0deg); }
    100% { filter: hue-rotate(360deg); }
  }
  .tagline{color:var(--muted);font-size:1rem; max-width: 500px; line-height: 1.4;}
  
  /* Hamburger menu */
  .hamburger-menu {
    position: fixed;
    top: 15px;
    left: 15px;
    z-index: 1000;
  }
  
  .hamburger-btn {
    background: var(--chip);
    color: var(--ink);
    border: 1px solid var(--line);
    border-radius: 8px;
    padding: 10px;
    font-size: 1.2rem;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    width: 45px;
    height: 45px;
  }
  
  .hamburger-btn:hover {
    background: var(--accent);
    transform: translateY(-2px);
    box-shadow: var(--glow);
  }
  
  .dropdown-content {
    display: none;
    position: absolute;
    top: 100%;
    left: 0;
    background: var(--card-gradient);
    min-width: 220px;
    border-radius: 8px;
    box-shadow: var(--shadow);
    border: 1px solid var(--line);
    padding: 10px 0;
    z-index: 1000;
    animation: dropdownFade 0.3s ease-out;
  }
  
  @keyframes dropdownFade {
    from { opacity: 0; transform: translateY(-10px); }
    to { opacity: 1; transform: translateY(0); }
  }
  
  .dropdown-content a {
    display: block;
    padding: 10px 20px;
    color: var(--ink);
    text-decoration: none;
    transition: all 0.3s ease;
    border-left: 3px solid transparent;
  }
  
  .dropdown-content a:hover {
    background: rgba(191, 0, 191, 0.1);
    border-left-color: var(--accent);
    padding-left: 25px;
  }
  
  .dropdown-content .divider {
    height: 1px;
    background: var(--line);
    margin: 8px 0;
  }
  
  .dropdown-content .section-title {
    padding: 8px 20px;
    font-weight: 700;
    color: var(--accent-2);
    font-size: 0.9rem;
    text-transform: uppercase;
    letter-spacing: 1px;
  }
  
  /* Top checker card */
  .tool{background:var(--card-gradient);border-radius:14px;padding:20px;box-shadow:var(--shadow);position:sticky;top:0.35rem;z-index:5; animation: fadeIn 0.8s ease-out; border: 1px solid var(--line); margin-bottom: 25px;}
  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
  }
  .tool h2{font-size:1.3rem;margin:.2rem 0 .6rem;color:var(--accent-2); text-align: center; display: flex; align-items: center; justify-content: center; gap: 10px;}
  .row{display:flex;gap:12px;flex-wrap:wrap}
  .sel{flex:1 1 180px;min-width:160px;display:flex;flex-direction:column;gap:6px}
  label{font-weight:700;color:var(--accent);font-size:.9rem; display: flex; align-items: center; gap: 5px;}
  select{width:100%;padding:.6rem .7rem;border:1px solid var(--line);border-radius:10px;background:#220022;color:var(--ink);appearance:none; transition: all 0.3s ease;}
  select:focus {outline: none; border-color: var(--accent-2); box-shadow: 0 0 0 2px rgba(224, 81, 255, 0.3);}
  button.primary{background:var(--accent);color:#fff;border:0;border-radius:10px;padding:.7rem 1rem;font-weight:800;cursor:pointer; transition: all 0.3s ease; position: relative; overflow: hidden;}
  button.primary:hover {background: var(--accent-2); transform: translateY(-2px); box-shadow: 0 4px 12px rgba(191, 0, 191, 0.4);}
  button.primary:active{transform:translateY(1px)}
  button.primary::after {content: ''; position: absolute; top: 50%; left: 50%; width: 5px; height: 5px; background: rgba(255, 255, 255, 0.5); opacity: 0; border-radius: 100%; transform: scale(1, 1) translate(-50%); transform-origin: 50% 50%;}
  button.primary:focus:not(:active)::after {animation: ripple 1s ease-out;}
  @keyframes ripple {0% {transform: scale(0, 0); opacity: 0.5;} 100% {transform: scale(20, 20); opacity: 0;}}
  .icons{font-size:1.05rem;opacity:.95; animation: iconGlow 2s infinite alternate;}
  @keyframes iconGlow {
    from { text-shadow: 0 0 5px rgba(191, 0, 191, 0.5); }
    to { text-shadow: 0 0 10px rgba(224, 81, 255, 0.8); }
  }
  .result{margin-top:20px;border:1px dashed var(--line);border-radius:12px;padding:15px;background:#170717; animation: slideIn 0.5s ease-out; max-height: 500px; overflow-y: auto;}
  @keyframes slideIn {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
  }
  .result h3{margin:.2rem 0 .4rem;color:#ffd6ff;font-size:1.2rem; text-align: center;}
  .pairs{margin:.4rem 0 0;padding-left:18px}
  .pair-detail{background:#1f001f;border-radius:8px;padding:15px;margin:12px 0;border-left:4px solid var(--accent); animation: fadeInUp 0.5s ease-out; box-shadow: 0 2px 8px rgba(0,0,0,0.2); position: relative;}
  @keyframes fadeInUp {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
  }
  .pair-detail.risk-low{border-left-color:var(--low-risk); box-shadow: 0 2px 8px rgba(77, 255, 136, 0.1);}
  .pair-detail.risk-caution{border-left-color:var(--caution); box-shadow: 0 2px 8px rgba(255, 184, 77, 0.1);}
  .pair-detail.risk-strong{border-left-color:var(--accent);}
  .pair-detail.risk-danger{border-left-color:var(--danger); box-shadow: 0 2px 8px rgba(255, 77, 77, 0.1);}
  .risk-icon {position: absolute; top: 15px; right: 15px; font-size: 1.5rem; animation: pulse 2s infinite;}
  @keyframes pulse {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.1); }
  }
  .legend{display:flex;gap:10px;flex-wrap:wrap;margin:15px 0 0;font-size:.95rem;color:var(--muted); justify-content: center;}
  .legend span{display:inline-flex;gap:6px;align-items:center;background:#200120;border:1px solid var(--line);border-radius:999px;padding:.4rem .8rem; transition: all 0.3s ease;}
  .legend span:hover {transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);}
  
  /* Matrix Key Section */
  .matrix-key {
    background: var(--card-gradient);
    border-radius: 12px;
    padding: 20px;
    margin: 20px 0;
    border: 1px solid var(--line);
    box-shadow: var(--shadow);
    animation: fadeIn 0.8s ease-out;
  }
  
  .matrix-key h3 {
    color: var(--accent-2);
    margin-top: 0;
    text-align: center;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
  }
  
  .key-items {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 15px;
    margin-top: 15px;
  }
  
  .key-item {
    background: #1f001f;
    border-radius: 8px;
    padding: 15px;
    border-left: 4px solid;
    animation: fadeInUp 0.5s ease-out;
  }
  
  .key-item.low { border-left-color: var(--low-risk); }
  .key-item.caution { border-left-color: var(--caution); }
  .key-item.strong { border-left-color: var(--accent); }
  .key-item.danger { border-left-color: var(--danger); }
  
  .key-header {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 10px;
  }
  
  .key-icon {
    font-size: 1.5rem;
  }
  
  .key-title {
    font-weight: 700;
    font-size: 1.1rem;
  }
  
  /* Share Results */
  .share-results {
    display: flex;
    gap: 10px;
    margin-top: 15px;
    flex-wrap: wrap;
    justify-content: center;
  }
  
  .share-btn {
    background: var(--chip);
    color: var(--ink);
    border: 1px solid var(--line);
    border-radius: 999px;
    padding: 8px 15px;
    font-weight: 700;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    gap: 5px;
    font-size: 0.9rem;
  }
  
  .share-btn:hover {
    background: var(--accent);
    transform: translateY(-2px);
    box-shadow: var(--glow);
  }
  
  /* Matrix */
  .controls{display:flex;align-items:center;gap:15px;margin:20px 0 15px;flex-wrap:wrap; justify-content: center;}
  .download{background:var(--accent);color:#fff;border:0;border-radius:999px;padding:.7rem 1.2rem;font-weight:800;cursor:pointer; transition: all 0.3s ease; display: flex; align-items: center; gap: 8px;}
  .download:hover {background: var(--accent-2); transform: translateY(-2px); box-shadow: 0 4px 12px rgba(191, 0, 191, 0.4);}
  .share{background:#2a002a;color:#fff;border:1px solid var(--line);border-radius:999px;padding:.7rem 1.2rem;font-weight:700;cursor:pointer; transition: all 0.3s ease; display: flex; align-items: center; gap: 8px;}
  .share:hover {background: #3a003a; transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);}
  .matrix{overflow:auto;border-radius:12px;box-shadow:var(--shadow);border:1px solid var(--line);background:#160616; animation: fadeIn 0.8s ease-out 0.2s both; margin-bottom: 25px;}
  table{border-collapse:collapse;width:100%;min-width:980px;font-size:.92rem}
  th,td{border:1px solid var(--line);padding:.45rem .55rem;text-align:center;vertical-align:middle; transition: all 0.3s ease; position: relative;}
  thead th{position:sticky;top:0;background:#3b0a3b;color:#ffe5ff;z-index:2; box-shadow: 0 2px 5px rgba(0,0,0,0.2);}
  tbody th{position:sticky;left:0;background:#2a002a;color:#fff;z-index:1; box-shadow: 2px 0 5px rgba(0,0,0,0.2);}
  td{background:#1f001f; transition: all 0.3s ease; cursor: pointer;}
  td:hover {transform: scale(1.05); z-index: 3; box-shadow: 0 0 10px rgba(191, 0, 191, 0.5); animation: cellPulse 0.5s;}
  @keyframes cellPulse {
    0% { transform: scale(1); }
    50% { transform: scale(1.05); }
    100% { transform: scale(1.05); }
  }
  td.risk-low{background:#0a2a14}
  td.risk-caution{background:#2a200a}
  td.risk-strong{background:#2a0a2a}
  td.risk-danger{background:#2a0a0a}
  .chip {display:inline-block;background:var(--chip);border-radius:999px;padding:.18rem .55rem;font-weight:700; transition: all 0.3s ease;}
  .chip:hover {transform: scale(1.05); background: var(--accent);}
  
  /* Sections at bottom (accordion) */
  details.info{background:var(--card-gradient);border:1px solid var(--line);border-radius:12px;padding:.8rem 1rem;margin:.8rem 0; transition: all 0.3s ease; box-shadow: 0 2px 5px rgba(0,0,0,0.1);}
  details.info:hover {border-color: var(--accent); transform: translateY(-2px);}
  details.info summary{cursor:pointer;font-weight:800;list-style:none; transition: all 0.3s ease; display: flex; align-items: center; padding: 8px 0; font-size: 1.1rem;}
  details.info summary:hover {color: var(--accent-2);}
  details.info summary::marker, details.info summary::-webkit-details-marker{display:none}
  details.info summary .tag{margin-left:.5rem;opacity:.85; font-size: 0.8rem; background: var(--chip); padding: 2px 8px; border-radius: 10px;}
  details.info[open] {animation: accordionOpen 0.5s ease-out;}
  @keyframes accordionOpen {
    from { opacity: 0; max-height: 0; }
    to { opacity: 1; max-height: 500px; }
  }
  
  /* Back to top button */
  .back-to-top{position:fixed;bottom:20px;right:20px;background:var(--accent);color:#fff;border:0;border-radius:50%;width:50px;height:50px;font-size:1.5rem;cursor:pointer;box-shadow:var(--shadow);z-index:100;display:none; transition: all 0.3s ease; animation: bounce 2s infinite;}
  @keyframes bounce {
    0%, 20%, 50%, 80%, 100% {transform: translateY(0);}
    40% {transform: translateY(-10px);}
    60% {transform: translateY(-5px);}
  }
  .back-to-top:hover {background: var(--accent-2); transform: translateY(-3px) scale(1.1); box-shadow: 0 6px 15px rgba(191, 0, 191, 0.5);}
  
  /* Footer */
  footer{border-top:1px solid var(--line);color:var(--muted);font-size:.9rem;padding:18px;margin-top:16px;text-align:center; animation: fadeIn 0.8s ease-out 0.4s both;}
  .pill{display:inline-block;background:var(--chip);padding:.22rem .6rem;border-radius:999px;font-weight:800; transition: all 0.3s ease;}
  .pill:hover {transform: scale(1.05); background: var(--accent);}
  
  /* Footer Navigation */
  .footer-nav {
    display: flex;
    justify-content: center;
    flex-wrap: wrap;
    gap: 15px;
    margin: 20px 0;
  }
  
  .footer-link {
    color: var(--muted);
    transition: all 0.3s ease;
    padding: 8px 15px;
    border-radius: 20px;
    border: 1px solid transparent;
  }
  
  .footer-link:hover {
    color: var(--accent-2);
    border-color: var(--accent);
    transform: translateY(-2px);
  }
  
  .footer-link.highlight {
    background: var(--chip);
    color: var(--ink);
    font-weight: 700;
  }
  
  .footer-link.highlight:hover {
    background: var(--accent);
  }
  
  /* Mobile niceties */
  @media (max-width:640px){
    .tool{position:static}
    .legend{font-size:.9rem}
    table{font-size:.86rem;min-width:840px}
    .controls{flex-direction:column;align-items:flex-start}
    .branding {flex-direction: column; align-items: flex-start; gap: 5px;}
    h1 {text-align: left;}
    p.lede {text-align: left;}
    .footer-nav {
      flex-direction: column;
      align-items: center;
      gap: 10px;
    }
    .key-items {
      grid-template-columns: 1fr;
    }
  }
  
  /* Save page modal */
  .save-modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.7);
    z-index: 1000;
    justify-content: center;
    align-items: center;
    animation: fadeIn 0.3s ease-out;
  }
  
  .save-modal-content {
    background: var(--card-gradient);
    border-radius: 12px;
    padding: 20px;
    max-width: 500px;
    width: 90%;
    box-shadow: var(--shadow);
    border: 1px solid var(--line);
    animation: slideIn 0.3s ease-out;
  }
  
  .save-modal h3 {
    margin-top: 0;
    color: var(--accent-2);
  }
  
  .save-options {
    display: flex;
    gap: 10px;
    margin: 15px 0;
    flex-wrap: wrap;
  }
  
  .save-option {
    flex: 1;
    min-width: 120px;
    background: var(--chip);
    border: 1px solid var(--line);
    border-radius: 8px;
    padding: 10px;
    text-align: center;
    cursor: pointer;
    transition: all 0.3s ease;
  }
  
  .save-option:hover {
    background: var(--accent);
    transform: translateY(-2px);
  }
  
  .modal-close {
    background: var(--accent);
    color: white;
    border: none;
    border-radius: 8px;
    padding: 8px 15px;
    cursor: pointer;
    transition: all 0.3s ease;
  }
  
  .modal-close:hover {
    background: var(--accent-2);
  }
  
  /* Mobile swipe indicators */
  .swipe-indicator {
    display: none;
    text-align: center;
    margin: 10px 0;
    color: var(--muted);
    font-size: 0.9rem;
    animation: pulse 2s infinite;
  }
  
  @keyframes pulse {
    0%, 100% { opacity: 0.7; }
    50% { opacity: 1; }
  }
  
  @media (max-width: 768px) {
    .swipe-indicator {
      display: block;
    }
  }
  
  /* Section headings */
  .section-heading {
    display: flex;
    align-items: center;
    gap: 10px;
    margin: 25px 0 15px;
    color: var(--accent-2);
    font-size: 1.4rem;
    animation: fadeIn 0.8s ease-out;
  }
  
  .section-heading::after {
    content: '';
    flex: 1;
    height: 2px;
    background: linear-gradient(90deg, var(--accent-2), transparent);
  }
  
  /* Floating particles animation */
  .particles {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    pointer-events: none;
    z-index: -1;
  }
  
  .particle {
    position: absolute;
    width: 4px;
    height: 4px;
    background: var(--accent-2);
    border-radius: 50%;
    animation: float 15s infinite linear;
    opacity: 0.3;
  }
  
  @keyframes float {
    0% {
      transform: translateY(100vh) translateX(0);
      opacity: 0;
    }
    10% {
      opacity: 0.3;
    }
    90% {
      opacity: 0.3;
    }
    100% {
      transform: translateY(-100px) translateX(100px);
      opacity: 0;
    }
  }
  
  /* Matrix Detail Modal */
  .matrix-modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.7);
    z-index: 1000;
    justify-content: center;
    align-items: center;
    animation: fadeIn 0.3s ease-out;
  }
  
  .matrix-modal-content {
    background: var(--card-gradient);
    border-radius: 12px;
    padding: 20px;
    max-width: 600px;
    width: 90%;
    box-shadow: var(--shadow);
    border: 1px solid var(--line);
    animation: slideIn 0.3s ease-out;
    max-height: 80vh;
    overflow-y: auto;
  }
  
  .matrix-modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
  }
  
  .matrix-modal h3 {
    margin: 0;
    color: var(--accent-2);
    display: flex;
    align-items: center;
    gap: 10px;
  }
  
  .matrix-modal-close {
    background: var(--accent);
    color: white;
    border: none;
    border-radius: 50%;
    width: 30px;
    height: 30px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s ease;
  }
  
  .matrix-modal-close:hover {
    background: var(--accent-2);
    transform: scale(1.1);
  }
</style>
</head>
<body>
  <!-- Floating particles -->
  <div class="particles" id="particles"></div>
  
  <!-- Hamburger Menu -->
  <div class="hamburger-menu">
    <button class="hamburger-btn" id="hamburgerBtn">
      <i class="fas fa-bars"></i>
    </button>
    <div class="dropdown-content" id="dropdownContent">
      <div class="section-title">Page Sections</div>
      <a href="#tool"><i class="fas fa-search-plus"></i> Interaction Checker</a>
      <a href="#matrix-key"><i class="fas fa-key"></i> Matrix Key</a>
      <a href="#matrix"><i class="fas fa-table"></i> Risk Matrix</a>
      <a href="#tips"><i class="fas fa-lightbulb"></i> Harm Reduction Tips</a>
      <a href="#categories"><i class="fas fa-layer-group"></i> Combo Categories</a>
      
      <div class="divider"></div>
      
      <div class="section-title">Site Pages</div>
      <a href="rx-combos.html" class="highlight"><i class="fas fa-prescription-bottle"></i> Rx Combos</a>
      <a href="resources.html"><i class="fas fa-book"></i> Resources</a>
      <a href="emergency.html"><i class="fas fa-exclamation-triangle"></i> Emergency</a>
      <a href="spiking.html"><i class="fas fa-skull-crossbones"></i> Spiking</a>
      <a href="fake.html"><i class="fas fa-search"></i> Fake Drugs</a>
    </div>
  </div>
  
  <div class="wrap">
    <!-- PLURderapolis branding -->
    <div class="branding">
      <div class="logo" id="homeLink">PLURderapolis</div>
      <div class="tagline">Harm Reduction & Community Safety - Empowering informed decisions through education and support</div>
    </div>
    
    <h1>Polydrug Interaction Checker <span class="icons">⚡💊💀🌈</span></h1>
    <p class="lede">Mobile-first, harm-reduction focused tool to check drug combination risks. Pick up to three substances and see detailed safety information. Matrix is downloadable + shareable.</p>

    <!-- ===== Interaction Checker (TOP) ===== -->
    <section class="tool" aria-label="Polydrug Interaction Checker" id="tool">
      <h2><i class="fas fa-search-plus"></i> Quick Check</h2>
      <div class="row">
        <div class="sel">
          <label for="drugA"><i class="fas fa-pills"></i> Substance A</label>
          <select id="drugA"></select>
        </div>
        <div class="sel">
          <label for="drugB"><i class="fas fa-pills"></i> Substance B</label>
          <select id="drugB"></select>
        </div>
        <div class="sel">
          <label for="drugC"><i class="fas fa-pills"></i> Substance C (optional)</label>
          <select id="drugC"></select>
        </div>
        <div class="sel" style="align-self:flex-end">
          <button class="primary" id="checkBtn"><i class="fas fa-search"></i> Check <span class="icons">⚡</span></button>
        </div>
      </div>

      <div class="legend" aria-label="Legend">
        <span><b>🌈</b> Low concern / typical</span>
        <span><b>⚡</b> Caution</span>
        <span><b>💊</b> Strong caution / interaction risk</span>
        <span><b>💀</b> Dangerous / avoid</span>
      </div>

      <div class="result" id="resultBox" aria-live="polite">
        <h3><i class="fas fa-clipboard-list"></i> Results will appear here</h3>
        <p>We'll show A+B, A+C, B+C and a combined A+B+C overview with detailed harm-reduction pointers.</p>
        <div class="share-results" id="shareResults" style="display: none;">
          <button class="share-btn" id="copyResults"><i class="fas fa-copy"></i> Copy Results</button>
          <button class="share-btn" id="saveResults"><i class="fas fa-save"></i> Save Results</button>
          <button class="share-btn" id="shareTwitter"><i class="fab fa-twitter"></i> Tweet</button>
          <button class="share-btn" id="shareReddit"><i class="fab fa-reddit"></i> Reddit</button>
        </div>
      </div>
    </section>

    <!-- ===== Matrix Key ===== -->
    <div class="section-heading" id="matrix-key">
      <i class="fas fa-key"></i> Matrix Risk Key
    </div>

    <div class="matrix-key">
      <h3><i class="fas fa-info-circle"></i> Understanding the Risk Levels</h3>
      <div class="key-items">
        <div class="key-item low">
          <div class="key-header">
            <span class="key-icon">🌈</span>
            <span class="key-title">Low Risk (🌈)</span>
          </div>
          <p><strong>Minimal interaction concerns</strong> - These substances typically have minimal negative interactions when used together. However, individual responses can vary based on dosage, tolerance, and personal health factors.</p>
          <p><strong>Harm Reduction Tips:</strong> Start with lower doses than you would take individually, stay hydrated, and have a sober friend present if trying this combination for the first time.</p>
        </div>
        
        <div class="key-item caution">
          <div class="key-header">
            <span class="key-icon">⚡</span>
            <span class="key-title">Caution (⚡)</span>
          </div>
          <p><strong>Moderate interaction concerns</strong> - These combinations may increase side effects or intensify experiences beyond comfortable levels. Requires careful dosing and monitoring.</p>
          <p><strong>Potential Concerns:</strong> Increased heart rate, blood pressure changes, anxiety, or unexpected psychological effects.</p>
          <p><strong>Harm Reduction Tips:</strong> Use significantly lower doses than you would take individually, wait longer between doses to assess effects, and avoid operating vehicles or machinery.</p>
        </div>
        
        <div class="key-item strong">
          <div class="key-header">
            <span class="key-icon">💊</span>
            <span class="key-title">Strong Caution (💊)</span>
          </div>
          <p><strong>Significant interaction risk</strong> - These substances have known pharmacological interactions that can significantly increase risks. Should be approached with extreme caution.</p>
          <p><strong>Specific Risks:</strong> Potential for serotonin syndrome, respiratory depression, cardiovascular stress, or unpredictable psychological effects.</p>
          <p><strong>Harm Reduction Tips:</strong> Avoid this combination if possible. If combining, use minimal doses and have medical supervision available. Do not use alone.</p>
        </div>
        
        <div class="key-item danger">
          <div class="key-header">
            <span class="key-icon">💀</span>
            <span class="key-title">Dangerous (💀)</span>
          </div>
          <p><strong>High risk of severe harm or death</strong> - These combinations create a high risk of fatal overdose, severe medical complications, or permanent harm. Among the most dangerous drug combinations known.</p>
          <p><strong>Specific Life-Threatening Risks:</strong> Profound respiratory depression, cardiac arrest, seizure risk, extreme hyperthermia, or coma.</p>
          <p><strong>CRITICAL SAFETY INFORMATION:</strong> DO NOT COMBINE THESE SUBSTANCES. If accidental exposure occurs, call emergency services immediately.</p>
        </div>
      </div>
    </div>

    <!-- ===== Controls + Matrix ===== -->
    <div class="swipe-indicator">
      <i class="fas fa-arrows-left-right"></i> Swipe left/right to explore the full matrix
    </div>
    
    <div class="controls">
      <button class="download" id="savePageBtn"><i class="fas fa-download"></i> Save Page</button>
      <button class="share" id="shareBtn"><i class="fas fa-share-alt"></i> Share Page</button>
    </div>

    <div class="section-heading" id="matrix">
      <i class="fas fa-table"></i> Interaction Matrix
    </div>

    <div class="matrix" role="region" aria-label="Combo Risk Matrix">
      <table id="matrixTable"></table>
    </div>

    <!-- ===== Tips (quick) ===== -->
    <details class="info" open id="tips">
      <summary><i class="fas fa-lightbulb"></i> Harm Reduction Tips <span class="tag">(quick)</span></summary>
      <ul>
        <li><strong>Test what you can.</strong> Start low, go slow. Space redoses.</li>
        <li><span class="pill">Never stack depressants</span> (alcohol, benzos, GHB, opioids) — biggest driver of fatal ODs.</li>
        <li><strong>Heat + stimulants = risk.</strong> Cool environment, electrolyte sips, rest breaks.</li>
        <li><strong>Carry naloxone</strong> if opioids could be around. Don't use alone. Recovery position if someone is out.</li>
        <li><strong>On Rx meds?</strong> Avoid chasing "muted" effects by redosing — risk goes up even if euphoria doesn't.</li>
      </ul>
    </details>

    <!-- ===== Category cards at bottom ===== -->
    <div class="section-heading" id="categories">
      <i class="fas fa-layer-group"></i> Combo Categories
    </div>

    <details class="info"><summary><i class="fas fa-capsules"></i> Depressant × Depressant <span class="tag">benzodiazepines, alcohol, GHB, opioids, trazodone, gabapentin</span></summary>
      <p><b>Risk:</b> <b>💀</b> — synergistic respiratory depression, blackouts, aspiration.</p>
      <ul>
        <li>Keep people awake & breathing; recovery position if unresponsive.</li>
        <li>Naloxone reverses opioids (not benzos/GHB); still call EMS.</li>
      </ul>
    </details>

    <details class="info"><summary><i class="fas fa-bolt"></i> Stimulant × Stimulant <span class="tag">MDMA, cocaine, ADHD meds, bupropion</span></summary>
      <p><b>Risk:</b> <b>💊→💀</b> — hypertension, hyperthermia, arrhythmia, panic.</p>
      <ul>
        <li>Avoid stacking; cool down, hydrate, don't chase muted highs.</li>
      </ul>
    </details>

    <details class="info"><summary><i class="fas fa-balance-scale"></i> Stimulant × Depressant <span class="tag">e.g., cocaine+alcohol, MDMA+GHB</span></summary>
      <p><b>Risk:</b> <b>💊</b> — masking sedation, dehydration, liver stress (cocaethylene with alcohol+cocaine).</p>
      <ul>
        <li>Don't redose to "even it out". Watch breathing and heat load.</li>
      </ul>
    </details>

    <details class="info"><summary><i class="fas fa-cloud-sun"></i> Psychedelics with Cannabis</summary>
      <p>Can potentiate intensity/anxiety. Delay THC until past peak; micro-puffs if at all.</p>
    </details>

    <details class="info"><summary><i class="fas fa-head-side-virus"></i> Dissociative × Depressant <span class="tag">ketamine/nitrous + alcohol/benzos/GHB</span></summary>
      <p>Hypoxia/airway risk + amnesia. Sit down, supervised, fresh air breaks.</p>
    </details>

    <!-- Footer Navigation -->
    <div class="footer-nav">
      <a href="rx-combos.html" class="footer-link highlight"><i class="fas fa-prescription-bottle"></i> Rx Combos</a>
      <a href="resources.html" class="footer-link"><i class="fas fa-book"></i> Resources</a>
      <a href="emergency.html" class="footer-link"><i class="fas fa-exclamation-triangle"></i> Emergency</a>
      <a href="spiking.html" class="footer-link"><i class="fas fa-skull-crossbones"></i> Spiking</a>
      <a href="fake.html" class="footer-link"><i class="fas fa-search"></i> Fake Drugs</a>
    </div>

    <!-- ===== Legal disclaimer (single) ===== -->
    <footer>
      <p><strong>Legal & Medical Disclaimer:</strong> The information provided on PLURderapolis.org is for educational and harm reduction purposes only. It is not intended as medical advice, diagnosis, or treatment. Always seek the advice of qualified healthcare providers with any questions regarding medical conditions or substance use.</p>
      
      <p>No information on this site should be interpreted as encouraging or promoting substance use. The interaction data presented is based on established harm reduction resources and clinical literature, but individual responses to substances vary widely based on numerous factors including genetics, tolerance, metabolism, underlying health conditions, dosage, and setting.</p>
      
      <p>PLURderapolis.org makes no representations or warranties about the accuracy, completeness, or suitability of the information provided. Users assume all risks associated with any actions taken based on this information. In case of medical emergency, contact emergency services immediately.</p>
      
      <p>By using this site, you acknowledge and agree that PLURderapolis.org, its creators, and contributors are not liable for any direct, indirect, incidental, consequential, or punitive damages arising from your use of or reliance on the information provided.</p>
      
      <p>© 2025 PLURderapolis • <span class="pill">Stay safe. Stay kind.</span></p>
    </footer>
  </div>

  <!-- Save Page Modal -->
  <div class="save-modal" id="saveModal">
    <div class="save-modal-content">
      <h3><i class="fas fa-save"></i> Save Page</h3>
      <p>Choose how you'd like to save this information:</p>
      <div class="save-options">
        <div class="save-option" id="savePdf">
          <i class="fas fa-file-pdf"></i>
          <div>PDF</div>
        </div>
        <div class="save-option" id="saveHtml">
          <i class="fas fa-code"></i>
          <div>HTML</div>
        </div>
        <div class="save-option" id="saveImage">
          <i class="fas fa-image"></i>
          <div>Image</div>
        </div>
      </div>
      <button class="modal-close" id="closeModal">Close</button>
    </div>
  </div>

  <!-- Matrix Detail Modal -->
  <div class="matrix-modal" id="matrixModal">
    <div class="matrix-modal-content">
      <div class="matrix-modal-header">
        <h3 id="matrixModalTitle"><i class="fas fa-info-circle"></i> Interaction Details</h3>
        <button class="matrix-modal-close" id="matrixModalClose"><i class="fas fa-times"></i></button>
      </div>
      <div id="matrixModalBody"></div>
    </div>
  </div>

  <!-- Back to top button -->
  <button class="back-to-top" id="backToTop" aria-label="Back to top"><i class="fas fa-arrow-up"></i></button>

<script>
/* ============================================================
   DATA INGEST: Your original 20-substance matrix (as posted)
   Symbols: —, 🟢, 🟡, 🔴, ⚠️, ❌, ☠️
   We will translate to minimalist icons later.
============================================================ */
const originalHeaders = ["Cannabis","Ketamine","MDMA","Cocaine","Alcohol","GHB / Opioids","Benzos","SSRIs","SNRIs","ADHD Meds","Antipsychotics","Mood Stabilizers","Wellbutrin","Trazodone","Gabapentin","LSD","Shrooms","Nitrous","DMT","GHB"];
// NOTE: Your pasted table had 20 columns; the last header label you included row-wise was "GHB" again.
// We're trusting the body rows you posted below (they match 20-wide). The body:
const originalRows = [
  ["Cannabis","—","🟡","🔴","🔴","🔴","🔴","🔴","🟡","🟡","🟢","🟡","🟡","🟢","🟢","🟢","🔴","🔴","🟢","🔴","🔴"],
  ["Ketamine","🟡","—","❌","❌","❌","❌","🟡","🟡","🟡","🔴","🟡","🟡","🟡","🟡","🟡","❌","❌","🟡","❌","❌"],
  ["MDMA","🔴","❌","—","🔴","🔴","❌","🔴","🔴","❌","❌","❌","❌","❌","🔴","🔴","🔴","🔴","🔴","❌","❌"],
  ["Cocaine","🔴","❌","🔴","—","🔴","❌","🔴","🔴","❌","❌","🔴","🔴","🔴","🔴","🔴","🔴","🔴","🔴","❌","❌"],
  ["Alcohol","🔴","❌","🔴","🔴","—","❌","☠️","⚠️","⚠️","⚠️","⚠️","⚠️","❌","❌","❌","🔴","🔴","❌","❌","☠️"],
  ["GHB / Opioids","🔴","❌","❌","❌","☠️","—","☠️","⚠️","⚠️","⚠️","⚠️","⚠️","⚠️","⚠️","⚠️","❌","❌","⚠️","☠️","—"],
  ["Benzos","🔴","🟡","🔴","🔴","☠️","☠️","—","⚠️","⚠️","⚠️","⚠️","⚠️","⚠️","⚠️","⚠️","⚠️","⚠️","⚠️","☠️","⚠️"],
  ["SSRIs","🟡","🟡","🔴","🔴","⚠️","⚠️","⚠️","—","⚠️","⚠️","⚠️","⚠️","⚠️","⚠️","⚠️","⚠️","⚠️","⚠️","⚠️","⚠️"],
  ["SNRIs","🟡","🟡","❌","❌","⚠️","⚠️","⚠️","⚠️","—","⚠️","⚠️","⚠️","⚠️","⚠️","⚠️","⚠️","⚠️","⚠️","⚠️","⚠️"],
  ["ADHD Meds","🟢","🟡","❌","❌","⚠️","⚠️","⚠️","⚠️","⚠️","—","🟡","🟡","🟡","🟡","🟡","⚠️","⚠️","⚠️","⚠️","⚠️"],
  ["Antipsychotics","🟡","🟡","❌","🔴","⚠️","⚠️","⚠️","⚠️","⚠️","🟡","—","🟡","🟡","🟡","🟡","⚠️","⚠️","⚠️","⚠️","⚠️"],
  ["Mood Stabilizers","🟡","🟡","❌","🔴","⚠️","⚠️","⚠️","⚠️","⚠️","🟡","🟡","—","🟡","🟡","🟡","⚠️","⚠️","⚠️","⚠️","⚠️"],
  ["Wellbutrin","🟢","🟡","❌","🔴","❌","⚠️","⚠️","⚠️","⚠️","🟡","🟡","🟡","—","🟡","🟡","⚠️","⚠️","⚠️","⚠️","⚠️"],
  ["Trazodone","🟢","🟡","🔴","🔴","❌","⚠️","⚠️","⚠️","⚠️","🟡","🟡","🟡","🟡","—","🟢","⚠️","⚠️","⚠️","⚠️","⚠️"],
  ["Gabapentin","🟢","🟡","🔴","🔴","❌","⚠️","⚠️","⚠️","⚠️","🟡","🟡","🟡","🟡","🟢","—","⚠️","⚠️","⚠️","⚠️","⚠️"],
  ["LSD","🔴","🟡","🔴","🔴","🔴","❌","⚠️","⚠️","⚠️","⚠️","⚠️","⚠️","⚠️","⚠️","⚠️","—","🟢","🟡","🟡","🔴"],
  ["Shrooms","🔴","❌","🔴","🔴","🔴","❌","⚠️","⚠️","⚠️","⚠️","⚠️","⚠️","⚠️","🟢","⚠️","🟢","—","🟡","🟡","🔴"],
  ["Nitrous","🟢","🟡","🔴","🔴","❌","⚠️","⚠️","⚠️","⚠️","⚠️","⚠️","⚠️","⚠️","⚠️","⚠️","🟡","🟡","—","⚠️","⚠️"],
  ["DMT","🔴","❌","❌","❌","❌","☠️","⚠️","⚠️","⚠️","⚠️","⚠️","⚠️","⚠️","⚠️","⚠️","🔴","🔴","⚠️","—","☠️"],
  ["GHB","🔴","❌","❌","☠️","☠️","—","☠️","⚠️","⚠️","⚠️","⚠️","⚠️","⚠️","⚠️","⚠️","🔴","🔴","⚠️","☠️","—"]
];

/* ============================================================
   TRANSLATION to minimalist icons
   —, 🟢 -> 🌈   |   🟡 -> ⚡   |   🔴/⚠️ -> 💊   |   ❌/☠️ -> 💀
============================================================ */
const toMini = s => {
  if (s==="—" || s==="🟢") return "🌈";
  if (s==="🟡") return "⚡";
  if (s==="🔴" || s==="⚠️") return "💊";
  if (s==="❌" || s==="☠️") return "💀";
  return s || "🌈";
};

/* ============================================================
   Expand "GHB / Opioids" -> split into "GHB" + "Opioids"
   Then add "Viagra". Non-specified Viagra cells are conservative.
============================================================ */
function buildExpandedMatrix(){
  // Build base map from original
  const baseCols = originalHeaders;
  const baseMap = new Map(); // key "row|col" -> minimalist icon
  for (const r of originalRows){
    const rowName = r[0];
    const cols = r.slice(1);
    cols.forEach((val,i)=>{
      const colName = baseCols[i];
      baseMap.set(`${rowName}|${colName}`, toMini(val));
    });
  }

  // Start list from original headers, but replace combined class with two
  const expanded = [
    "Cannabis","Ketamine","MDMA","Cocaine","Alcohol",
    "GHB","Opioids", // split
    "Benzos","SSRIs","SNRIs","ADHD Meds","Antipsychotics","Mood Stabilizers",
    "Wellbutrin","Trazodone","Gabapentin","LSD","Shrooms","Nitrous","DMT"
  ];

  // Helper to read combined mapping for either GHB or Opioids from "GHB / Opioids"
  const readCombined = (row, col) => {
    const key1 = `${row}|GHB / Opioids`;
    const key2 = `GHB / Opioids|${col}`;
    // prefer direct if exists
    if (baseMap.has(key1) && col==="GHB / Opioids") return baseMap.get(key1);
    if (baseMap.has(`${row}|${col}`)) return baseMap.get(`${row}|${col}`);
    if (baseMap.has(key1)) return baseMap.get(key1);
    if (baseMap.has(key2)) return baseMap.get(key2);
    return "⚡";
  };

  // Build expanded map (without Viagra yet)
  const m = new Map();

  // Copy all non-combined pairs first
  for (const r of expanded){
    for (const c of expanded){
      if (r===c){ m.set(`${r}|${c}`,"🌈"); continue; }
      // If either is GHB or Opioids, pull from combined where needed
      if ((r==="GHB" || r==="Opioids") && (c!=="GHB" && c!=="Opioids")){
        m.set(`${r}|${c}`, readCombined("GHB / Opioids", c));
        m.set(`${c}|${r}`, readCombined(c, "GHB / Opioids"));
      } else if ((c==="GHB" || c==="Opioids") && (r!=="GHB" && r!=="Opioids")){
        m.set(`${r}|${c}`, readCombined(r, "GHB / Opioids"));
        m.set(`${c}|${r}`, readCombined("GHB / Opioids", r));
      } else if ( (r!=="GHB" && r!=="Opioids") && (c!=="GHB" && c!=="Opioids") ){
        // both sides not split items: read from base
        const val = baseMap.get(`${r}|${c}`) ?? baseMap.get(`${c}|${r}`) ?? "⚡";
        m.set(`${r}|${c}`, val);
      }
    }
  }
  // Set explicit GHB <-> Opioids as 💀
  m.set("GHB|Opioids","💀"); m.set("Opioids|GHB","💀");

  // Now add Viagra row/col conservatively
  const withViagra = [...expanded, "Viagra"];
  for (const x of withViagra){
    if (x==="Viagra") continue;
  }
  // Defaults for Viagra
  const vDefaults = {
    "Cannabis":"🌈",
    "Ketamine":"⚡",
    "MDMA":"💊",
    "Cocaine":"💊",
    "Alcohol":"💊",
    "GHB":"💊",
    "Opioids":"💊",
    "Benzos":"⚡",
    "SSRIs":"🌈",
    "SNRIs":"⚡",
    "ADHD Meds":"💊",
    "Antipsychotics":"⚡",
    "Mood Stabilizers":"⚡",
    "Wellbutrin":"⚡",
    "Trazodone":"💊",
    "Gabapentin":"💊",
    "LSD":"⚡",
    "Shrooms":"⚡",
    "Nitrous":"🌈", // N2O ≠ nitrites
    "DMT":"⚡"
  };
  for (const s of expanded){
    const val = vDefaults[s] ?? "⚡";
    m.set(`Viagra|${s}`, val);
    m.set(`${s}|Viagra`, val);
  }
  m.set("Viagra|Viagra","🌈");

  return {headers: withViagra, map:m};
}

const {headers, map:mini} = buildExpandedMatrix();

/* ============================================================
   Detailed explanations for each interaction
============================================================ */
const detailedExplanations = {
  "🌈": (a, b) => `
    <p><strong>Low Risk Interaction:</strong> ${a} and ${b} typically have minimal negative interactions when used together. However, individual responses can vary based on dosage, tolerance, and personal health factors.</p>
    <p><strong>Harm Reduction Tips:</strong></p>
    <ul>
      <li>Start with lower doses than you would take individually</li>
      <li>Stay hydrated and in a safe environment</li>
      <li>Have a sober friend present if trying this combination for the first time</li>
    </ul>
  `,
  "⚡": (a, b) => `
    <p><strong>Caution Advised:</strong> Combining ${a} and ${b} may increase side effects or intensify experiences beyond comfortable levels. This combination requires careful dosing and monitoring.</p>
    <p><strong>Potential Concerns:</strong> Increased heart rate, blood pressure changes, anxiety, or unexpected psychological effects.</p>
    <p><strong>Harm Reduction Tips:</strong></p>
    <ul>
      <li>Use significantly lower doses than you would take individually</li>
      <li>Wait longer between doses to assess effects</li>
      <li>Have benzodiazepines available if anxiety becomes overwhelming (only if prescribed)</li>
      <li>Avoid operating vehicles or machinery</li>
    </ul>
  `,
  "💊": (a, b) => `
    <p><strong>Strong Caution - Significant Interaction Risk:</strong> ${a} and ${b} have known pharmacological interactions that can significantly increase risks. This combination should be approached with extreme caution.</p>
    <p><strong>Specific Risks:</strong> Potential for serotonin syndrome, respiratory depression, cardiovascular stress, or unpredictable psychological effects.</p>
    <p><strong>Harm Reduction Tips:</strong></p>
    <ul>
      <li>Avoid this combination if possible</li>
      <li>If combining, use minimal doses and have medical supervision available</li>
      <li>Be aware of signs of overdose or adverse reactions</li>
      <li>Have naloxone available if opioids are involved</li>
      <li>Do not use alone</li>
    </ul>
  `,
  "💀": (a, b) => `
    <p><strong>DANGEROUS COMBINATION - AVOID:</strong> Combining ${a} and ${b} creates a high risk of fatal overdose, severe medical complications, or permanent harm. This is one of the most dangerous drug combinations known.</p>
    <p><strong>Specific Life-Threatening Risks:</strong> Profound respiratory depression, cardiac arrest, seizure risk, extreme hyperthermia, or coma.</p>
    <p><strong>CRITICAL SAFETY INFORMATION:</strong></p>
    <ul>
      <li><strong>DO NOT COMBINE THESE SUBSTANCES</strong></li>
      <li>If accidental exposure occurs, call emergency services immediately</li>
      <li>Have multiple doses of naloxone available if opioids are involved</li>
      <li>This combination has resulted in numerous fatal overdoses</li>
      <li>Consider alternative substances that don't carry this extreme risk</li>
    </ul>
  `
};

const trioExplanations = {
  "🌈": (a, b, c) => `
    <p><strong>Three-Way Combination Assessment:</strong> While no major red flags are present for combining ${a}, ${b}, and ${c}, the complexity increases significantly with three substances.</p>
    <p><strong>Harm Reduction Strategy:</strong> Introduce substances sequentially with ample time between to assess effects. Consider eliminating one substance from the combination to reduce variables.</p>
  `,
  "⚡": (a, b, c) => `
    <p><strong>Three-Way Combination - Elevated Risk:</strong> Combining ${a}, ${b}, and ${c} creates overlapping effects that may be difficult to predict or manage.</p>
    <p><strong>Harm Reduction Strategy:</strong> Extreme caution advised. Consider eliminating the highest-risk pair from this combination. Have sober supervision and emergency contacts readily available.</p>
  `,
  "💊": (a, b, c) => `
    <p><strong>Three-Way Combination - High Risk:</strong> This combination of ${a}, ${b}, and ${c} includes significant interaction risks that compound when combined.</p>
    <p><strong>Harm Reduction Strategy:</strong> Strongly consider avoiding this combination entirely. If proceeding, have medical supervision, naloxone if opioids are involved, and clear emergency protocols.</p>
  `,
  "💀": (a, b, c) => `
    <p><strong>THREE-WAY COMBINATION - EXTREME DANGER:</strong> This combination of ${a}, ${b}, and ${c} includes known dangerous pairs that create a potentially fatal scenario.</p>
    <p><strong>CRITICAL WARNING:</strong> This combination should be avoided under all circumstances. The risk of fatal overdose or severe medical emergency is extremely high.</p>
  `
};

/* ============================================================
   UI: Populate selects, render matrix, save functionality, share
============================================================ */
const allSubs = headers.slice(); // 21 including Viagra

function fillSelect(id){
  const sel = document.getElementById(id);
  sel.innerHTML = '<option value="">— Select —</option>' + allSubs.map(s=>`<option>${s}</option>`).join('');
}
["drugA","drugB","drugC"].forEach(fillSelect);

function iconExplain(x){
  switch(x){
    case "🌈": return "Low concern / typical co-use profile reported";
    case "⚡": return "Caution — increased side-effect potential; go slow";
    case "💊": return "Strong caution — meaningful interaction risk";
    case "💀": return "Danger — avoid / high overdose or medical risk";
    default: return "—";
  }
}

function getRiskClass(icon) {
  switch(icon) {
    case "🌈": return "risk-low";
    case "⚡": return "risk-caution";
    case "💊": return "risk-strong";
    case "💀": return "risk-danger";
    default: return "";
  }
}

function getRiskIcon(icon) {
  switch(icon) {
    case "🌈": return "🌈";
    case "⚡": return "⚡";
    case "💊": return "💊";
    case "💀": return "💀";
    default: return "";
  }
}

function renderPairs(sel){
  // Unique pairs + worst icon
  const pairs = [];
  const rank = {"🌈":1,"⚡":2,"💊":3,"💀":4};
  let worst = "🌈";
  for (let i=0;i<sel.length;i++){
    for (let j=i+1;j<sel.length;j++){
      const a = sel[i], b = sel[j];
      const v = mini.get(`${a}|${b}`) ?? mini.get(`${b}|${a}`) ?? "⚡";
      pairs.push({a,b,v});
      if (rank[v] > rank[worst]) worst = v;
    }
  }
  return {pairs,worst};
}

function tripleAdvisory(sel, worst){
  if (sel.length<3) return "";
  const [a,b,c]=sel;
  return `<div class="pair-detail ${getRiskClass(worst)}">
    <h4>Three-Way Combination: ${a} + ${b} + ${c} → ${worst}</h4>
    <span class="risk-icon">${getRiskIcon(worst)}</span>
    ${trioExplanations[worst](a, b, c)}
  </div>`;
}

// Store current results for sharing
let currentResults = '';

document.getElementById("checkBtn").addEventListener("click", ()=>{
  const sel = ["drugA","drugB","drugC"].map(id=>document.getElementById(id).value).filter(Boolean);
  const box = document.getElementById("resultBox");
  if (sel.length<2){
    box.innerHTML = `<h3>Please select at least two substances.</h3>`;
    document.getElementById("shareResults").style.display = "none";
    return;
  }
  const {pairs,worst} = renderPairs(sel);
  
  let content = `<h3><i class="fas fa-clipboard-check"></i> Interaction Analysis</h3>`;
  
  // Add detailed explanations for each pair
  pairs.forEach(pair => {
    content += `
      <div class="pair-detail ${getRiskClass(pair.v)}">
        <h4>${pair.a} + ${pair.b} → ${pair.v}</h4>
        <span class="risk-icon">${getRiskIcon(pair.v)}</span>
        ${detailedExplanations[pair.v](pair.a, pair.b)}
      </div>
    `;
  });
  
  // Add trio advisory if applicable
  if (sel.length === 3) {
    content += tripleAdvisory(sel, worst);
  }
  
  content += `<p style="margin-top:1rem;color:var(--muted);font-size:0.9rem;">Remember: individual responses vary based on dosage, tolerance, metabolism, and underlying health conditions. This information is for harm reduction purposes only.</p>`;
  
  box.innerHTML = content;
  
  // Store results for sharing
  currentResults = `
PLURderapolis Interaction Check Results:

${sel.join(' + ')}
${pairs.map(pair => `${pair.a} + ${pair.b}: ${pair.v}`).join('\n')}

${sel.length === 3 ? `Three-way combination: ${worst}` : ''}

Checked at: ${new Date().toLocaleString()}
  `.trim();
  
  // Show share buttons
  document.getElementById("shareResults").style.display = "flex";
  
  // Scroll to results
  box.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
});

// Render matrix table with clickable cells
(function renderMatrix(){
  const tbl = document.getElementById("matrixTable");
  const thead = document.createElement("thead");
  const hrow = document.createElement("tr");
  hrow.appendChild(document.createElement("th")).textContent = "↓ / →";
  headers.forEach(h=>{ const th=document.createElement("th"); th.textContent=h; hrow.appendChild(th); });
  thead.appendChild(hrow);
  const tbody = document.createElement("tbody");
  headers.forEach(r=>{
    const tr = document.createElement("tr");
    const rowTh = document.createElement("th"); rowTh.textContent=r; tr.appendChild(rowTh);
    headers.forEach(c=>{
      const td = document.createElement("td");
      td.setAttribute("data-label", c);
      const val = mini.get(`${r}|${c}`) ?? mini.get(`${c}|${r}`) ?? "🌈";
      td.textContent = val;
      td.className = getRiskClass(val);
      td.title = `${r} + ${c}: ${iconExplain(val)}`;
      
      // Add click event to show detailed explanation
      td.addEventListener('click', () => {
        showMatrixDetail(r, c, val);
      });
      
      tr.appendChild(td);
    });
    tbody.appendChild(tr);
  });
  tbl.appendChild(thead); tbl.appendChild(tbody);
})();

// Show matrix detail modal
function showMatrixDetail(substanceA, substanceB, riskLevel) {
  const modal = document.getElementById('matrixModal');
  const modalTitle = document.getElementById('matrixModalTitle');
  const modalBody = document.getElementById('matrixModalBody');
  
  modalTitle.innerHTML = `<i class="fas fa-info-circle"></i> ${substanceA} + ${substanceB} → ${riskLevel}`;
  
  let content = '';
  
  if (substanceA === substanceB) {
    content = `
      <div class="pair-detail ${getRiskClass(riskLevel)}">
        <p><strong>Same Substance Combination:</strong> Using ${substanceA} with itself typically doesn't present additional interaction risks beyond the normal effects of the substance itself.</p>
        <p><strong>Harm Reduction Tips:</strong></p>
        <ul>
          <li>Be mindful of cumulative dosing and tolerance</li>
          <li>Follow standard harm reduction practices for this substance</li>
          <li>Remember that redosing increases risks even with the same substance</li>
        </ul>
      </div>
    `;
  } else {
    content = detailedExplanations[riskLevel](substanceA, substanceB);
  }
  
  modalBody.innerHTML = content;
  modal.style.display = 'flex';
}

// Close matrix modal
document.getElementById('matrixModalClose').addEventListener('click', () => {
  document.getElementById('matrixModal').style.display = 'none';
});

// Close modal when clicking outside
document.getElementById('matrixModal').addEventListener('click', (e) => {
  if (e.target === document.getElementById('matrixModal')) {
    document.getElementById('matrixModal').style.display = 'none';
  }
});

// Create floating particles
function createParticles() {
  const particlesContainer = document.getElementById('particles');
  const particleCount = 30;
  
  for (let i = 0; i < particleCount; i++) {
    const particle = document.createElement('div');
    particle.classList.add('particle');
    
    // Random position
    const left = Math.random() * 100;
    const delay = Math.random() * 15;
    const duration = 15 + Math.random() * 10;
    
    particle.style.left = `${left}vw`;
    particle.style.animationDelay = `${delay}s`;
    particle.style.animationDuration = `${duration}s`;
    
    particlesContainer.appendChild(particle);
  }
}

// Hamburger menu functionality
const hamburgerBtn = document.getElementById('hamburgerBtn');
const dropdownContent = document.getElementById('dropdownContent');

hamburgerBtn.addEventListener('click', (e) => {
  e.stopPropagation();
  dropdownContent.style.display = dropdownContent.style.display === 'block' ? 'none' : 'block';
});

// Close dropdown when clicking outside
document.addEventListener('click', () => {
  dropdownContent.style.display = 'none';
});

// Home link functionality
document.getElementById('homeLink').addEventListener('click', () => {
  // In a real implementation, this would navigate to the home page
  // For this demo, we'll just scroll to top
  window.scrollTo({ top: 0, behavior: 'smooth' });
});

// Share results functionality
document.getElementById('copyResults').addEventListener('click', () => {
  navigator.clipboard.writeText(currentResults)
    .then(() => {
      alert('Results copied to clipboard!');
    })
    .catch(err => {
      console.error('Failed to copy: ', err);
      alert('Failed to copy results. Please try again.');
    });
});

document.getElementById('saveResults').addEventListener('click', () => {
  const blob = new Blob([currentResults], {type: 'text/plain'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'plurderapolis-interaction-results.txt';
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
});

document.getElementById('shareTwitter').addEventListener('click', () => {
  const text = encodeURIComponent('Check out my drug interaction results from PLURderapolis!');
  const url = encodeURIComponent(window.location.href);
  window.open(`https://twitter.com/intent/tweet?text=${text}&url=${url}`, '_blank');
});

document.getElementById('shareReddit').addEventListener('click', () => {
  const title = encodeURIComponent('PLURderapolis Drug Interaction Results');
  const url = encodeURIComponent(window.location.href);
  window.open(`https://www.reddit.com/submit?title=${title}&url=${url}`, '_blank');
});

// Save page functionality
const saveModal = document.getElementById("saveModal");
const savePageBtn = document.getElementById("savePageBtn");
const closeModal = document.getElementById("closeModal");

savePageBtn.addEventListener("click", () => {
  saveModal.style.display = "flex";
});

closeModal.addEventListener("click", () => {
  saveModal.style.display = "none";
});

// Save options
document.getElementById("savePdf").addEventListener("click", () => {
  alert("PDF generation would be implemented here with a library like jsPDF");
  saveModal.style.display = "none";
});

document.getElementById("saveHtml").addEventListener("click", () => {
  // Create a clone of the page content
  const content = document.querySelector('.wrap').cloneNode(true);
  
  // Remove interactive elements that won't work in a saved HTML
  const buttons = content.querySelectorAll('button');
  buttons.forEach(btn => {
    if (btn.id !== 'backButton') {
      btn.remove();
    }
  });
  
  // Remove selects
  const selects = content.querySelectorAll('select');
  selects.forEach(select => select.remove());
  
  // Create a new HTML document
  const htmlContent = `
    <!DOCTYPE html>
    <html>
    <head>
      <title>PLURderapolis Polydrug Interaction Checker</title>
      <meta charset="utf-8">
      <style>
        ${document.querySelector('style').innerHTML}
      </style>
    </head>
    <body>
      ${content.outerHTML}
    </body>
    </html>
  `;
  
  // Create and download the file
  const blob = new Blob([htmlContent], {type: 'text/html'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'plurderapolis-drug-interactions.html';
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
  
  saveModal.style.display = "none";
});

document.getElementById("saveImage").addEventListener("click", () => {
  alert("Image capture would be implemented here with a library like html2canvas");
  saveModal.style.display = "none";
});

// Share button (Web Share API)
document.getElementById("shareBtn").addEventListener("click", async ()=>{
  try{
    if (navigator.share){
      await navigator.share({title:"PLURderapolis Polydrug Matrix", text:"Check interactions + harm reduction tips", url:location.href});
    } else {
      alert("Copy this page URL to share:\n"+location.href);
    }
  }catch(e){ /* user cancelled */ }
});

// Back to top button functionality
const backToTopBtn = document.getElementById('backToTop');
window.addEventListener('scroll', () => {
  if (window.pageYOffset > 300) {
    backToTopBtn.style.display = 'block';
  } else {
    backToTopBtn.style.display = 'none';
  }
});

backToTopBtn.addEventListener('click', () => {
  window.scrollTo({ top: 0, behavior: 'smooth' });
});

// Close modal when clicking outside
window.addEventListener('click', (e) => {
  if (e.target === saveModal) {
    saveModal.style.display = 'none';
  }
});

// Add smooth scrolling for all anchor links
document.querySelectorAll('a[href^="#"]').forEach(anchor => {
  anchor.addEventListener('click', function (e) {
    e.preventDefault();
    const target = document.querySelector(this.getAttribute('href'));
    if (target) {
      target.scrollIntoView({
        behavior: 'smooth',
        block: 'start'
      });
    }
  });
});

// Initialize particles
createParticles();
</script>
</body>
</html>
