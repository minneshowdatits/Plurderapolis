<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Polydrug Risks & Interaction Checker | PLURderapolis</title>
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@600;800&family=Open+Sans:wght@400;600&display=swap" rel="stylesheet" />
<style>
  :root{
    --bg:#121212;
    --card:#1b0b1b;
    --ink:#eee;
    --muted:#bcbcbc;
    --accent:#bf00bf;
    --accent-2:#e051ff;
    --line:#440044;
    --chip:#550055;
    --shadow:0 0 12px rgba(191,0,191,.25);
    --danger:#ff4d4d;
    --caution:#ffb84d;
    --low-risk:#4dff88;
  }
  *{box-sizing:border-box}
  html,body{margin:0;padding:0;background:var(--bg);color:var(--ink);font-family:'Open Sans',system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
  a{color:var(--accent); text-decoration: none; transition: all 0.3s ease;}
  a:hover {color: var(--accent-2); text-shadow: 0 0 8px rgba(224, 81, 255, 0.5);}
  .wrap{max-width:1000px;margin:auto;padding:16px}
  h1,h2,h3{font-family:'Montserrat',sans-serif;letter-spacing:.2px}
  h1{font-size:clamp(1.6rem,2.5vw,2.2rem);color:var(--accent);margin:8px 0 6px}
  p.lede{color:#f0d1ff;margin:.25rem 0 1rem}
  
  /* Navigation */
  .navigation {display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 10px;}
  .nav-links {display: flex; gap: 15px; flex-wrap: wrap;}
  .nav-button {background: var(--chip); color: var(--ink); border: 1px solid var(--line); border-radius: 999px; padding: 8px 15px; font-weight: 700; cursor: pointer; transition: all 0.3s ease; display: flex; align-items: center; gap: 5px;}
  .nav-button:hover {background: var(--accent); transform: translateY(-2px); box-shadow: 0 4px 8px rgba(191, 0, 191, 0.3);}
  
  /* Header branding */
  .branding{display:flex;align-items:center;gap:10px;margin-bottom:10px}
  .logo{font-size:1.8rem;font-weight:800;color:var(--accent);background:linear-gradient(45deg, var(--accent), var(--accent-2));-webkit-background-clip:text;-webkit-text-fill-color:transparent; animation: logoPulse 4s infinite ease-in-out;}
  @keyframes logoPulse {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.05); }
  }
  .tagline{color:var(--muted);font-size:.9rem}
  /* Top checker card */
  .tool{background:var(--card);border-radius:14px;padding:14px;box-shadow:var(--shadow);position:sticky;top:0.35rem;z-index:5; animation: fadeIn 0.8s ease-out;}
  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
  }
  .tool h2{font-size:1.1rem;margin:.2rem 0 .6rem;color:var(--accent-2)}
  .row{display:flex;gap:8px;flex-wrap:wrap}
  .sel{flex:1 1 180px;min-width:160px;display:flex;flex-direction:column;gap:6px}
  label{font-weight:700;color:var(--accent);font-size:.9rem}
  select{width:100%;padding:.6rem .7rem;border:1px solid var(--line);border-radius:10px;background:#220022;color:var(--ink);appearance:none; transition: all 0.3s ease;}
  select:focus {outline: none; border-color: var(--accent-2); box-shadow: 0 0 0 2px rgba(224, 81, 255, 0.3);}
  button.primary{background:var(--accent);color:#fff;border:0;border-radius:10px;padding:.7rem 1rem;font-weight:800;cursor:pointer; transition: all 0.3s ease;}
  button.primary:hover {background: var(--accent-2); transform: translateY(-2px); box-shadow: 0 4px 12px rgba(191, 0, 191, 0.4);}
  button.primary:active{transform:translateY(1px)}
  .icons{font-size:1.05rem;opacity:.95; animation: iconGlow 2s infinite alternate;}
  @keyframes iconGlow {
    from { text-shadow: 0 0 5px rgba(191, 0, 191, 0.5); }
    to { text-shadow: 0 0 10px rgba(224, 81, 255, 0.8); }
  }
  .result{margin-top:10px;border:1px dashed var(--line);border-radius:12px;padding:10px;background:#170717; animation: slideIn 0.5s ease-out;}
  @keyframes slideIn {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
  }
  .result h3{margin:.2rem 0 .4rem;color:#ffd6ff;font-size:1rem}
  .pairs{margin:.4rem 0 0;padding-left:18px}
  .pair-detail{background:#1f001f;border-radius:8px;padding:12px;margin:8px 0;border-left:4px solid var(--accent); animation: fadeInUp 0.5s ease-out;}
  @keyframes fadeInUp {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
  }
  .pair-detail.risk-low{border-left-color:var(--low-risk)}
  .pair-detail.risk-caution{border-left-color:var(--caution)}
  .pair-detail.risk-strong{border-left-color:var(--accent)}
  .pair-detail.risk-danger{border-left-color:var(--danger)}
  .legend{display:flex;gap:10px;flex-wrap:wrap;margin:8px 0 0;font-size:.95rem;color:var(--muted)}
  .legend span{display:inline-flex;gap:6px;align-items:center;background:#200120;border:1px solid var(--line);border-radius:999px;padding:.25rem .6rem; transition: all 0.3s ease;}
  .legend span:hover {transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);}
  /* Matrix */
  .controls{display:flex;align-items:center;gap:10px;margin:14px 0 8px;flex-wrap:wrap}
  .download{background:var(--accent);color:#fff;border:0;border-radius:999px;padding:.55rem .9rem;font-weight:800;cursor:pointer; transition: all 0.3s ease;}
  .download:hover {background: var(--accent-2); transform: translateY(-2px); box-shadow: 0 4px 12px rgba(191, 0, 191, 0.4);}
  .share{background:#2a002a;color:#fff;border:1px solid var(--line);border-radius:999px;padding:.55rem .9rem;font-weight:700;cursor:pointer; transition: all 0.3s ease;}
  .share:hover {background: #3a003a; transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);}
  .matrix{overflow:auto;border-radius:12px;box-shadow:var(--shadow);border:1px solid var(--line);background:#160616; animation: fadeIn 0.8s ease-out 0.2s both;}
  table{border-collapse:collapse;width:100%;min-width:980px;font-size:.92rem}
  th,td{border:1px solid var(--line);padding:.45rem .55rem;text-align:center;vertical-align:middle; transition: all 0.3s ease;}
  thead th{position:sticky;top:0;background:#3b0a3b;color:#ffe5ff;z-index:2}
  tbody th{position:sticky;left:0;background:#2a002a;color:#fff;z-index:1}
  td{background:#1f001f; transition: all 0.3s ease;}
  td:hover {transform: scale(1.05); z-index: 3; box-shadow: 0 0 10px rgba(191, 0, 191, 0.5);}
  td.risk-low{background:#0a2a14}
  td.risk-caution{background:#2a200a}
  td.risk-strong{background:#2a0a2a}
  td.risk-danger{background:#2a0a0a}
  .chip {display:inline-block;background:var(--chip);border-radius:999px;padding:.18rem .55rem;font-weight:700; transition: all 0.3s ease;}
  .chip:hover {transform: scale(1.05); background: var(--accent);}
  /* Sections at bottom (accordion) */
  details.info{background:var(--card);border:1px solid var(--line);border-radius:12px;padding:.6rem .8rem;margin:.6rem 0; transition: all 0.3s ease;}
  details.info:hover {border-color: var(--accent);}
  details.info summary{cursor:pointer;font-weight:800;list-style:none; transition: all 0.3s ease;}
  details.info summary:hover {color: var(--accent-2);}
  details.info summary::marker, details.info summary::-webkit-details-marker{display:none}
  details.info summary .tag{margin-left:.5rem;opacity:.85}
  details.info[open] {animation: accordionOpen 0.5s ease-out;}
  @keyframes accordionOpen {
    from { opacity: 0; max-height: 0; }
    to { opacity: 1; max-height: 500px; }
  }
  /* Back to top button */
  .back-to-top{position:fixed;bottom:20px;right:20px;background:var(--accent);color:#fff;border:0;border-radius:50%;width:50px;height:50px;font-size:1.5rem;cursor:pointer;box-shadow:var(--shadow);z-index:100;display:none; transition: all 0.3s ease;}
  .back-to-top:hover {background: var(--accent-2); transform: translateY(-3px) scale(1.1); box-shadow: 0 6px 15px rgba(191, 0, 191, 0.5);}
  /* Footer */
  footer{border-top:1px solid var(--line);color:var(--muted);font-size:.9rem;padding:18px;margin-top:16px;text-align:center; animation: fadeIn 0.8s ease-out 0.4s both;}
  .pill{display:inline-block;background:var(--chip);padding:.22rem .6rem;border-radius:999px;font-weight:800; transition: all 0.3s ease;}
  .pill:hover {transform: scale(1.05); background: var(--accent);}
  /* Mobile niceties */
  @media (max-width:640px){
    .tool{position:static}
    .legend{font-size:.9rem}
    table{font-size:.86rem;min-width:840px}
    .controls{flex-direction:column;align-items:flex-start}
    .navigation {flex-direction: column; align-items: flex-start;}
    .nav-links {margin-top: 10px;}
  }
</style>
</head>
<body>
  <div class="wrap">
    <!-- Navigation -->
    <div class="navigation">
      <button class="nav-button" id="backButton" onclick="history.back()">‚Üê Back</button>
      <div class="nav-links">
        <a href="resources.html" class="nav-button">üìö Resources</a>
        <a href="emergency.html" class="nav-button">üö® Emergency</a>
        <a href="spiking.html" class="nav-button">‚ö†Ô∏è Spiking</a>
        <a href="fake.html" class="nav-button">üîç Fake Drugs</a>
      </div>
    </div>
    
    <!-- PLURderapolis branding -->
    <div class="branding">
      <div class="logo">PLURderapolis</div>
      <div class="tagline">Harm Reduction & Community Safety</div>
    </div>
    
    <h1>Polydrug Interaction Checker <span class="icons">‚ö°üíäüíÄüåà</span></h1>
    <p class="lede">Mobile-first, harm-reduction focused. Pick up to three substances and see risks & tips. Matrix is downloadable + shareable.</p>

    <!-- ===== Interaction Checker (TOP) ===== -->
    <section class="tool" aria-label="Polydrug Interaction Checker">
      <h2>Quick Check</h2>
      <div class="row">
        <div class="sel">
          <label for="drugA">Substance A</label>
          <select id="drugA"></select>
        </div>
        <div class="sel">
          <label for="drugB">Substance B</label>
          <select id="drugB"></select>
        </div>
        <div class="sel">
          <label for="drugC">Substance C (optional)</label>
          <select id="drugC"></select>
        </div>
        <div class="sel" style="align-self:flex-end">
          <button class="primary" id="checkBtn">Check <span class="icons">‚ö°</span></button>
        </div>
      </div>

      <div class="legend" aria-label="Legend">
        <span><b>üåà</b> Low concern / typical</span>
        <span><b>‚ö°</b> Caution</span>
        <span><b>üíä</b> Strong caution / interaction risk</span>
        <span><b>üíÄ</b> Dangerous / avoid</span>
      </div>

      <div class="result" id="resultBox" aria-live="polite">
        <h3>Results will appear here</h3>
        <p>We'll show A+B, A+C, B+C and a combined A+B+C overview with detailed harm-reduction pointers.</p>
      </div>
    </section>

    <!-- ===== Controls + Matrix ===== -->
    <div class="controls">
      <button class="download" id="dlCsv">Download Matrix (CSV)</button>
      <button class="download" id="dlJson">Download Matrix (JSON)</button>
      <button class="share" id="shareBtn">Share Page</button>
      <span class="muted" style="color:var(--muted)">Tip: drag left/right to explore the grid on mobile.</span>
    </div>

    <div class="matrix" role="region" aria-label="Combo Risk Matrix">
      <table id="matrix"></table>
    </div>

    <!-- ===== Tips (quick) ===== -->
    <details class="info" open>
      <summary>üí° Harm Reduction Tips <span class="tag">(quick)</span></summary>
      <ul>
        <li>Test what you can. Start low, go slow. Space redoses.</li>
        <li><span class="pill">Never stack depressants</span> (alcohol, benzos, GHB, opioids) ‚Äî biggest driver of fatal ODs.</li>
        <li>Heat + stimulants = risk. Cool environment, electrolyte sips, rest breaks.</li>
        <li>Carry naloxone if opioids could be around. Don't use alone. Recovery position if someone is out.</li>
        <li>On Rx meds? Avoid chasing "muted" effects by redosing ‚Äî risk goes up even if euphoria doesn't.</li>
      </ul>
    </details>

    <!-- ===== Category cards at bottom ===== -->
    <h2 style="margin-top:14px;color:var(--accent-2)">Combo Categories</h2>

    <details class="info"><summary>üíä Depressant √ó Depressant <span class="tag">benzodiazepines, alcohol, GHB, opioids, trazodone, gabapentin</span></summary>
      <p><b>Risk:</b> <b>üíÄ</b> ‚Äî synergistic respiratory depression, blackouts, aspiration.</p>
      <ul>
        <li>Keep people awake & breathing; recovery position if unresponsive.</li>
        <li>Naloxone reverses opioids (not benzos/GHB); still call EMS.</li>
      </ul>
    </details>

    <details class="info"><summary>‚ö° Stimulant √ó Stimulant <span class="tag">MDMA, cocaine, ADHD meds, bupropion</span></summary>
      <p><b>Risk:</b> <b>üíä‚ÜíüíÄ</b> ‚Äî hypertension, hyperthermia, arrhythmia, panic.</p>
      <ul>
        <li>Avoid stacking; cool down, hydrate, don't chase muted highs.</li>
      </ul>
    </details>

    <details class="info"><summary>‚ö° Stimulant √ó Depressant <span class="tag">e.g., cocaine+alcohol, MDMA+GHB</span></summary>
      <p><b>Risk:</b> <b>üíä</b> ‚Äî masking sedation, dehydration, liver stress (cocaethylene with alcohol+cocaine).</p>
      <ul>
        <li>Don't redose to "even it out". Watch breathing and heat load.</li>
      </ul>
    </details>

    <details class="info"><summary>üåà/‚ö° Psychedelics with Cannabis</summary>
      <p>Can potentiate intensity/anxiety. Delay THC until past peak; micro-puffs if at all.</p>
    </details>

    <details class="info"><summary>‚ö° Dissociative √ó Depressant <span class="tag">ketamine/nitrous + alcohol/benzos/GHB</span></summary>
      <p>Hypoxia/airway risk + amnesia. Sit down, supervised, fresh air breaks.</p>
    </details>

    <!-- ===== Legal disclaimer (single) ===== -->
    <footer>
      <p><strong>Legal & Medical Disclaimer:</strong> Educational content only; not medical advice. No mix is 100% safe. Accuracy is prioritized using established harm-reduction resources (TripSit, DanceSafe, IMPACT SF, TheBody) plus your local notes, but contexts differ. If someone shows trouble breathing, severe chest pain, seizures, or won't wake, call emergency services.</p>
      <p>¬© 2025 PLURderapolis ‚Ä¢ <span class="pill">Stay safe. Stay kind.</span></p>
    </footer>
  </div>

  <!-- Back to top button -->
  <button class="back-to-top" id="backToTop" aria-label="Back to top">‚Üë</button>

<script>
/* ============================================================
   DATA INGEST: Your original 20-substance matrix (as posted)
   Symbols: ‚Äî, üü¢, üü°, üî¥, ‚ö†Ô∏è, ‚ùå, ‚ò†Ô∏è
   We will translate to minimalist icons later.
============================================================ */
const originalHeaders = ["Cannabis","Ketamine","MDMA","Cocaine","Alcohol","GHB / Opioids","Benzos","SSRIs","SNRIs","ADHD Meds","Antipsychotics","Mood Stabilizers","Wellbutrin","Trazodone","Gabapentin","LSD","Shrooms","Nitrous","DMT","GHB"];
// NOTE: Your pasted table had 20 columns; the last header label you included row-wise was "GHB" again.
// We're trusting the body rows you posted below (they match 20-wide). The body:
const originalRows = [
  ["Cannabis","‚Äî","üü°","üî¥","üî¥","üî¥","üî¥","üî¥","üü°","üü°","üü¢","üü°","üü°","üü¢","üü¢","üü¢","üî¥","üî¥","üü¢","üî¥","üî¥"],
  ["Ketamine","üü°","‚Äî","‚ùå","‚ùå","‚ùå","‚ùå","üü°","üü°","üü°","üî¥","üü°","üü°","üü°","üü°","üü°","‚ùå","‚ùå","üü°","‚ùå","‚ùå"],
  ["MDMA","üî¥","‚ùå","‚Äî","üî¥","üî¥","‚ùå","üî¥","üî¥","‚ùå","‚ùå","‚ùå","‚ùå","‚ùå","üî¥","üî¥","üî¥","üî¥","üî¥","‚ùå","‚ùå"],
  ["Cocaine","üî¥","‚ùå","üî¥","‚Äî","üî¥","‚ùå","üî¥","üî¥","‚ùå","‚ùå","üî¥","üî¥","üî¥","üî¥","üî¥","üî¥","üî¥","üî¥","‚ùå","‚ùå"],
  ["Alcohol","üî¥","‚ùå","üî¥","üî¥","‚Äî","‚ùå","‚ò†Ô∏è","‚ö†Ô∏è","‚ö†Ô∏è","‚ö†Ô∏è","‚ö†Ô∏è","‚ö†Ô∏è","‚ùå","‚ùå","‚ùå","üî¥","üî¥","‚ùå","‚ùå","‚ò†Ô∏è"],
  ["GHB / Opioids","üî¥","‚ùå","‚ùå","‚ùå","‚ò†Ô∏è","‚Äî","‚ò†Ô∏è","‚ö†Ô∏è","‚ö†Ô∏è","‚ö†Ô∏è","‚ö†Ô∏è","‚ö†Ô∏è","‚ö†Ô∏è","‚ö†Ô∏è","‚ö†Ô∏è","‚ùå","‚ùå","‚ö†Ô∏è","‚ò†Ô∏è","‚Äî"],
  ["Benzos","üî¥","üü°","üî¥","üî¥","‚ò†Ô∏è","‚ò†Ô∏è","‚Äî","‚ö†Ô∏è","‚ö†Ô∏è","‚ö†Ô∏è","‚ö†Ô∏è","‚ö†Ô∏è","‚ö†Ô∏è","‚ö†Ô∏è","‚ö†Ô∏è","‚ö†Ô∏è","‚ö†Ô∏è","‚ö†Ô∏è","‚ò†Ô∏è","‚ö†Ô∏è"],
  ["SSRIs","üü°","üü°","üî¥","üî¥","‚ö†Ô∏è","‚ö†Ô∏è","‚ö†Ô∏è","‚Äî","‚ö†Ô∏è","‚ö†Ô∏è","‚ö†Ô∏è","‚ö†Ô∏è","‚ö†Ô∏è","‚ö†Ô∏è","‚ö†Ô∏è","‚ö†Ô∏è","‚ö†Ô∏è","‚ö†Ô∏è","‚ö†Ô∏è","‚ö†Ô∏è"],
  ["SNRIs","üü°","üü°","‚ùå","‚ùå","‚ö†Ô∏è","‚ö†Ô∏è","‚ö†Ô∏è","‚ö†Ô∏è","‚Äî","‚ö†Ô∏è","‚ö†Ô∏è","‚ö†Ô∏è","‚ö†Ô∏è","‚ö†Ô∏è","‚ö†Ô∏è","‚ö†Ô∏è","‚ö†Ô∏è","‚ö†Ô∏è","‚ö†Ô∏è","‚ö†Ô∏è"],
  ["ADHD Meds","üü¢","üü°","‚ùå","‚ùå","‚ö†Ô∏è","‚ö†Ô∏è","‚ö†Ô∏è","‚ö†Ô∏è","‚ö†Ô∏è","‚Äî","üü°","üü°","üü°","üü°","üü°","‚ö†Ô∏è","‚ö†Ô∏è","‚ö†Ô∏è","‚ö†Ô∏è","‚ö†Ô∏è"],
  ["Antipsychotics","üü°","üü°","‚ùå","üî¥","‚ö†Ô∏è","‚ö†Ô∏è","‚ö†Ô∏è","‚ö†Ô∏è","‚ö†Ô∏è","üü°","‚Äî","üü°","üü°","üü°","üü°","‚ö†Ô∏è","‚ö†Ô∏è","‚ö†Ô∏è","‚ö†Ô∏è","‚ö†Ô∏è"],
  ["Mood Stabilizers","üü°","üü°","‚ùå","üî¥","‚ö†Ô∏è","‚ö†Ô∏è","‚ö†Ô∏è","‚ö†Ô∏è","‚ö†Ô∏è","üü°","üü°","‚Äî","üü°","üü°","üü°","‚ö†Ô∏è","‚ö†Ô∏è","‚ö†Ô∏è","‚ö†Ô∏è","‚ö†Ô∏è"],
  ["Wellbutrin","üü¢","üü°","‚ùå","üî¥","‚ùå","‚ö†Ô∏è","‚ö†Ô∏è","‚ö†Ô∏è","‚ö†Ô∏è","üü°","üü°","üü°","‚Äî","üü°","üü°","‚ö†Ô∏è","‚ö†Ô∏è","‚ö†Ô∏è","‚ö†Ô∏è","‚ö†Ô∏è"],
  ["Trazodone","üü¢","üü°","üî¥","üî¥","‚ùå","‚ö†Ô∏è","‚ö†Ô∏è","‚ö†Ô∏è","‚ö†Ô∏è","üü°","üü°","üü°","üü°","‚Äî","üü¢","‚ö†Ô∏è","‚ö†Ô∏è","‚ö†Ô∏è","‚ö†Ô∏è","‚ö†Ô∏è"],
  ["Gabapentin","üü¢","üü°","üî¥","üî¥","‚ùå","‚ö†Ô∏è","‚ö†Ô∏è","‚ö†Ô∏è","‚ö†Ô∏è","üü°","üü°","üü°","üü°","üü¢","‚Äî","‚ö†Ô∏è","‚ö†Ô∏è","‚ö†Ô∏è","‚ö†Ô∏è","‚ö†Ô∏è"],
  ["LSD","üî¥","üü°","üî¥","üî¥","üî¥","‚ùå","‚ö†Ô∏è","‚ö†Ô∏è","‚ö†Ô∏è","‚ö†Ô∏è","‚ö†Ô∏è","‚ö†Ô∏è","‚ö†Ô∏è","‚ö†Ô∏è","‚ö†Ô∏è","‚Äî","üü¢","üü°","üü°","üî¥"],
  ["Shrooms","üî¥","‚ùå","üî¥","üî¥","üî¥","‚ùå","‚ö†Ô∏è","‚ö†Ô∏è","‚ö†Ô∏è","‚ö†Ô∏è","‚ö†Ô∏è","‚ö†Ô∏è","‚ö†Ô∏è","üü¢","‚ö†Ô∏è","üü¢","‚Äî","üü°","üü°","üî¥"],
  ["Nitrous","üü¢","üü°","üî¥","üî¥","‚ùå","‚ö†Ô∏è","‚ö†Ô∏è","‚ö†Ô∏è","‚ö†Ô∏è","‚ö†Ô∏è","‚ö†Ô∏è","‚ö†Ô∏è","‚ö†Ô∏è","‚ö†Ô∏è","‚ö†Ô∏è","üü°","üü°","‚Äî","‚ö†Ô∏è","‚ö†Ô∏è"],
  ["DMT","üî¥","‚ùå","‚ùå","‚ùå","‚ùå","‚ò†Ô∏è","‚ö†Ô∏è","‚ö†Ô∏è","‚ö†Ô∏è","‚ö†Ô∏è","‚ö†Ô∏è","‚ö†Ô∏è","‚ö†Ô∏è","‚ö†Ô∏è","‚ö†Ô∏è","üî¥","üî¥","‚ö†Ô∏è","‚Äî","‚ò†Ô∏è"],
  ["GHB","üî¥","‚ùå","‚ùå","‚ò†Ô∏è","‚ò†Ô∏è","‚Äî","‚ò†Ô∏è","‚ö†Ô∏è","‚ö†Ô∏è","‚ö†Ô∏è","‚ö†Ô∏è","‚ö†Ô∏è","‚ö†Ô∏è","‚ö†Ô∏è","‚ö†Ô∏è","üî¥","üî¥","‚ö†Ô∏è","‚ò†Ô∏è","‚Äî"]
];

/* ============================================================
   TRANSLATION to minimalist icons
   ‚Äî, üü¢ -> üåà   |   üü° -> ‚ö°   |   üî¥/‚ö†Ô∏è -> üíä   |   ‚ùå/‚ò†Ô∏è -> üíÄ
============================================================ */
const toMini = s => {
  if (s==="‚Äî" || s==="üü¢") return "üåà";
  if (s==="üü°") return "‚ö°";
  if (s==="üî¥" || s==="‚ö†Ô∏è") return "üíä";
  if (s==="‚ùå" || s==="‚ò†Ô∏è") return "üíÄ";
  return s || "üåà";
};

/* ============================================================
   Expand "GHB / Opioids" -> split into "GHB" + "Opioids"
   Then add "Viagra". Non-specified Viagra cells are conservative.
============================================================ */
function buildExpandedMatrix(){
  // Build base map from original
  const baseCols = originalHeaders;
  const baseMap = new Map(); // key "row|col" -> minimalist icon
  for (const r of originalRows){
    const rowName = r[0];
    const cols = r.slice(1);
    cols.forEach((val,i)=>{
      const colName = baseCols[i];
      baseMap.set(`${rowName}|${colName}`, toMini(val));
    });
  }

  // Start list from original headers, but replace combined class with two
  const expanded = [
    "Cannabis","Ketamine","MDMA","Cocaine","Alcohol",
    "GHB","Opioids", // split
    "Benzos","SSRIs","SNRIs","ADHD Meds","Antipsychotics","Mood Stabilizers",
    "Wellbutrin","Trazodone","Gabapentin","LSD","Shrooms","Nitrous","DMT"
  ];

  // Helper to read combined mapping for either GHB or Opioids from "GHB / Opioids"
  const readCombined = (row, col) => {
    const key1 = `${row}|GHB / Opioids`;
    const key2 = `GHB / Opioids|${col}`;
    // prefer direct if exists
    if (baseMap.has(key1) && col==="GHB / Opioids") return baseMap.get(key1);
    if (baseMap.has(`${row}|${col}`)) return baseMap.get(`${row}|${col}`);
    if (baseMap.has(key1)) return baseMap.get(key1);
    if (baseMap.has(key2)) return baseMap.get(key2);
    return "‚ö°";
  };

  // Build expanded map (without Viagra yet)
  const m = new Map();

  // Copy all non-combined pairs first
  for (const r of expanded){
    for (const c of expanded){
      if (r===c){ m.set(`${r}|${c}`,"üåà"); continue; }
      // If either is GHB or Opioids, pull from combined where needed
      if ((r==="GHB" || r==="Opioids") && (c!=="GHB" && c!=="Opioids")){
        m.set(`${r}|${c}`, readCombined("GHB / Opioids", c));
        m.set(`${c}|${r}`, readCombined(c, "GHB / Opioids"));
      } else if ((c==="GHB" || c==="Opioids") && (r!=="GHB" && r!=="Opioids")){
        m.set(`${r}|${c}`, readCombined(r, "GHB / Opioids"));
        m.set(`${c}|${r}`, readCombined("GHB / Opioids", r));
      } else if ( (r!=="GHB" && r!=="Opioids") && (c!=="GHB" && c!=="Opioids") ){
        // both sides not split items: read from base
        const val = baseMap.get(`${r}|${c}`) ?? baseMap.get(`${c}|${r}`) ?? "‚ö°";
        m.set(`${r}|${c}`, val);
      }
    }
  }
  // Set explicit GHB <-> Opioids as üíÄ
  m.set("GHB|Opioids","üíÄ"); m.set("Opioids|GHB","üíÄ");

  // Now add Viagra row/col conservatively
  const withViagra = [...expanded, "Viagra"];
  for (const x of withViagra){
    if (x==="Viagra") continue;
  }
  // Defaults for Viagra
  const vDefaults = {
    "Cannabis":"üåà",
    "Ketamine":"‚ö°",
    "MDMA":"üíä",
    "Cocaine":"üíä",
    "Alcohol":"üíä",
    "GHB":"üíä",
    "Opioids":"üíä",
    "Benzos":"‚ö°",
    "SSRIs":"üåà",
    "SNRIs":"‚ö°",
    "ADHD Meds":"üíä",
    "Antipsychotics":"‚ö°",
    "Mood Stabilizers":"‚ö°",
    "Wellbutrin":"‚ö°",
    "Trazodone":"üíä",
    "Gabapentin":"üíä",
    "LSD":"‚ö°",
    "Shrooms":"‚ö°",
    "Nitrous":"üåà", // N2O ‚â† nitrites
    "DMT":"‚ö°"
  };
  for (const s of expanded){
    const val = vDefaults[s] ?? "‚ö°";
    m.set(`Viagra|${s}`, val);
    m.set(`${s}|Viagra`, val);
  }
  m.set("Viagra|Viagra","üåà");

  return {headers: withViagra, map:m};
}

const {headers, map:mini} = buildExpandedMatrix();

/* ============================================================
   Detailed explanations for each interaction
============================================================ */
const detailedExplanations = {
  "üåà": (a, b) => `
    <p><strong>Low Risk Interaction:</strong> ${a} and ${b} typically have minimal negative interactions when used together. However, individual responses can vary based on dosage, tolerance, and personal health factors.</p>
    <p><strong>Harm Reduction Tips:</strong></p>
    <ul>
      <li>Start with lower doses than you would take individually</li>
      <li>Stay hydrated and in a safe environment</li>
      <li>Have a sober friend present if trying this combination for the first time</li>
    </ul>
  `,
  "‚ö°": (a, b) => `
    <p><strong>Caution Advised:</strong> Combining ${a} and ${b} may increase side effects or intensify experiences beyond comfortable levels. This combination requires careful dosing and monitoring.</p>
    <p><strong>Potential Concerns:</strong> Increased heart rate, blood pressure changes, anxiety, or unexpected psychological effects.</p>
    <p><strong>Harm Reduction Tips:</strong></p>
    <ul>
      <li>Use significantly lower doses than you would take individually</li>
      <li>Wait longer between doses to assess effects</li>
      <li>Have benzodiazepines available if anxiety becomes overwhelming (only if prescribed)</li>
      <li>Avoid operating vehicles or machinery</li>
    </ul>
  `,
  "üíä": (a, b) => `
    <p><strong>Strong Caution - Significant Interaction Risk:</strong> ${a} and ${b} have known pharmacological interactions that can significantly increase risks. This combination should be approached with extreme caution.</p>
    <p><strong>Specific Risks:</strong> Potential for serotonin syndrome, respiratory depression, cardiovascular stress, or unpredictable psychological effects.</p>
    <p><strong>Harm Reduction Tips:</strong></p>
    <ul>
      <li>Avoid this combination if possible</li>
      <li>If combining, use minimal doses and have medical supervision available</li>
      <li>Be aware of signs of overdose or adverse reactions</li>
      <li>Have naloxone available if opioids are involved</li>
      <li>Do not use alone</li>
    </ul>
  `,
  "üíÄ": (a, b) => `
    <p><strong>DANGEROUS COMBINATION - AVOID:</strong> Combining ${a} and ${b} creates a high risk of fatal overdose, severe medical complications, or permanent harm. This is one of the most dangerous drug combinations known.</p>
    <p><strong>Specific Life-Threatening Risks:</strong> Profound respiratory depression, cardiac arrest, seizure risk, extreme hyperthermia, or coma.</p>
    <p><strong>CRITICAL SAFETY INFORMATION:</strong></p>
    <ul>
      <li><strong>DO NOT COMBINE THESE SUBSTANCES</strong></li>
      <li>If accidental exposure occurs, call emergency services immediately</li>
      <li>Have multiple doses of naloxone available if opioids are involved</li>
      <li>This combination has resulted in numerous fatal overdoses</li>
      <li>Consider alternative substances that don't carry this extreme risk</li>
    </ul>
  `
};

const trioExplanations = {
  "üåà": (a, b, c) => `
    <p><strong>Three-Way Combination Assessment:</strong> While no major red flags are present for combining ${a}, ${b}, and ${c}, the complexity increases significantly with three substances.</p>
    <p><strong>Harm Reduction Strategy:</strong> Introduce substances sequentially with ample time between to assess effects. Consider eliminating one substance from the combination to reduce variables.</p>
  `,
  "‚ö°": (a, b, c) => `
    <p><strong>Three-Way Combination - Elevated Risk:</strong> Combining ${a}, ${b}, and ${c} creates overlapping effects that may be difficult to predict or manage.</p>
    <p><strong>Harm Reduction Strategy:</strong> Extreme caution advised. Consider eliminating the highest-risk pair from this combination. Have sober supervision and emergency contacts readily available.</p>
  `,
  "üíä": (a, b, c) => `
    <p><strong>Three-Way Combination - High Risk:</strong> This combination of ${a}, ${b}, and ${c} includes significant interaction risks that compound when combined.</p>
    <p><strong>Harm Reduction Strategy:</strong> Strongly consider avoiding this combination entirely. If proceeding, have medical supervision, naloxone if opioids are involved, and clear emergency protocols.</p>
  `,
  "üíÄ": (a, b, c) => `
    <p><strong>THREE-WAY COMBINATION - EXTREME DANGER:</strong> This combination of ${a}, ${b}, and ${c} includes known dangerous pairs that create a potentially fatal scenario.</p>
    <p><strong>CRITICAL WARNING:</strong> This combination should be avoided under all circumstances. The risk of fatal overdose or severe medical emergency is extremely high.</p>
  `
};

/* ============================================================
   UI: Populate selects, render matrix, CSV download, share
============================================================ */
const allSubs = headers.slice(); // 21 including Viagra

function fillSelect(id){
  const sel = document.getElementById(id);
  sel.innerHTML = '<option value="">‚Äî Select ‚Äî</option>' + allSubs.map(s=>`<option>${s}</option>`).join('');
}
["drugA","drugB","drugC"].forEach(fillSelect);

function iconExplain(x){
  switch(x){
    case "üåà": return "Low concern / typical co-use profile reported";
    case "‚ö°": return "Caution ‚Äî increased side-effect potential; go slow";
    case "üíä": return "Strong caution ‚Äî meaningful interaction risk";
    case "üíÄ": return "Danger ‚Äî avoid / high overdose or medical risk";
    default: return "‚Äî";
  }
}

function getRiskClass(icon) {
  switch(icon) {
    case "üåà": return "risk-low";
    case "‚ö°": return "risk-caution";
    case "üíä": return "risk-strong";
    case "üíÄ": return "risk-danger";
    default: return "";
  }
}

function renderPairs(sel){
  // Unique pairs + worst icon
  const pairs = [];
  const rank = {"üåà":1,"‚ö°":2,"üíä":3,"üíÄ":4};
  let worst = "üåà";
  for (let i=0;i<sel.length;i++){
    for (let j=i+1;j<sel.length;j++){
      const a = sel[i], b = sel[j];
      const v = mini.get(`${a}|${b}`) ?? mini.get(`${b}|${a}`) ?? "‚ö°";
      pairs.push({a,b,v});
      if (rank[v] > rank[worst]) worst = v;
    }
  }
  return {pairs,worst};
}

function tripleAdvisory(sel, worst){
  if (sel.length<3) return "";
  const [a,b,c]=sel;
  return `<div class="pair-detail ${getRiskClass(worst)}">
    <h4>Three-Way Combination: ${a} + ${b} + ${c} ‚Üí ${worst}</h4>
    ${trioExplanations[worst](a, b, c)}
  </div>`;
}

document.getElementById("checkBtn").addEventListener("click", ()=>{
  const sel = ["drugA","drugB","drugC"].map(id=>document.getElementById(id).value).filter(Boolean);
  const box = document.getElementById("resultBox");
  if (sel.length<2){
    box.innerHTML = `<h3>Please select at least two substances.</h3>`;
    return;
  }
  const {pairs,worst} = renderPairs(sel);
  
  let content = `<h3>Interaction Analysis</h3>`;
  
  // Add detailed explanations for each pair
  pairs.forEach(pair => {
    content += `
      <div class="pair-detail ${getRiskClass(pair.v)}">
        <h4>${pair.a} + ${pair.b} ‚Üí ${pair.v}</h4>
        ${detailedExplanations[pair.v](pair.a, pair.b)}
      </div>
    `;
  });
  
  // Add trio advisory if applicable
  if (sel.length === 3) {
    content += tripleAdvisory(sel, worst);
  }
  
  content += `<p style="margin-top:1rem;color:var(--muted);font-size:0.9rem;">Remember: individual responses vary based on dosage, tolerance, metabolism, and underlying health conditions. This information is for harm reduction purposes only.</p>`;
  
  box.innerHTML = content;
  
  // Scroll to results
  box.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
});

// Render matrix table
(function renderMatrix(){
  const tbl = document.getElementById("matrix");
  const thead = document.createElement("thead");
  const hrow = document.createElement("tr");
  hrow.appendChild(document.createElement("th")).textContent = "‚Üì / ‚Üí";
  headers.forEach(h=>{ const th=document.createElement("th"); th.textContent=h; hrow.appendChild(th); });
  thead.appendChild(hrow);
  const tbody = document.createElement("tbody");
  headers.forEach(r=>{
    const tr = document.createElement("tr");
    const rowTh = document.createElement("th"); rowTh.textContent=r; tr.appendChild(rowTh);
    headers.forEach(c=>{
      const td = document.createElement("td");
      td.setAttribute("data-label", c);
      const val = mini.get(`${r}|${c}`) ?? mini.get(`${c}|${r}`) ?? "üåà";
      td.textContent = val;
      td.className = getRiskClass(val);
      tr.appendChild(td);
    });
    tbody.appendChild(tr);
  });
  tbl.appendChild(thead); tbl.appendChild(tbody);
})();

// CSV download (minimalist icons)
document.getElementById("dlCsv").addEventListener("click", ()=>{
  let csv = "Substance," + headers.join(",") + "\n";
  headers.forEach(r=>{
    let line = [r];
    headers.forEach(c=>{
      const val = mini.get(`${r}|${c}`) ?? mini.get(`${c}|${r}`) ?? "üåà";
      line.push(val);
    });
    csv += line.join(",") + "\n";
  });
  const blob = new Blob([csv],{type:"text/csv"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url; a.download = "plurderapolis-polydrug-matrix.csv";
  document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
});

// JSON download
document.getElementById("dlJson").addEventListener("click", ()=>{
  const data = {
    metadata: {
      title: "PLURderapolis Polydrug Interaction Matrix",
      version: "1.0",
      generated: new Date().toISOString(),
      source: "PLURderapolis Harm Reduction"
    },
    substances: headers,
    interactions: {}
  };
  
  headers.forEach(r => {
    data.interactions[r] = {};
    headers.forEach(c => {
      const val = mini.get(`${r}|${c}`) ?? mini.get(`${c}|${r}`) ?? "üåà";
      data.interactions[r][c] = val;
    });
  });
  
  const jsonStr = JSON.stringify(data, null, 2);
  const blob = new Blob([jsonStr], {type: "application/json"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url; a.download = "plurderapolis-polydrug-matrix.json";
  document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
});

// Share button (Web Share API)
document.getElementById("shareBtn").addEventListener("click", async ()=>{
  try{
    if (navigator.share){
      await navigator.share({title:"PLURderapolis Polydrug Matrix", text:"Check interactions + harm reduction tips", url:location.href});
    } else {
      alert("Copy this page URL to share:\n"+location.href);
    }
  }catch(e){ /* user cancelled */ }
});

// Back to top button functionality
const backToTopBtn = document.getElementById('backToTop');
window.addEventListener('scroll', () => {
  if (window.pageYOffset > 300) {
    backToTopBtn.style.display = 'block';
  } else {
    backToTopBtn.style.display = 'none';
  }
});

backToTopBtn.addEventListener('click', () => {
  window.scrollTo({ top: 0, behavior: 'smooth' });
});
</script>
</body>
</html>
